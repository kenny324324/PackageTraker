# PackageTraker å¾Œç«¯æ¨æ’­ç³»çµ±å¯¦æ–½è¨ˆåŠƒ

## èƒŒæ™¯èˆ‡ç›®æ¨™

### å•é¡Œé™³è¿°
ç›®å‰ PackageTraker åƒ…åœ¨ App é–‹å•Ÿæ™‚æ‰æœƒæ›´æ–°åŒ…è£¹ç‹€æ…‹ï¼Œç¼ºä¹å³æ™‚æ€§ã€‚ç”¨æˆ¶ç„¡æ³•åœ¨åŒ…è£¹åˆ°è²¨æ™‚ç«‹å³æ”¶åˆ°é€šçŸ¥ï¼Œéœ€è¦æ‰‹å‹•é€²å…¥ App åˆ·æ–°ã€‚

### è§£æ±ºæ–¹æ¡ˆ
å¯¦ä½œ **Server-side æ¨æ’­ç³»çµ±**ï¼šå¾Œç«¯æ¯ 15 åˆ†é˜è‡ªå‹•æª¢æŸ¥æ‰€æœ‰åŒ…è£¹ç‹€æ…‹ï¼Œç•¶åµæ¸¬åˆ°ç‹€æ…‹è®ŠåŒ–ï¼ˆç‰¹åˆ¥æ˜¯åˆ°è²¨æ™‚ï¼‰ç«‹å³ç™¼é€æ¨æ’­é€šçŸ¥åˆ°ç”¨æˆ¶è¨­å‚™ï¼Œå³ä½¿ App å·²é—œé–‰ä¹Ÿèƒ½æ”¶åˆ°ã€‚

### æŠ€è¡“é¸å‹
- **å¾Œç«¯**ï¼šFirebase (Firestore + Cloud Functions + Cloud Scheduler)
- **æ¨æ’­**ï¼šFCM (Firebase Cloud Messaging) + APNs
- **èº«ä»½è­˜åˆ¥**ï¼šApple Sign Inï¼ˆè·¨è¨­å‚™åŒæ­¥ï¼‰
- **API**ï¼šTrack.TW APIï¼ˆå…±ç”¨å–®ä¸€ Tokenï¼‰

---

## æ¶æ§‹è¨­è¨ˆ

### æ•´é«”æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  iOS App (PackageTraker)                 â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æœ¬åœ°è³‡æ–™å±¤ (SwiftData)                              â”‚ â”‚
â”‚  â”‚  - Package (æœ¬åœ°å¿«å–)                               â”‚ â”‚
â”‚  â”‚  - TrackingEvent                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â†•                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Firebase æ•´åˆå±¤                                     â”‚ â”‚
â”‚  â”‚  - FirebaseAuthService (Apple Sign In)             â”‚ â”‚
â”‚  â”‚  - FirebaseSyncService (é›™å‘åŒæ­¥)                  â”‚ â”‚
â”‚  â”‚  - FirebasePushService (FCM Token ç®¡ç†)            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†• (HTTPS/WebSocket)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Firebase Backend (GCP)                     â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Firestore Database                                  â”‚ â”‚
â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚  /users/{userId}                                     â”‚ â”‚
â”‚  â”‚    - appleId, email, fcmToken                        â”‚ â”‚
â”‚  â”‚    - notificationSettings                            â”‚ â”‚
â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚  /users/{userId}/packages/{packageId}                â”‚ â”‚
â”‚  â”‚    - trackingNumber, carrier, status                 â”‚ â”‚
â”‚  â”‚    - trackTwRelationId, customName                   â”‚ â”‚
â”‚  â”‚    - lastUpdated, isArchived                         â”‚ â”‚
â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚  /users/{userId}/packages/{packageId}/events/...     â”‚ â”‚
â”‚  â”‚    - timestamp, status, description, location        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Cloud Functions (Node.js/TypeScript)                â”‚ â”‚
â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚  â‘  packageTrackingScheduler (æ¯ 15 åˆ†é˜)            â”‚ â”‚
â”‚  â”‚     - æŸ¥è©¢æ‰€æœ‰æœªå®ŒæˆåŒ…è£¹                             â”‚ â”‚
â”‚  â”‚     - å‘¼å« Track.TW API                              â”‚ â”‚
â”‚  â”‚     - æ¯”å°ç‹€æ…‹è®ŠåŒ–                                   â”‚ â”‚
â”‚  â”‚     - æ›´æ–° Firestore                                 â”‚ â”‚
â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚  â‘¡ onPackageStatusChange (Firestore Trigger)        â”‚ â”‚
â”‚  â”‚     - åµæ¸¬ status æ¬„ä½è®ŠåŒ–                           â”‚ â”‚
â”‚  â”‚     - ç™¼é€ FCM æ¨æ’­                                  â”‚ â”‚
â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚  â‘¢ syncPackageFromClient (HTTPS Callable)           â”‚ â”‚
â”‚  â”‚     - è™•ç†å®¢æˆ¶ç«¯åŒ…è£¹åŒæ­¥è«‹æ±‚                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Cloud Scheduler                                      â”‚ â”‚
â”‚  â”‚  - Cron: "*/15 * * * *" (æ¯ 15 åˆ†é˜)                 â”‚ â”‚
â”‚  â”‚  - Pub/Sub Topic: package-tracking-cron             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
              Track.TW API (å…±ç”¨ Token)
```

---

## è³‡æ–™çµæ§‹è¨­è¨ˆ

### Firestore Collections

```typescript
// Collection: users
/users/{userId}  // userId = Apple User Identifier
{
  appleId: string                     // Apple Sign In User ID
  email: string?                      // ä½¿ç”¨è€… email (optional)
  fcmToken: string                    // FCM æ¨æ’­ Token
  createdAt: Timestamp
  lastActive: Timestamp
  notificationSettings: {
    enabled: boolean                  // ç¸½é–‹é—œ
    arrivalNotification: boolean      // åˆ°è²¨é€šçŸ¥
    pickupReminder: boolean           // å–è²¨æé†’
  }
}

// Subcollection: packages (æ¯ç”¨æˆ¶ç¨ç«‹)
/users/{userId}/packages/{packageId}  // packageId = UUID
{
  trackingNumber: string
  carrier: string                     // Carrier.rawValue (e.g., "sevenEleven")
  status: string                      // TrackingStatus.rawValue (e.g., "arrivedAtStore")

  // Track.TW æ•´åˆ
  trackTwRelationId: string           // Track.TW relation UUID

  // åŸºæœ¬è³‡è¨Š
  customName: string?
  pickupLocation: string?
  storeName: string?
  pickupCode: string?

  // æ™‚é–“æˆ³è¨˜
  lastUpdated: Timestamp
  createdAt: Timestamp

  // ç‹€æ…‹ç®¡ç†
  isArchived: boolean
  isDeleted: boolean?                 // è»Ÿåˆªé™¤æ¨™è¨˜ï¼ˆtrue = å·²å¾æœ¬åœ°åˆªé™¤ï¼‰
  deletedAt: Timestamp?               // è»Ÿåˆªé™¤æ™‚é–“
  lastNotifiedStatus: string?         // ä¸Šæ¬¡ç™¼é€æ¨æ’­çš„ç‹€æ…‹ (é¿å…é‡è¤‡)

  // è¨‚å–®è³‡è¨Š
  amount: number?
  paymentMethod: string?
  purchasePlatform: string?
  notes: string?
}

// Subcollection: events (è¿½è¹¤äº‹ä»¶)
/users/{userId}/packages/{packageId}/events/{eventId}
{
  timestamp: Timestamp
  status: string                      // TrackingStatus.rawValue
  description: string                 // äº‹ä»¶æè¿° (ä¸­æ–‡)
  location: string?                   // åœ°é»
}
```

### Security Rulesï¼ˆå·²éƒ¨ç½²ï¼‰

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
```

> **å‚™è¨»**ï¼šç›®å‰ä½¿ç”¨ç°¡åŒ–è¦å‰‡ï¼Œå·²ç™»å…¥ç”¨æˆ¶åªèƒ½è®€å¯«è‡ªå·± `/users/{uid}/...` ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ã€‚Phase 3 éƒ¨ç½² Cloud Functions å¾Œï¼Œå¯è€ƒæ…®æ”¶ç·Š events å­é›†åˆç‚ºå¾Œç«¯åªå¯«ã€‚

---

## åˆ†éšæ®µå¯¦æ–½è¨ˆåŠƒ

### Phase 1: Firebase åŸºç¤è¨­å®šèˆ‡ Apple Sign In (2-3 å¤©)

#### ç›®æ¨™
å»ºç«‹ Firebase å°ˆæ¡ˆã€æ•´åˆ Apple Sign Inã€å¯¦ç¾åŸºæœ¬çš„ç”¨æˆ¶èº«ä»½è­˜åˆ¥ã€‚

#### é—œéµæª”æ¡ˆ

**æ–°å¢æª”æ¡ˆï¼š**
- `PackageTraker/GoogleService-Info.plist` - Firebase é…ç½®æª”
- `PackageTraker/Services/Firebase/FirebaseAuthService.swift` - Apple Sign In ç®¡ç†
- `PackageTraker/Views/Auth/SignInView.swift` - ç™»å…¥ç•«é¢
- `PackageTraker/PackageTraker.entitlements` - Apple Sign In entitlement

**ä¿®æ”¹æª”æ¡ˆï¼š**
- `PackageTraker/PackageTrakerApp.swift` - åˆå§‹åŒ– Firebase
- `PackageTraker/Info.plist` - æ–°å¢æ¬Šé™èªªæ˜
- `Package.swift` (SPM) - æ–°å¢ Firebase SDK ä¾è³´

#### å¯¦ä½œæ­¥é©Ÿ

1. **Firebase Console è¨­å®š**
   ```bash
   # 1. å‰å¾€ Firebase Console: https://console.firebase.google.com/
   # 2. å»ºç«‹æ–°å°ˆæ¡ˆ "PackageTraker" æˆ–ä½¿ç”¨ç¾æœ‰å°ˆæ¡ˆ
   # 3. æ–°å¢ iOS App
   #    - Bundle ID: com.yourname.PackageTraker
   # 4. ä¸‹è¼‰ GoogleService-Info.plist
   # 5. å•Ÿç”¨ä»¥ä¸‹æœå‹™ï¼š
   #    - Authentication (Apple Sign In)
   #    - Firestore Database
   #    - Cloud Functions
   #    - Cloud Messaging
   ```

2. **Apple Developer Console è¨­å®š**
   ```bash
   # 1. å‰å¾€ https://developer.apple.com/account/
   # 2. Identifiers > App IDs > ä½ çš„ App
   # 3. å•Ÿç”¨ "Sign in with Apple" capability
   # 4. è¨­å®š Service ID (ç”¨æ–¼ Firebase)
   # 5. ä¸‹è¼‰æ›´æ–°çš„ Provisioning Profile
   ```

3. **å®‰è£ Firebase SDK (SPM)**
   ```swift
   // Package.swift dependencies:
   .package(url: "https://github.com/firebase/firebase-ios-sdk", from: "10.0.0")

   // Targets dependencies:
   .product(name: "FirebaseAuth", package: "firebase-ios-sdk"),
   .product(name: "FirebaseFirestore", package: "firebase-ios-sdk"),
   .product(name: "FirebaseMessaging", package: "firebase-ios-sdk")
   ```

4. **å»ºç«‹ FirebaseAuthService.swift**
   ```swift
   import FirebaseAuth
   import FirebaseCore
   import AuthenticationServices
   import CryptoKit

   @MainActor
   final class FirebaseAuthService: NSObject, ObservableObject {
       static let shared = FirebaseAuthService()

       @Published var currentUser: User?
       @Published var isAuthenticated = false
       @Published var isLoading = false

       private var currentNonce: String?

       private override init() {
           super.init()

           // ç›£è½èªè­‰ç‹€æ…‹
           Auth.auth().addStateDidChangeListener { [weak self] _, user in
               Task { @MainActor in
                   self?.currentUser = user
                   self?.isAuthenticated = user != nil
               }
           }
       }

       // MARK: - Apple Sign In

       func signInWithApple(credential: ASAuthorizationAppleIDCredential) async throws {
           guard let nonce = currentNonce,
                 let appleIDToken = credential.identityToken,
                 let idTokenString = String(data: appleIDToken, encoding: .utf8) else {
               throw AuthError.invalidCredential
           }

           let firebaseCredential = OAuthProvider.credential(
               withProviderID: "apple.com",
               idToken: idTokenString,
               rawNonce: nonce
           )

           isLoading = true
           defer { isLoading = false }

           let result = try await Auth.auth().signIn(with: firebaseCredential)
           currentUser = result.user

           // åˆæ¬¡ç™»å…¥æ™‚å»ºç«‹ç”¨æˆ¶è³‡æ–™
           await createUserProfileIfNeeded(user: result.user, credential: credential)
       }

       func startSignInWithAppleFlow() -> ASAuthorizationAppleIDRequest {
           let nonce = randomNonceString()
           currentNonce = nonce

           let request = ASAuthorizationAppleIDProvider().createRequest()
           request.requestedScopes = [.email, .fullName]
           request.nonce = sha256(nonce)

           return request
       }

       func signOut() throws {
           try Auth.auth().signOut()
           currentUser = nil
       }

       // MARK: - Helpers

       private func createUserProfileIfNeeded(user: User, credential: ASAuthorizationAppleIDCredential) async {
           let db = Firestore.firestore()
           let userRef = db.collection("users").document(user.uid)

           let userDoc = try? await userRef.getDocument()
           if userDoc?.exists == true { return }

           // å»ºç«‹ç”¨æˆ¶è³‡æ–™
           let userData: [String: Any] = [
               "appleId": credential.user,
               "email": credential.email ?? "",
               "createdAt": FieldValue.serverTimestamp(),
               "lastActive": FieldValue.serverTimestamp(),
               "notificationSettings": [
                   "enabled": true,
                   "arrivalNotification": true,
                   "pickupReminder": true
               ]
           ]

           try? await userRef.setData(userData)
       }

       private func randomNonceString(length: Int = 32) -> String {
           precondition(length > 0)
           var randomBytes = [UInt8](repeating: 0, count: length)
           let errorCode = SecRandomCopyBytes(kSecRandomDefault, randomBytes.count, &randomBytes)
           if errorCode != errSecSuccess {
               fatalError("Unable to generate nonce. SecRandomCopyBytes failed with OSStatus \(errorCode)")
           }

           let charset: [Character] =
               Array("0123456789ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvwxyz-._")

           let nonce = randomBytes.map { byte in
               charset[Int(byte) % charset.count]
           }

           return String(nonce)
       }

       private func sha256(_ input: String) -> String {
           let inputData = Data(input.utf8)
           let hashedData = SHA256.hash(data: inputData)
           let hashString = hashedData.compactMap {
               String(format: "%02x", $0)
           }.joined()

           return hashString
       }
   }

   enum AuthError: LocalizedError {
       case invalidCredential

       var errorDescription: String? {
           switch self {
           case .invalidCredential:
               return String(localized: "auth.error.invalidCredential")
           }
       }
   }
   ```

5. **å»ºç«‹ SignInView.swift**
   ```swift
   import SwiftUI
   import AuthenticationServices

   struct SignInView: View {
       @EnvironmentObject private var authService: FirebaseAuthService
       @State private var showError = false
       @State private var errorMessage = ""

       var body: some View {
           VStack(spacing: 32) {
               // Logo
               Image("AppLogo")
                   .resizable()
                   .scaledToFit()
                   .frame(width: 120, height: 120)

               // æ¨™é¡Œ
               VStack(spacing: 12) {
                   Text(AppConfiguration.appName)
                       .font(.largeTitle)
                       .fontWeight(.bold)

                   Text("auth.signIn.subtitle")
                       .font(.body)
                       .foregroundStyle(.secondary)
                       .multilineTextAlignment(.center)
               }

               Spacer()

               // Apple Sign In æŒ‰éˆ•
               SignInWithAppleButton(
                   .signIn,
                   onRequest: { request in
                       request = authService.startSignInWithAppleFlow()
                   },
                   onCompletion: { result in
                       handleSignInResult(result)
                   }
               )
               .signInWithAppleButtonStyle(.white)
               .frame(height: 50)
               .cornerRadius(8)

               // éš±ç§èªªæ˜
               Text("auth.signIn.privacyNote")
                   .font(.caption)
                   .foregroundStyle(.secondary)
                   .multilineTextAlignment(.center)
           }
           .padding(24)
           .alert("auth.error.title", isPresented: $showError) {
               Button("common.ok", role: .cancel) {}
           } message: {
               Text(errorMessage)
           }
       }

       private func handleSignInResult(_ result: Result<ASAuthorization, Error>) {
           switch result {
           case .success(let authorization):
               guard let credential = authorization.credential as? ASAuthorizationAppleIDCredential else {
                   return
               }

               Task {
                   do {
                       try await authService.signInWithApple(credential: credential)
                   } catch {
                       errorMessage = error.localizedDescription
                       showError = true
                   }
               }

           case .failure(let error):
               if (error as NSError).code != ASAuthorizationError.canceled.rawValue {
                   errorMessage = error.localizedDescription
                   showError = true
               }
           }
       }
   }
   ```

6. **ä¿®æ”¹ PackageTrakerApp.swift**
   ```swift
   import SwiftUI
   import SwiftData
   import FirebaseCore

   @main
   struct PackageTrakerApp: App {
       @UIApplicationDelegateAdaptor(AppDelegate.self) var appDelegate
       @StateObject private var authService = FirebaseAuthService.shared
       @State private var refreshService = PackageRefreshService()
       @State private var showSplash = true

       init() {
           // åˆå§‹åŒ– Firebase
           FirebaseApp.configure()

           // è¨­ç½®é€šçŸ¥ä»£ç†
           UNUserNotificationCenter.current().delegate = NotificationDelegate.shared
       }

       var body: some Scene {
           WindowGroup {
               Group {
                   if authService.isAuthenticated {
                       // å·²ç™»å…¥ï¼šé¡¯ç¤ºä¸»ç•«é¢
                       ZStack {
                           MainTabView()
                               .environment(refreshService)

                           if showSplash {
                               SplashView(refreshService: refreshService) {
                                   showSplash = false
                               }
                           }
                       }
                   } else {
                       // æœªç™»å…¥ï¼šé¡¯ç¤ºç™»å…¥ç•«é¢
                       SignInView()
                   }
               }
               .preferredColorScheme(.dark)
               .environmentObject(authService)
           }
           .modelContainer(for: [Package.self, TrackingEvent.self, LinkedEmailAccount.self])
       }
   }

   // AppDelegate for FCM
   class AppDelegate: NSObject, UIApplicationDelegate {
       func application(
           _ application: UIApplication,
           didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?
       ) -> Bool {
           return true
       }
   }
   ```

7. **æ–°å¢æœ¬åœ°åŒ–å­—ä¸²**
   ```strings
   // en.lproj/Localizable.strings
   "auth.signIn.subtitle" = "Sign in to sync your packages across devices and receive push notifications";
   "auth.signIn.privacyNote" = "We respect your privacy. Your data is securely stored and only used for package tracking.";
   "auth.error.title" = "Sign In Failed";
   "auth.error.invalidCredential" = "Invalid Apple Sign In credential";

   // zh-Hant.lproj/Localizable.strings
   "auth.signIn.subtitle" = "ç™»å…¥ä»¥è·¨è¨­å‚™åŒæ­¥åŒ…è£¹ä¸¦æ¥æ”¶æ¨æ’­é€šçŸ¥";
   "auth.signIn.privacyNote" = "æˆ‘å€‘å°Šé‡æ‚¨çš„éš±ç§ã€‚æ‚¨çš„è³‡æ–™å®‰å…¨å„²å­˜ï¼Œåƒ…ç”¨æ–¼åŒ…è£¹è¿½è¹¤ã€‚";
   "auth.error.title" = "ç™»å…¥å¤±æ•—";
   "auth.error.invalidCredential" = "ç„¡æ•ˆçš„ Apple ç™»å…¥æ†‘è­‰";

   // zh-Hans.lproj/Localizable.strings
   "auth.signIn.subtitle" = "ç™»å½•ä»¥è·¨è®¾å¤‡åŒæ­¥åŒ…è£¹å¹¶æ¥æ”¶æ¨æ’­é€šçŸ¥";
   "auth.signIn.privacyNote" = "æˆ‘ä»¬å°Šé‡æ‚¨çš„éšç§ã€‚æ‚¨çš„èµ„æ–™å®‰å…¨å‚¨å­˜ï¼Œä»…ç”¨äºåŒ…è£¹è¿½è¸ªã€‚";
   "auth.error.title" = "ç™»å½•å¤±è´¥";
   "auth.error.invalidCredential" = "æ— æ•ˆçš„ Apple ç™»å½•å‡­è¯";
   ```

#### é©—è­‰æ–¹æ³•
```bash
# 1. åŸ·è¡Œ App
# 2. é»æ“Š "Sign in with Apple" æŒ‰éˆ•
# 3. å®Œæˆ Apple ç™»å…¥æµç¨‹
# 4. æª¢æŸ¥ Firebase Console > Authentication > Users æ˜¯å¦æœ‰æ–°ç”¨æˆ¶
# 5. æª¢æŸ¥ Firestore > users/{userId} æ˜¯å¦å»ºç«‹æ–‡ä»¶
```

---

### Phase 2: Firestore è³‡æ–™åŒæ­¥èˆ‡ FCM æ¨æ’­ âœ… å·²å®Œæˆ (2026-02-09)

#### ç›®æ¨™
å»ºç«‹ iOS ç«¯åˆ° Firestore çš„å–®å‘ä¸Šå‚³åŒæ­¥ï¼Œä¸¦å¯¦ç¾ FCM Token è¨»å†Šã€‚

#### å¯¦éš›è¨­è¨ˆæ±ºç­–ï¼ˆèˆ‡åŸå§‹è¨ˆåŠƒçš„å·®ç•°ï¼‰

1. **å–®å‘ä¸Šå‚³åŒæ­¥ï¼ˆéé›™å‘ï¼‰**ï¼šSwiftData ç‚º Single Source of Truthï¼ŒFirestore åƒ…ä½œç‚ºé›²ç«¯é¡åƒï¼Œä¸ä½¿ç”¨ Snapshot Listener ä¸‹è¼‰è®Šæ›´ã€‚é›™å‘åŒæ­¥ç•™å¾…æœªä¾†éœ€è¦æ™‚å†å¯¦ä½œã€‚
2. **Fire-and-forget æ¨¡å¼**ï¼šåŒæ­¥æ“ä½œä¸é˜»å¡ UIï¼Œå¤±æ•—åªæ‰“å°æ—¥èªŒä¸å½±éŸ¿ç”¨æˆ¶é«”é©—ã€‚
3. **è»Ÿåˆªé™¤**ï¼šåˆªé™¤åŒ…è£¹æ™‚åœ¨ Firestore æ¨™è¨˜ `isDeleted: true` + `deletedAt` æ™‚é–“æˆ³ï¼Œä¸çœŸæ­£åˆªé™¤æ–‡ä»¶ï¼Œä¿ç•™æ­·å²è³‡æ–™ã€‚
4. **éé˜»å¡å•Ÿå‹•**ï¼šåˆå§‹åŒæ­¥å’Œ FCM è¨»å†Šä½¿ç”¨ `Task { }` èƒŒæ™¯åŸ·è¡Œï¼Œä¸é˜»å¡ Splash ç•«é¢ã€‚
5. **ä¸å»ºç«‹ FirebaseModels.swift**ï¼šç›´æ¥åœ¨ FirebaseSyncService å…§è½‰æ›ï¼Œæ¸›å°‘ä¸å¿…è¦çš„æª”æ¡ˆã€‚

#### é—œéµæª”æ¡ˆ

**æ–°å¢æª”æ¡ˆï¼š**
- `PackageTraker/Services/Firebase/FirebaseSyncService.swift` - Firestore å–®å‘ä¸Šå‚³åŒæ­¥ï¼ˆfire-and-forgetï¼‰
- `PackageTraker/Services/Firebase/FirebasePushService.swift` - FCM Token ç®¡ç† + MessagingDelegate

**ä¿®æ”¹æª”æ¡ˆï¼š**
- `PackageTraker/PackageTrakerApp.swift` - AppDelegateï¼ˆAPNs token è½‰ç™¼ï¼‰ã€FCM åˆå§‹åŒ–ã€ç™»å…¥æ™‚ FCM è¨»å†Š
- `PackageTraker/Views/SplashView.swift` - å†·å•Ÿå‹•æ™‚éé˜»å¡åˆå§‹åŒæ­¥ + FCM è¨»å†Š
- `PackageTraker/Views/Auth/SignInView.swift` - ç™»å…¥å¾Œéé˜»å¡åˆå§‹åŒæ­¥
- `PackageTraker/Services/PackageRefreshService.swift` - åˆ·æ–°å¾ŒåŒæ­¥åˆ° Firestore
- `PackageTraker/Views/AddPackage/PackageInfoView.swift` - æ–°å¢/æ›´æ–°åŒ…è£¹æ™‚åŒæ­¥
- `PackageTraker/Views/PackageDetail/EditPackageSheet.swift` - ç·¨è¼¯åŒ…è£¹æ™‚åŒæ­¥
- `PackageTraker/Views/PackageDetail/PackageDetailView.swift` - åˆªé™¤åŒ…è£¹æ™‚è»Ÿåˆªé™¤
- `PackageTraker/Views/PackageList/PackageListView.swift` - åˆ—è¡¨åˆªé™¤æ™‚è»Ÿåˆªé™¤
- `PackageTraker/Views/Settings/SettingsView.swift` - ç™»å‡ºæ™‚æ¸…é™¤ FCM Tokenã€æ¸…é™¤è³‡æ–™æ™‚åŒæ­¥åˆªé™¤

#### å¯¦éš›å¯¦ä½œæ‘˜è¦

**FirebaseSyncService.swift æ ¸å¿ƒ APIï¼š**
- `syncPackage(_ package: Package)` â€” å–®ä¸€åŒ…è£¹ fire-and-forget åŒæ­¥ï¼ˆWriteBatchï¼špackage + eventsï¼‰
- `deletePackage(_ packageId: UUID)` â€” è»Ÿåˆªé™¤ï¼šè¨­å®š `isDeleted: true` + `deletedAt` æ™‚é–“æˆ³
- `syncAllPackages(_ packages: [Package])` â€” æ‰¹æ¬¡åŒæ­¥ï¼ˆé¦–æ¬¡ç™»å…¥ç”¨ï¼‰

**FirebasePushService.swift æ ¸å¿ƒ APIï¼š**
- `registerForPushNotifications()` â€” è«‹æ±‚é€šçŸ¥æ¬Šé™ + è¨»å†Š APNs
- `uploadToken()` â€” ä¸Šå‚³ FCM Token åˆ° `/users/{uid}/fcmToken`
- `clearToken()` â€” ç™»å‡ºæ™‚æ¸…é™¤ Firestore ä¸­çš„ FCM Token
- `MessagingDelegate` â€” Token è®ŠåŒ–æ™‚è‡ªå‹•ä¸Šå‚³

**åŒæ­¥è§¸ç™¼é»ï¼š**

| æ“ä½œ | åŒæ­¥æ–¹æ³• | è§¸ç™¼ä½ç½® |
|------|----------|----------|
| æ–°å¢åŒ…è£¹ | `syncPackage()` | `PackageInfoView.addPackage()` |
| ç·¨è¼¯åŒ…è£¹ | `syncPackage()` | `EditPackageSheet.saveChanges()` |
| åˆ·æ–°åŒ…è£¹ | `syncPackage()` | `PackageRefreshService.refreshPackage()` |
| åˆªé™¤åŒ…è£¹ | `deletePackage()` (è»Ÿåˆªé™¤) | `PackageDetailView` / `PackageListView` |
| é¦–æ¬¡ç™»å…¥ | `syncAllPackages()` | `SplashView` / `SignInView` (éé˜»å¡ Task) |
| ç™»å‡º | `clearToken()` | `SettingsView.signOut()` |
| æ¸…é™¤è³‡æ–™ | `deletePackage()` Ã— N | `SettingsView.clearAllData()` |

**AppDelegate æ–°å¢ï¼š**
- `@UIApplicationDelegateAdaptor(AppDelegate.self)` åœ¨ `PackageTrakerApp`
- `AppDelegate.didRegisterForRemoteNotificationsWithDeviceToken` â†’ è½‰ç™¼ APNs token åˆ° FCM

**Firestore å¯¦éš›è³‡æ–™çµæ§‹ï¼š**
```
/users/{uid}
  â”œâ”€â”€ appleId, email, createdAt, lastActive
  â”œâ”€â”€ fcmToken (FCM æ¨æ’­ Token)
  â”œâ”€â”€ notificationSettings { enabled, arrivalNotification, pickupReminder }
  â””â”€â”€ /packages/{packageId}
        â”œâ”€â”€ trackingNumber, carrier, status, isArchived
        â”œâ”€â”€ isDeleted?, deletedAt? (è»Ÿåˆªé™¤æ¬„ä½)
        â”œâ”€â”€ customName?, pickupCode?, pickupLocation?, storeName?, ...
        â”œâ”€â”€ lastUpdated, createdAt
        â””â”€â”€ /events/{eventId}
              â”œâ”€â”€ timestamp, status, description, location?
```

**å·²çŸ¥å•é¡Œèˆ‡è§£æ±ºï¼š**
1. éœ€è¦ `import Combine` â€” `@Published` å±¬æ€§éœ€è¦ Combine æ¡†æ¶
2. éœ€è¦ `import FirebaseAuth` â€” Xcode å•Ÿç”¨äº† `MemberImportVisibility`ï¼Œéœ€æ˜ç¢ºå°å…¥æ‰èƒ½å­˜å– `Auth.auth().currentUser?.uid`
3. åˆå§‹åŒæ­¥é˜»å¡å•Ÿå‹•ç•«é¢ â€” æ”¹ç‚ºéé˜»å¡ `Task { }` åŸ·è¡Œ

> **åŸå§‹è¨ˆåŠƒä¸­çš„ä»£ç¢¼ç¯„ä¾‹å·²ç§»é™¤ï¼Œè«‹ç›´æ¥åƒè€ƒå¯¦éš›æª”æ¡ˆã€‚**

#### é©—è­‰çµæœ
- âœ… æ–°å¢åŒ…è£¹å¾Œ Firestore è‡ªå‹•åŒæ­¥
- âœ… ç·¨è¼¯åŒ…è£¹å¾Œ Firestore è‡ªå‹•æ›´æ–°
- âœ… åˆªé™¤åŒ…è£¹å¾Œ Firestore æ¨™è¨˜ `isDeleted: true`ï¼ˆè»Ÿåˆªé™¤ï¼‰
- âœ… FCM Token æˆåŠŸä¸Šå‚³åˆ° Firestore
- âœ… é¦–æ¬¡ç™»å…¥æœ¬åœ°è³‡æ–™è‡ªå‹•æ‰¹æ¬¡åŒæ­¥
- âœ… ç™»å‡ºæ™‚æ¸…é™¤ FCM Token
- âœ… App å•Ÿå‹•ä¸è¢«åŒæ­¥é˜»å¡ï¼ˆéé˜»å¡ Taskï¼‰

> âš ï¸ **æ³¨æ„**ï¼šFirestore è³‡æ–™åº«éœ€å…ˆåœ¨ Firebase Console å»ºç«‹ï¼ˆStandard ç‰ˆï¼Œasia-east1 åœ°å€ï¼‰ï¼Œå®‰å…¨è¦å‰‡éœ€è¨­å®šç‚ºå…è¨±å·²èªè­‰ç”¨æˆ¶è®€å¯«è‡ªå·±çš„è³‡æ–™ã€‚

---

### Phase 3: Cloud Functions å¾Œç«¯å¯¦ä½œ âœ… å·²å®Œæˆ (2026-02-09)

#### ç›®æ¨™
å»ºç«‹å¾Œç«¯å®šæ™‚è¼ªè©¢ã€ç‹€æ…‹è®ŠåŒ–åµæ¸¬ã€æ¨æ’­ç™¼é€é‚è¼¯ã€‚

#### å¯¦éš›è¨­è¨ˆæ±ºç­–ï¼ˆèˆ‡åŸå§‹è¨ˆåŠƒçš„å·®ç•°ï¼‰

1. **ä½¿ç”¨ Cloud Functions v2 API**ï¼ˆé v1ï¼‰ï¼šä½¿ç”¨ `onSchedule`ï¼ˆfrom `firebase-functions/v2/scheduler`ï¼‰å’Œ `onDocumentUpdated`ï¼ˆfrom `firebase-functions/v2/firestore`ï¼‰ï¼Œæ”¯æ´æ›´å¥½çš„æ“´å±•æ€§å’Œ Secret Managerã€‚
2. **Secret Manager å­˜å„² Token**ï¼šTrack.TW API Token ä½¿ç”¨ `defineSecret("TRACKW_TOKEN")` æ­é… Firebase Secret Managerï¼Œè€Œé v1 çš„ `functions.config()`ã€‚
3. **åˆä½µæ¨æ’­é‚è¼¯**ï¼šä¸ä½¿ç”¨ç¨ç«‹çš„ Firestore trigger + scheduler äº’ç›¸è§¸ç™¼ï¼Œè€Œæ˜¯ scheduler æ›´æ–°ç‹€æ…‹å¾Œç”± `onDocumentUpdated` trigger è‡ªå‹•åµæ¸¬ä¸¦æ¨æ’­ã€‚
4. **Rate limit ä¿è­·**ï¼šé‡åˆ° 429 (rate limited) æˆ– 401 (unauthorized) æ™‚ç«‹å³çµ‚æ­¢æœ¬æ¬¡è¼ªè©¢ï¼Œé¿å…æµªè²»é…é¡ã€‚
5. **Token éœ€ trim()**ï¼šSecret Manager å­˜å„²çš„å€¼å¯èƒ½åŒ…å«æ›è¡Œç¬¦è™Ÿï¼Œè®€å–å¾Œéœ€è¦ `.trim()` è™•ç†ã€‚

#### é—œéµæª”æ¡ˆ

**æ–°å¢æª”æ¡ˆï¼ˆå¾Œç«¯ï¼‰ï¼š**
- `firebase.json` - Firebase å°ˆæ¡ˆé…ç½®
- `.firebaserc` - å°ˆæ¡ˆé€£çµï¼ˆpackagetraker-e80b0ï¼‰
- `functions/package.json` - Node.js ä¾è³´ï¼ˆaxios, firebase-admin, firebase-functionsï¼‰
- `functions/tsconfig.json` - TypeScript é…ç½®
- `functions/src/index.ts` - å…¥å£ï¼šinitializeApp + åŒ¯å‡º 2 å€‹ functions
- `functions/src/scheduler.ts` - æ¯ 15 åˆ†é˜å®šæ™‚è¼ªè©¢ï¼ˆ`onSchedule`ï¼Œasia-east1ï¼Œ512MiBï¼Œ540s timeoutï¼‰
- `functions/src/triggers.ts` - Firestore ç‹€æ…‹è®ŠåŒ– â†’ FCM æ¨æ’­ï¼ˆ`onDocumentUpdated`ï¼‰
- `functions/src/services/trackTwApi.ts` - Track.TW API HTTP clientï¼ˆaxiosï¼‰
- `functions/src/services/pushNotification.ts` - FCM æ¨æ’­å°è£ï¼ˆfirebase-admin messagingï¼‰
- `functions/src/utils/statusMapper.ts` - ç‹€æ…‹æ˜ å°„ï¼ˆå®Œå…¨é¡åƒ iOS ç«¯ `TrackingStatus.fromTrackTw()`ï¼‰
- `functions/.env.local` - æœ¬åœ°ç’°å¢ƒè®Šæ•¸

**ä¿®æ”¹æª”æ¡ˆï¼ˆiOS ç«¯ bug ä¿®å¾©ï¼‰ï¼š**
- `PackageTraker/Services/Firebase/FirebaseAuthService.swift` - ä¿®å¾© `notificationSettings` ç¼ºå¤± bugï¼šç•¶ç”¨æˆ¶æ–‡ä»¶å·²å­˜åœ¨ä½†ç¼ºå°‘ `notificationSettings` æ™‚è‡ªå‹•è£œä¸Š

#### æ ¸å¿ƒæ¶æ§‹

```
Cloud Scheduler (*/15 * * * *)
    â†“
packageTrackingScheduler (onSchedule)
    â†“
éæ­· /users â†’ /packagesï¼ˆæ’é™¤ isArchivedã€isDeletedã€å·²å®Œæˆï¼‰
    â†“
å‘¼å« Track.TW API GET /package/tracking/{relationId}
    â†“
statusMapper.fromTrackTw() æ˜ å°„ç‹€æ…‹
    â†“
ç‹€æ…‹æœ‰è®ŠåŒ– â†’ æ›´æ–° Firestore status + lastUpdated
    â†“
onPackageStatusChange (onDocumentUpdated) è‡ªå‹•è§¸ç™¼
    â†“
status === "arrivedAtStore" && notificationSettings.enabled
    â†“
admin.messaging().send(fcmToken, payload) â†’ APNs â†’ iPhone
```

#### ç‹€æ…‹æ˜ å°„é‚è¼¯ï¼ˆèˆ‡ iOS ç«¯ TrackingStatus.fromTrackTw() å®Œå…¨ä¸€è‡´ï¼‰

```
checkpointStatus: "delivered"  â†’ "delivered"
checkpointStatus: "exception"  â†’ "returned"
checkpointStatus: "pending"    â†’ "pending"
checkpointStatus: "transit"    â†’ æ ¹æ“šä¸­æ–‡æè¿°ï¼š
    å«ã€Œå°‡æ–¼/ç­‰å¾…å‡ºè²¨/ç­‰å¾…å¯„ä»¶/æº–å‚™å‡ºè²¨/è¨‚å–®æˆç«‹/è¨‚å–®è™•ç†ã€â†’ "pending"
    å«ã€Œåˆ°åº—/åˆ°é–€å¸‚/å¾…å–/å¯å–è²¨/é…é”/å·²åˆ°é”/å·²é€é”ã€â†’ "arrivedAtStore"
    å«ã€Œé…é€ä¸­/é‹é€ä¸­/è½‰é‹/ç†è²¨/æŠµé”/æ´¾é€/æŠ•éã€â†’ "inTransit"
    å«ã€Œå¯„ä»¶/å‡ºè²¨/å·²æ”¶ä»¶/å·²æ”¬æ”¶ã€â†’ "shipped"
    å…¶ä»– â†’ "inTransit"
```

#### éƒ¨ç½²è³‡è¨Š

- **Firebase Project**: packagetraker-e80b0
- **Region**: asia-east1
- **Runtime**: Node.js 20
- **Functions**:
  - `packageTrackingScheduler` - Scheduled (*/15 * * * *), 512MiB, 540s timeout
  - `onPackageStatusChange` - Firestore document.v1.updated trigger

#### å·²çŸ¥å•é¡Œèˆ‡è§£æ±º

1. **Secret Manager Token å«æ›è¡Œç¬¦** â€” `trackwToken.value().trim()` ä¿®å¾©
2. **Node.js 18 å·²åœæ­¢æ”¯æ´** â€” æ”¹ç”¨ Node.js 20
3. **é¦–æ¬¡éƒ¨ç½² Eventarc æ¬Šé™æœªå°±ç·’** â€” ç­‰å¾…æ•¸åˆ†é˜å¾Œé‡æ–°éƒ¨ç½²å³å¯
4. **`notificationSettings` ç¼ºå¤±å°è‡´æ¨æ’­è¢«è·³é** â€” ä¿®å¾© `createUserProfileIfNeeded()` è‡ªå‹•è£œé½Šç¼ºå°‘æ¬„ä½

> **åŸå§‹è¨ˆåŠƒä¸­çš„ä»£ç¢¼ç¯„ä¾‹å·²ç§»é™¤ï¼Œè«‹ç›´æ¥åƒè€ƒå¯¦éš›æª”æ¡ˆã€‚**

#### é©—è­‰çµæœ
- âœ… Cloud Functions éƒ¨ç½²æˆåŠŸï¼ˆ2 å€‹å‡½æ•¸ï¼‰
- âœ… Scheduler æ¯ 15 åˆ†é˜è‡ªå‹•åŸ·è¡Œ
- âœ… Track.TW API å‘¼å«æ­£å¸¸ï¼ˆtoken trim ä¿®æ­£å¾Œï¼‰
- âœ… ç‹€æ…‹è®ŠåŒ–æ™‚è‡ªå‹•æ›´æ–° Firestore
- âœ… æ‰‹å‹•ä¿®æ”¹ç‹€æ…‹ç‚º "arrivedAtStore" æˆåŠŸæ”¶åˆ°æ¨æ’­
- âœ… Scheduler è‡ªå‹•ä¿®æ­£æ‰‹å‹•æ¸¬è©¦å¾Œçš„ç‹€æ…‹ï¼ˆarrivedAtStore â†’ pendingï¼‰

4. **å»ºç«‹ src/services/trackTwApi.ts**
   ```typescript
   import axios, { AxiosInstance } from 'axios';

   const BASE_URL = 'https://track.tw/api/v1';

   export interface TrackTwCheckpoint {
     packageId: string;
     time: number;  // Unix timestamp
     status: string;  // ä¸­æ–‡æè¿°
     checkpointStatus: 'pending' | 'transit' | 'delivered' | 'exception';
     createdAt: string;
   }

   export interface TrackTwTrackingResponse {
     id: string;
     trackingNumber: string;
     carrierId: string;
     packageHistory: TrackTwCheckpoint[];
     storeName?: string;
   }

   export class TrackTwAPI {
     private client: AxiosInstance;

     constructor(token: string) {
       this.client = axios.create({
         baseURL: BASE_URL,
         headers: {
           'Authorization': `Bearer ${token}`,
           'Content-Type': 'application/json',
         },
         timeout: 10000,
       });
     }

     async getTracking(relationId: string): Promise<TrackTwTrackingResponse> {
       try {
         const response = await this.client.get(`/package/tracking/${relationId}`);
         return response.data;
       } catch (error: any) {
         if (error.response?.status === 404) {
           throw new Error(`Package not found: ${relationId}`);
         }
         throw error;
       }
     }

     async importPackage(carrierId: string, trackingNumbers: string[]): Promise<Record<string, string>> {
       const response = await this.client.post('/package/import', {
         carrier: carrierId,
         tracking_numbers: trackingNumbers,
         notify_state: 'on',
       });
       return response.data;
     }
   }
   ```

5. **å»ºç«‹ src/utils/statusMapper.ts**
   ```typescript
   // æ˜ å°„ Track.TW ç‹€æ…‹åˆ° App ç‹€æ…‹
   export function mapTrackTwStatus(
     checkpointStatus: string,
     description: string
   ): string {
     switch (checkpointStatus) {
       case 'delivered':
         return 'delivered';

       case 'exception':
         if (description.includes('é€€å›') || description.includes('é€€è²¨')) {
           return 'returned';
         }
         return 'returned';

       case 'pending':
         return 'pending';

       case 'transit':
         // åˆ°è²¨åˆ¤æ–·
         if (
           description.includes('åˆ°åº—') ||
           description.includes('åˆ°é–€å¸‚') ||
           description.includes('å¾…å–') ||
           description.includes('å¯å–è²¨') ||
           description.includes('é…é”å®Œæˆ')
         ) {
           return 'arrivedAtStore';
         }

         // é…é€ä¸­åˆ¤æ–·
         if (
           description.includes('é…é€ä¸­') ||
           description.includes('é‹é€ä¸­') ||
           description.includes('è½‰é‹')
         ) {
           return 'inTransit';
         }

         // å·²å‡ºè²¨åˆ¤æ–·
         if (
           description.includes('å¯„ä»¶') ||
           description.includes('å‡ºè²¨') ||
           description.includes('å·²æ”¶ä»¶')
         ) {
           return 'shipped';
         }

         return 'inTransit';

       default:
         return 'pending';
     }
   }
   ```

6. **å»ºç«‹ src/services/pushNotification.ts**
   ```typescript
   import * as admin from 'firebase-admin';

   export interface PushPayload {
     title: string;
     body: string;
     data?: Record<string, string>;
   }

   export async function sendPushNotification(
     fcmToken: string,
     payload: PushPayload
   ): Promise<void> {
     const message: admin.messaging.Message = {
       token: fcmToken,
       notification: {
         title: payload.title,
         body: payload.body,
       },
       data: payload.data || {},
       apns: {
         headers: {
           'apns-priority': '10',
         },
         payload: {
           aps: {
             sound: 'default',
             badge: 1,
             'content-available': 1,  // å…è¨±èƒŒæ™¯æ›´æ–°
           },
         },
       },
     };

     try {
       const response = await admin.messaging().send(message);
       console.log(`âœ… Push notification sent: ${response}`);
     } catch (error) {
       console.error('âŒ Failed to send push notification:', error);
       throw error;
     }
   }
   ```

7. **å»ºç«‹ src/scheduler.tsï¼ˆæ ¸å¿ƒè¼ªè©¢é‚è¼¯ï¼‰**
   ```typescript
   import * as functions from 'firebase-functions';
   import * as admin from 'firebase-admin';
   import { TrackTwAPI } from './services/trackTwApi';
   import { mapTrackTwStatus } from './utils/statusMapper';

   const db = admin.firestore();

   // æ¯ 15 åˆ†é˜åŸ·è¡Œä¸€æ¬¡
   export const packageTrackingScheduler = functions
     .runWith({
       timeoutSeconds: 540,  // 9 åˆ†é˜ timeout
       memory: '512MB',
     })
     .pubsub
     .schedule('*/15 * * * *')  // Cron: æ¯ 15 åˆ†é˜
     .timeZone('Asia/Taipei')
     .onRun(async (context) => {
       console.log('ğŸ”„ [Scheduler] Starting package tracking poll...');

       const trackwToken = functions.config().trackw.token;
       if (!trackwToken) {
         console.error('âŒ Track.TW token not configured');
         return null;
       }

       const api = new TrackTwAPI(trackwToken);

       // 1. å–å¾—æ‰€æœ‰ç”¨æˆ¶
       const usersSnapshot = await db.collection('users').get();
       console.log(`ğŸ“¦ Found ${usersSnapshot.size} users`);

       let totalProcessed = 0;
       let totalUpdated = 0;

       // 2. é€ç”¨æˆ¶è™•ç†
       for (const userDoc of usersSnapshot.docs) {
         const userId = userDoc.id;

         // å–å¾—è©²ç”¨æˆ¶çš„æ‰€æœ‰æœªå®Œæˆã€æœªåˆªé™¤åŒ…è£¹
         const packagesSnapshot = await db
           .collection(`users/${userId}/packages`)
           .where('isArchived', '==', false)
           .where('isDeleted', '!=', true)
           .get();
         // å†ç”¨ code éæ¿¾å·²å®Œæˆç‹€æ…‹
         const activePackages = packagesSnapshot.docs.filter(doc => {
           const status = doc.data().status;
           return !['delivered', 'returned'].includes(status);
         });

         console.log(`ğŸ‘¤ User ${userId}: ${activePackages.length} active packages`);

         // 3. é€åŒ…è£¹è¿½è¹¤
         for (const packageDoc of activePackages) {
           const pkg = packageDoc.data();
           const packageId = packageDoc.id;

           if (!pkg.trackTwRelationId) {
             console.log(`â­ï¸  Skip ${pkg.trackingNumber}: no relationId`);
             continue;
           }

           try {
             // å‘¼å« Track.TW API
             const tracking = await api.getTracking(pkg.trackTwRelationId);

             if (!tracking.packageHistory || tracking.packageHistory.length === 0) {
               console.log(`â­ï¸  Skip ${pkg.trackingNumber}: no history`);
               continue;
             }

             // å–å¾—æœ€æ–°ç‹€æ…‹
             const latestCheckpoint = tracking.packageHistory[0];
             const newStatus = mapTrackTwStatus(
               latestCheckpoint.checkpointStatus,
               latestCheckpoint.status
             );
             const oldStatus = pkg.status;

             totalProcessed++;

             // 4. ç‹€æ…‹è®ŠåŒ–æ™‚æ›´æ–°
             if (newStatus !== oldStatus) {
               console.log(`ğŸ”„ ${pkg.trackingNumber}: ${oldStatus} â†’ ${newStatus}`);

               await packageDoc.ref.update({
                 status: newStatus,
                 lastUpdated: admin.firestore.FieldValue.serverTimestamp(),
                 storeName: tracking.storeName || pkg.storeName || '',
               });

               totalUpdated++;
             }

           } catch (error: any) {
             console.error(`âŒ Failed to track ${pkg.trackingNumber}:`, error.message);
           }

           // é¿å… API rate limitï¼ˆæ¯å€‹è«‹æ±‚é–“éš” 100msï¼‰
           await new Promise(resolve => setTimeout(resolve, 100));
         }
       }

       console.log(`âœ… [Scheduler] Completed: ${totalProcessed} processed, ${totalUpdated} updated`);
       return null;
     });
   ```

8. **å»ºç«‹ src/triggers.tsï¼ˆç‹€æ…‹è®ŠåŒ–æ¨æ’­ï¼‰**
   ```typescript
   import * as functions from 'firebase-functions';
   import * as admin from 'firebase-admin';
   import { sendPushNotification } from './services/pushNotification';

   const db = admin.firestore();

   // ç›£è½åŒ…è£¹ç‹€æ…‹è®ŠåŒ–
   export const onPackageStatusChange = functions.firestore
     .document('users/{userId}/packages/{packageId}')
     .onUpdate(async (change, context) => {
       const before = change.before.data();
       const after = change.after.data();
       const userId = context.params.userId;
       const packageId = context.params.packageId;

       // ç‹€æ…‹æœªè®ŠåŒ–ï¼Œè·³é
       if (before.status === after.status) {
         return null;
       }

       console.log(`ğŸ“¦ Status changed: ${after.trackingNumber} (${before.status} â†’ ${after.status})`);

       // å–å¾—ç”¨æˆ¶è³‡æ–™
       const userDoc = await db.collection('users').doc(userId).get();
       const userData = userDoc.data();

       if (!userData || !userData.fcmToken) {
         console.log('â­ï¸  Skip: no FCM token');
         return null;
       }

       // æª¢æŸ¥é€šçŸ¥è¨­å®š
       if (!userData.notificationSettings?.enabled) {
         console.log('â­ï¸  Skip: notifications disabled');
         return null;
       }

       // é¿å…é‡è¤‡æ¨æ’­
       if (before.lastNotifiedStatus === after.status) {
         console.log('â­ï¸  Skip: already notified for this status');
         return null;
       }

       // åªåœ¨åˆ°è²¨æ™‚æ¨æ’­
       if (after.status === 'arrivedAtStore' && before.status !== 'arrivedAtStore') {
         const packageName = after.customName || after.trackingNumber;
         const location = after.pickupLocation || after.storeName || 'å–è²¨åœ°é»';

         try {
           await sendPushNotification(userData.fcmToken, {
             title: 'ğŸ“¦ åŒ…è£¹å·²åˆ°é”å–è²¨é»',
             body: `${packageName} å·²åˆ°é” ${location}ï¼Œè«‹å„˜å¿«å–è²¨`,
             data: {
               packageId: packageId,
               trackingNumber: after.trackingNumber,
               status: after.status,
             },
           });

           // æ›´æ–° lastNotifiedStatus
           await change.after.ref.update({
             lastNotifiedStatus: after.status,
           });

           console.log(`âœ… Push sent to ${userId}`);
         } catch (error) {
           console.error('âŒ Failed to send push:', error);
         }
       }

       return null;
     });
   ```

9. **å»ºç«‹ src/index.tsï¼ˆå…¥å£ï¼‰**
   ```typescript
   import * as admin from 'firebase-admin';

   // åˆå§‹åŒ– Firebase Admin SDK
   admin.initializeApp();

   // åŒ¯å‡ºæ‰€æœ‰ Functions
   export { packageTrackingScheduler } from './scheduler';
   export { onPackageStatusChange } from './triggers';
   ```

10. **éƒ¨ç½² Cloud Functions**
    ```bash
    cd functions

    # ç·¨è­¯ TypeScript
    npm run build

    # éƒ¨ç½²åˆ° Firebase
    firebase deploy --only functions

    # æŸ¥çœ‹éƒ¨ç½²ç‹€æ…‹
    firebase functions:log
    ```

#### é©—è­‰æ–¹æ³•
```bash
# 1. éƒ¨ç½²æˆåŠŸå¾Œï¼Œå‰å¾€ Firebase Console > Functions
# 2. ç¢ºèªçœ‹åˆ° 2 å€‹å‡½æ•¸ï¼š
#    - packageTrackingScheduler
#    - onPackageStatusChange
# 3. ç­‰å¾… 15 åˆ†é˜ï¼ŒæŸ¥çœ‹ Logs ç¢ºèªå®šæ™‚ä»»å‹™åŸ·è¡Œ
# 4. æ‰‹å‹•ä¿®æ”¹ Firestore åŒ…è£¹ç‹€æ…‹ç‚º "arrivedAtStore"
# 5. ç¢ºèª iOS è¨­å‚™æ”¶åˆ°æ¨æ’­é€šçŸ¥
```

---

### Phase 4: Deep Link èˆ‡ UI å„ªåŒ– âœ… å·²å®Œæˆ (2026-02-09)

#### ç›®æ¨™
å¯¦ç¾é€šçŸ¥é»æ“Šå¾Œè·³è½‰åˆ°åŒ…è£¹è©³æƒ…é ã€‚

#### å¯¦éš›è¨­è¨ˆæ±ºç­–ï¼ˆèˆ‡åŸå§‹è¨ˆåŠƒçš„å·®ç•°ï¼‰

1. **ä¸å»ºç«‹ç¨ç«‹ NotificationDelegate.swift**ï¼šç›´æ¥æ“´å…… `PackageTrakerApp.swift` ä¸­å·²æœ‰çš„ `NotificationDelegate` classï¼Œæ–°å¢ `didReceive` æ–¹æ³•ã€‚
2. **Binding å‚³ééˆ**ï¼šé€šçŸ¥é»æ“Š â†’ `NotificationCenter`ï¼ˆFoundationï¼‰â†’ `PackageTrakerApp.onReceive` â†’ `pendingPackageId` Binding â†’ `MainTabView` â†’ `PackageListView` â†’ è§¸ç™¼ç¾æœ‰ `navigationDestination(item:)` å°èˆªã€‚
3. **ä¸ä¿®æ”¹ SettingsView**ï¼šç™»å‡ºåŠŸèƒ½å·²åœ¨ Phase 1/2 å®Œæˆï¼Œç„¡éœ€é¡å¤–ä¿®æ”¹ã€‚
4. **å‰æ™¯ banner ä¿æŒç¾ç‹€**ï¼š`willPresent` å·²æœ‰ banner + soundï¼Œä¸åšé¡å¤–èª¿æ•´ã€‚

#### é—œéµæª”æ¡ˆ

**ä¿®æ”¹æª”æ¡ˆï¼š**
- `PackageTraker/PackageTrakerApp.swift` - NotificationDelegate æ–°å¢ `didReceive`ã€æ–°å¢ `pendingPackageId` ç‹€æ…‹ã€`Notification.Name.didTapPackageNotification`
- `PackageTraker/Views/MainTabView.swift` - æ–°å¢ `@Binding var pendingPackageId: UUID?`ï¼Œå‚³éçµ¦ PackageListView
- `PackageTraker/Views/PackageList/PackageListView.swift` - æ–°å¢ `@Binding var pendingPackageId: UUID?`ï¼Œ`.onChange(of:)` è§¸ç™¼å°èˆª

#### è³‡æ–™æµ

```
ç”¨æˆ¶é»æ“Šæ¨æ’­é€šçŸ¥
  â†’ NotificationDelegate.didReceive å–å‡º packageId (String â†’ UUID)
  â†’ NotificationCenter.default.post(.didTapPackageNotification)
  â†’ PackageTrakerApp.onReceive â†’ selectedTab = 0 + pendingPackageId = uuid
  â†’ Binding å‚³é â†’ MainTabView â†’ PackageListView
  â†’ PackageListView.onChange â†’ packages.first(where:) â†’ selectedPackage = package
  â†’ ç¾æœ‰ navigationDestination(item:) è‡ªå‹• push PackageDetailView
```

> **åŸå§‹è¨ˆåŠƒä¸­çš„ä»£ç¢¼ç¯„ä¾‹å·²ç§»é™¤ï¼Œè«‹ç›´æ¥åƒè€ƒå¯¦éš›æª”æ¡ˆã€‚**

#### é©—è­‰çµæœ
- âœ… æ‰‹å‹•ä¿®æ”¹ Firestore ç‹€æ…‹è§¸ç™¼æ¨æ’­
- âœ… é»æ“Šæ¨æ’­é€šçŸ¥è·³è½‰åˆ°è©³æƒ…é 
- âœ… èƒŒæ™¯/é—œé–‰ç‹€æ…‹æ”¶åˆ°æ¨æ’­
- âœ… ç™»å‡ºå¾Œæ¨æ’­åœæ­¢ï¼ˆPhase 2 å·²å¯¦ä½œ FCM Token æ¸…é™¤ï¼‰

#### åŸå§‹è¨ˆåŠƒä¸­çš„å¯¦ä½œæ­¥é©Ÿï¼ˆå·²ä¸é©ç”¨ï¼Œåƒ…ä¿ç•™ä¾›åƒè€ƒï¼‰

1. **ä¿®æ”¹ NotificationDelegate.swift**
   ```swift
   class NotificationDelegate: NSObject, UNUserNotificationCenterDelegate {
       static let shared = NotificationDelegate()

       // å‰æ™¯é€šçŸ¥é¡¯ç¤º
       func userNotificationCenter(
           _ center: UNUserNotificationCenter,
           willPresent notification: UNNotification,
           withCompletionHandler completionHandler: @escaping (UNNotificationPresentationOptions) -> Void
       ) {
           completionHandler([.banner, .sound, .badge])
       }

       // é»æ“Šé€šçŸ¥è™•ç†
       func userNotificationCenter(
           _ center: UNUserNotificationCenter,
           didReceive response: UNNotificationResponse,
           withCompletionHandler completionHandler: @escaping () -> Void
       ) {
           let userInfo = response.notification.request.content.userInfo

           // å–å¾— packageId
           if let packageId = userInfo["packageId"] as? String {
               // ç™¼é€é€šçŸ¥çµ¦ MainTabView
               NotificationCenter.default.post(
                   name: .navigateToPackageDetail,
                   object: nil,
                   userInfo: ["packageId": packageId]
               )
           }

           completionHandler()
       }
   }

   // è‡ªå®šç¾©é€šçŸ¥åç¨±
   extension Notification.Name {
       static let navigateToPackageDetail = Notification.Name("navigateToPackageDetail")
   }
   ```

2. **ä¿®æ”¹ MainTabView.swiftï¼ˆDeep Link å°èˆªï¼‰**
   ```swift
   struct MainTabView: View {
       @State private var selectedTab = 0
       @State private var navigationPath = NavigationPath()
       @State private var selectedPackageId: String?

       var body: some View {
           TabView(selection: $selectedTab) {
               NavigationStack(path: $navigationPath) {
                   PackageListView()
                       .navigationDestination(for: String.self) { packageId in
                           if let package = findPackage(by: packageId) {
                               PackageDetailView(package: package)
                           }
                       }
               }
               .tabItem {
                   Label("åŒ…è£¹åˆ—è¡¨", systemImage: "shippingbox.fill")
               }
               .tag(0)

               // å…¶ä»– tabs...
           }
           .onAppear {
               // ç›£è½æ¨æ’­é»æ“Šäº‹ä»¶
               NotificationCenter.default.addObserver(
                   forName: .navigateToPackageDetail,
                   object: nil,
                   queue: .main
               ) { notification in
                   if let packageId = notification.userInfo?["packageId"] as? String {
                       handleDeepLink(packageId: packageId)
                   }
               }
           }
       }

       private func handleDeepLink(packageId: String) {
           // åˆ‡æ›åˆ°åŒ…è£¹åˆ—è¡¨ tab
           selectedTab = 0

           // å°èˆªåˆ°è©³æƒ…é 
           DispatchQueue.main.asyncAfter(deadline: .now() + 0.3) {
               navigationPath.append(packageId)
           }
       }

       @MainActor
       private func findPackage(by id: String) -> Package? {
           guard let uuid = UUID(uuidString: id) else { return nil }

           let context = ModelContext(...)
           let descriptor = FetchDescriptor<Package>(
               predicate: #Predicate { $0.id == uuid }
           )
           return try? context.fetch(descriptor).first
       }
   }
   ```

3. **ä¿®æ”¹ SettingsView.swiftï¼ˆæ–°å¢ç™»å‡ºåŠŸèƒ½ï¼‰**
   ```swift
   struct SettingsView: View {
       @EnvironmentObject private var authService: FirebaseAuthService
       @State private var showSignOutAlert = false

       var body: some View {
           ScrollView {
               VStack(spacing: 24) {
                   // ... ç¾æœ‰è¨­å®š ...

                   // å¸³è™Ÿå€å¡Š
                   accountSection
               }
           }
           .alert("ç¢ºèªç™»å‡º", isPresented: $showSignOutAlert) {
               Button("å–æ¶ˆ", role: .cancel) {}
               Button("ç™»å‡º", role: .destructive) {
                   signOut()
               }
           } message: {
               Text("ç™»å‡ºå¾Œå°‡åœæ­¢æ¨æ’­é€šçŸ¥ï¼Œæœ¬åœ°è³‡æ–™å°‡ä¿ç•™ã€‚")
           }
       }

       private var accountSection: some View {
           VStack(alignment: .leading, spacing: 12) {
               Text("å¸³è™Ÿ")
                   .font(.title2)
                   .fontWeight(.bold)

               VStack(spacing: 0) {
                   // Apple ID é¡¯ç¤º
                   HStack {
                       Image(systemName: "person.circle.fill")
                           .font(.system(size: 18))
                           .foregroundStyle(.green)

                       Text(authService.currentUser?.email ?? "Apple ID")
                           .foregroundStyle(.white)

                       Spacer()
                   }
                   .padding(16)
                   .background(Color.secondaryCardBackground)

                   Divider()

                   // ç™»å‡ºæŒ‰éˆ•
                   Button {
                       showSignOutAlert = true
                   } label: {
                       HStack {
                           Image(systemName: "rectangle.portrait.and.arrow.right")
                               .font(.system(size: 18))
                               .foregroundStyle(.red)

                           Text("ç™»å‡º")
                               .foregroundStyle(.red)

                           Spacer()
                       }
                       .padding(16)
                       .background(Color.secondaryCardBackground)
                   }
               }
               .clipShape(RoundedRectangle(cornerRadius: 16))
           }
       }

       private func signOut() {
           do {
               // åœæ­¢ç›£è½ Firestore
               FirebaseSyncService.shared.stopObserving()

               // ç™»å‡º Firebase
               try authService.signOut()

               // æ¸…é™¤åŒæ­¥æ¨™è¨˜
               if let userId = authService.currentUser?.uid {
                   UserDefaults.standard.removeObject(forKey: "hasPerformedInitialSync_\(userId)")
               }
           } catch {
               print("Sign out failed: \(error)")
           }
       }
   }
   ```

4. **æ–°å¢æœ¬åœ°åŒ–å­—ä¸²**
   ```strings
   // zh-Hant.lproj/Localizable.strings
   "sync.error.notAuthenticated" = "è«‹å…ˆç™»å…¥";
   "settings.account" = "å¸³è™Ÿ";
   "settings.signOut" = "ç™»å‡º";
   "settings.signOutConfirm.title" = "ç¢ºèªç™»å‡º";
   "settings.signOutConfirm.message" = "ç™»å‡ºå¾Œå°‡åœæ­¢æ¨æ’­é€šçŸ¥ï¼Œæœ¬åœ°è³‡æ–™å°‡ä¿ç•™ã€‚";
   ```

#### é©—è­‰æ–¹æ³•
```bash
# 1. ç™¼é€æ¸¬è©¦æ¨æ’­ï¼ˆFirebase Console > Cloud Messagingï¼‰
# 2. é»æ“Šæ¨æ’­é€šçŸ¥
# 3. ç¢ºèª App è‡ªå‹•è·³è½‰åˆ°å°æ‡‰åŒ…è£¹è©³æƒ…é 
# 4. æ¸¬è©¦ç™»å‡ºåŠŸèƒ½
# 5. ç¢ºèªç™»å‡ºå¾Œæ¨æ’­åœæ­¢
```

---

## è³‡æ–™æµç¨‹åœ–

### å®Œæ•´è³‡æ–™æµ

```
ç”¨æˆ¶æ–°å¢åŒ…è£¹
    â†“
â‘  iOS: å„²å­˜åˆ° SwiftData
    â†“
â‘¡ iOS: syncPackageToCloud()
    â†“
â‘¢ Firestore: /users/{userId}/packages/{packageId}
    â†“
â° æ¯ 15 åˆ†é˜
    â†“
â‘£ Cloud Scheduler è§¸ç™¼ packageTrackingScheduler
    â†“
â‘¤ Cloud Function: æŸ¥è©¢æ‰€æœ‰æœªå®ŒæˆåŒ…è£¹
    â†“
â‘¥ Cloud Function: å‘¼å« Track.TW API
    â†“
â‘¦ Cloud Function: æ¯”å°ç‹€æ…‹è®ŠåŒ–
    â†“
â‘§ Cloud Function: æ›´æ–° Firestore (status)
    â†“
â‘¨ Firestore Trigger: onPackageStatusChange
    â†“
â‘© ç‹€æ…‹ = "arrivedAtStore" ?
    â”œâ”€ Yes â†’ ç™¼é€ FCM æ¨æ’­
    â””â”€ No  â†’ è·³é
    â†“
â‘ª APNs è½‰ç™¼æ¨æ’­åˆ° iOS è¨­å‚™
    â†“
â‘« iOS: é¡¯ç¤ºé€šçŸ¥ banner
    â†“
â‘¬ ç”¨æˆ¶é»æ“Šé€šçŸ¥
    â†“
â‘­ iOS: Deep Link åˆ° PackageDetailView
```

---

## æˆæœ¬ä¼°ç®—ï¼ˆFirebase Free Tierï¼‰

### ç”¨é‡é ä¼°ï¼ˆ100 ç”¨æˆ¶ï¼Œæ¯äºº 5 åŒ…è£¹ï¼‰

| æœå‹™ | ä¼°ç®—ç”¨é‡ | å…è²»é¡åº¦ | æ˜¯å¦å……è¶³ |
|------|----------|----------|----------|
| **Firestore è®€å–** | 500 packages Ã— 96 æ¬¡/å¤© = 48,000 reads/day | 50,000 reads/day | âœ… 96% |
| **Firestore å¯«å…¥** | 500 packages Ã— 10 æ¬¡/å¤© = 5,000 writes/day | 20,000 writes/day | âœ… 25% |
| **Firestore å„²å­˜** | 500 packages Ã— 2KB + 2,000 events Ã— 500B = 2MB | 1GB | âœ… 0.2% |
| **Cloud Functions èª¿ç”¨** | 96 æ¬¡/å¤© Ã— 30 å¤© = 2,880 invocations/month | 2,000,000/month | âœ… 0.14% |
| **Cloud Functions åŸ·è¡Œæ™‚é–“** | 96 æ¬¡ Ã— 3 ç§’ = 288 ç§’/å¤© Ã— 30 = 8,640 ç§’/æœˆ | 400,000 ç§’/æœˆ | âœ… 2.16% |
| **FCM æ¨æ’­** | ç´„ 100 é€šçŸ¥/å¤© = 3,000/æœˆ | ç„¡é™åˆ¶ | âœ… å…è²» |
| **Cloud Scheduler** | 1 job Ã— 96 æ¬¡/å¤© | 3 jobs å…è²» | âœ… å……è£• |

### çµè«–
- 100 ç”¨æˆ¶è¦æ¨¡å®Œå…¨åœ¨å…è²»é¡åº¦å…§
- å¯æ”¯æ´è‡³å°‘ **1,000 ç”¨æˆ¶**ä»åœ¨å…è²»é¡åº¦
- è¶…éå¾Œæˆæœ¬æ¥µä½ï¼ˆæ¯æœˆç´„ $5-10 USDï¼‰

---

## é—œéµæ–‡ä»¶æ¸…å–®

### iOS ç«¯ï¼ˆæ–°å¢ï¼‰
- `PackageTraker/GoogleService-Info.plist`
- `PackageTraker/Services/Firebase/FirebaseAuthService.swift`
- `PackageTraker/Services/Firebase/FirebaseSyncService.swift`
- `PackageTraker/Services/Firebase/FirebasePushService.swift`
- `PackageTraker/Views/Auth/SignInView.swift`
- `PackageTraker/PackageTraker.entitlements`

### iOS ç«¯ï¼ˆä¿®æ”¹ï¼‰
- `PackageTraker/PackageTrakerApp.swift`
- `PackageTraker/Services/PackageRefreshService.swift`
- `PackageTraker/Services/Notification/NotificationDelegate.swift`
- `PackageTraker/Views/AddPackage/AddPackageView.swift`
- `PackageTraker/Views/Settings/SettingsView.swift`
- `PackageTraker/Info.plist`
- `Package.swift` (SPM ä¾è³´)

### å¾Œç«¯ï¼ˆæ–°å¢ï¼‰
- `functions/src/index.ts`
- `functions/src/scheduler.ts`
- `functions/src/triggers.ts`
- `functions/src/services/trackTwApi.ts`
- `functions/src/services/pushNotification.ts`
- `functions/src/utils/statusMapper.ts`
- `functions/package.json`
- `functions/.env.local`

---

## æ¸¬è©¦é©—è­‰è¨ˆåŠƒ

### Phase 1 æ¸¬è©¦ âœ…
- [x] Firebase å°ˆæ¡ˆå»ºç«‹æˆåŠŸ
- [x] Apple Sign In ç™»å…¥æˆåŠŸ
- [x] Firestore `/users/{userId}` å»ºç«‹æˆåŠŸ
- [x] ç™»å‡ºåŠŸèƒ½æ­£å¸¸

### Phase 2 æ¸¬è©¦ âœ…
- [x] æ–°å¢åŒ…è£¹å¾Œ Firestore è‡ªå‹•åŒæ­¥
- [x] ç·¨è¼¯åŒ…è£¹å¾Œ Firestore è‡ªå‹•æ›´æ–°
- [x] åˆªé™¤åŒ…è£¹å¾Œ Firestore æ¨™è¨˜ isDeletedï¼ˆè»Ÿåˆªé™¤ï¼‰
- [x] FCM Token æˆåŠŸä¸Šå‚³åˆ° Firestore
- [x] é¦–æ¬¡ç™»å…¥æœ¬åœ°è³‡æ–™è‡ªå‹•æ‰¹æ¬¡åŒæ­¥
- [x] ç™»å‡ºæ™‚æ¸…é™¤ FCM Token
- [x] App å•Ÿå‹•ä¸è¢«åŒæ­¥é˜»å¡

### Phase 3 æ¸¬è©¦ âœ…
- [x] Cloud Functions éƒ¨ç½²æˆåŠŸ
- [x] å®šæ™‚ä»»å‹™æ¯ 15 åˆ†é˜åŸ·è¡Œ
- [x] ç‹€æ…‹è®ŠåŒ–æ™‚ Firestore è‡ªå‹•æ›´æ–°
- [x] æ‰‹å‹•ä¿®æ”¹ç‹€æ…‹ç‚º "arrivedAtStore" æ”¶åˆ°æ¨æ’­
- [x] æ¨æ’­å…§å®¹æ­£ç¢ºï¼ˆåŒ…å«åŒ…è£¹åç¨±ã€åœ°é»ï¼‰

### Phase 4 æ¸¬è©¦ âœ…
- [x] é»æ“Šæ¨æ’­é€šçŸ¥è·³è½‰åˆ°è©³æƒ…é 
- [x] å‰æ™¯é€šçŸ¥é¡¯ç¤º bannerï¼ˆPhase 2 å·²æœ‰ willPresent å¯¦ä½œï¼‰
- [x] èƒŒæ™¯é€šçŸ¥æ­£å¸¸æ¥æ”¶
- [x] App é—œé–‰æ™‚ä»æ”¶åˆ°æ¨æ’­
- [x] ç™»å‡ºå¾Œæ¨æ’­åœæ­¢ï¼ˆPhase 2 å·²å¯¦ä½œ FCM Token æ¸…é™¤ï¼‰

---

## é¢¨éšªèˆ‡é™ç´šæ–¹æ¡ˆ

### é¢¨éšª 1: Firebase Free Tier è¶…é¡
**é™ç´šæ–¹æ¡ˆ**:
- èª¿æ•´è¼ªè©¢é »ç‡ï¼ˆ15 åˆ†é˜ â†’ 30 åˆ†é˜ï¼‰
- åƒ…è¿½è¹¤æœªåˆ°è²¨åŒ…è£¹
- å‡ç´šåˆ° Blaze è¨ˆåŠƒï¼ˆç”¨å¤šå°‘ä»˜å¤šå°‘ï¼‰

### é¢¨éšª 2: Track.TW API Rate Limit
**é™ç´šæ–¹æ¡ˆ**:
- æ¯å€‹ API è«‹æ±‚é–“éš” 100-200ms
- å–®æ¬¡æœ€å¤šè¿½è¹¤ 100 å€‹åŒ…è£¹
- éŒ¯èª¤æ™‚æŒ‡æ•¸é€€é¿é‡è©¦

### é¢¨éšª 3: APNs æ¨æ’­å¤±æ•—
**é™ç´šæ–¹æ¡ˆ**:
- æœ¬åœ°é€šçŸ¥ä½œç‚º fallbackï¼ˆApp å‰æ™¯æ™‚ï¼‰
- è¨˜éŒ„å¤±æ•—æ—¥èªŒä¸¦é‡è©¦
- é€šçŸ¥ç”¨æˆ¶æª¢æŸ¥é€šçŸ¥æ¬Šé™

### é¢¨éšª 4: Firestore åŒæ­¥è¡çª
**é™ç´šæ–¹æ¡ˆ**:
- Last Write Winsï¼ˆä½¿ç”¨ timestamp æ¯”å°ï¼‰
- æœ¬åœ° SwiftData ä½œç‚º Single Source of Truth
- è¡çªæ™‚å„ªå…ˆä¿ç•™æœ¬åœ°è³‡æ–™

---

## é–‹ç™¼æ™‚é–“é ä¼°

| éšæ®µ | æ™‚é–“ | é–‹ç™¼è€…æŠ€èƒ½éœ€æ±‚ | é¢¨éšªç­‰ç´š |
|------|------|---------------|---------|
| Phase 1: Firebase + Apple Sign In | âœ… å·²å®Œæˆ (2026-02-09) | iOS (SwiftUI, Firebase) | - |
| Phase 2: Firestore åŒæ­¥ + FCM | âœ… å·²å®Œæˆ (2026-02-09) | iOS (SwiftUI, Firestore) | - |
| Phase 3: Cloud Functions | âœ… å·²å®Œæˆ (2026-02-09) | Backend (TypeScript, Firebase) | - |
| Phase 4: Deep Link + UI | âœ… å·²å®Œæˆ (2026-02-09) | iOS (SwiftUI) | - |
| **ç¸½è¨ˆ** | **å…¨éƒ¨å®Œæˆ** | å–®äººå…¨ç«¯é–‹ç™¼ | - |

---

## å¾ŒçºŒå„ªåŒ–æ–¹å‘

### çŸ­æœŸå„ªåŒ–ï¼ˆä¾å„ªå…ˆé †åºï¼‰

#### å„ªåŒ– 1ï¼šæ¨æ’­æ–‡å­—å¤šèªç³»ï¼ˆæœ€é«˜å„ªå…ˆï¼‰

**ç›®æ¨™**ï¼šç›®å‰ Cloud Functions æ¨æ’­é€šçŸ¥åªæœ‰ä¸­æ–‡ï¼Œéœ€æ”¯æ´ zh-Hant/zh-Hans/en ä¸‰ç¨®èªè¨€ã€‚

**ç¾æ³å•é¡Œ**ï¼š
- `functions/src/services/pushNotification.ts` ä¸­çš„æ¨æ’­æ¨™é¡Œå’Œå…§å®¹æ˜¯ç¡¬ç·¨ç¢¼ä¸­æ–‡
- `functions/src/triggers.ts` ä¸­çš„ç‹€æ…‹æ–‡å­—ä¹Ÿæ˜¯å›ºå®šä¸­æ–‡
- ä¸åŒèªç³»ç”¨æˆ¶éƒ½æ”¶åˆ°ä¸­æ–‡æ¨æ’­

**å¯¦æ–½æ–¹æ¡ˆ**ï¼š

1. **Firestore ç”¨æˆ¶èªç³»æ¬„ä½**
   - åœ¨ `/users/{uid}` æ–‡ä»¶æ–°å¢ `language` æ¬„ä½ï¼ˆ`"zh-Hant"` | `"zh-Hans"` | `"en"`ï¼‰
   - iOS ç«¯åœ¨ `FirebaseAuthService.createUserProfileIfNeeded()` ä¸­å¯«å…¥ `Locale.preferredLanguages.first`
   - å¾ŒçºŒç™»å…¥ä¹Ÿæ›´æ–°ï¼Œå› ç‚ºç”¨æˆ¶å¯èƒ½åˆ‡æ›æ‰‹æ©Ÿèªè¨€

2. **Cloud Functions å¤šèªç³»æ¨¡æ¿**
   - æ–°å»º `functions/src/i18n/` ç›®éŒ„ï¼Œå»ºç«‹æ¨æ’­æ–‡å­—æ¨¡æ¿
   - æ¯ç¨®ç‹€æ…‹ï¼ˆarrivedã€deliveredã€transitã€exceptionï¼‰éƒ½æœ‰ä¸‰èªç‰ˆæœ¬
   - ç¯„ä¾‹ï¼š
     ```
     zh-Hant: "ğŸ“¦ æ‚¨çš„åŒ…è£¹å·²åˆ°é” {storeName}ï¼Œå–è²¨ç¢¼ï¼š{pickupCode}"
     zh-Hans: "ğŸ“¦ æ‚¨çš„åŒ…è£¹å·²åˆ°è¾¾ {storeName}ï¼Œå–è´§ç ï¼š{pickupCode}"
     en: "ğŸ“¦ Your package has arrived at {storeName}, pickup code: {pickupCode}"
     ```

3. **æ¨æ’­ç™¼é€æ™‚é¸æ“‡èªç³»**
   - `triggers.ts` ä¸­è®€å–ç”¨æˆ¶çš„ `language` æ¬„ä½
   - æ ¹æ“šèªç³»é¸æ“‡å°æ‡‰æ¨¡æ¿
   - é è¨­ fallback ç‚º `zh-Hant`

**ä¿®æ”¹æª”æ¡ˆ**ï¼š
- `functions/src/services/pushNotification.ts` â€” æ¥å—èªç³»åƒæ•¸
- `functions/src/triggers.ts` â€” è®€å–ç”¨æˆ¶èªç³»ï¼Œå‚³å…¥æ¨æ’­æœå‹™
- æ–°å¢ `functions/src/i18n/notifications.ts` â€” å¤šèªç³»æ¨æ’­æ¨¡æ¿
- `PackageTraker/Services/Firebase/FirebaseAuthService.swift` â€” ä¸Šå‚³ç”¨æˆ¶èªç³»
- `PackageTraker/Services/Firebase/FirebaseSyncService.swift` â€” èªç³»æ›´æ–°åŒæ­¥

---

#### å„ªåŒ– 2ï¼šæ¨æ’­å…§å®¹è±å¯ŒåŒ–

**ç›®æ¨™**ï¼šæ¨æ’­é€šçŸ¥åŠ å…¥å–è²¨ç¢¼ï¼ˆpickupCodeï¼‰ã€å–è²¨æœŸé™ç­‰å¯¦ç”¨è³‡è¨Šã€‚

**ç¾æ³å•é¡Œ**ï¼š
- æ¨æ’­åªé¡¯ç¤ºã€ŒåŒ…è£¹å·²åˆ°é”ã€ç­‰ç°¡å–®æ–‡å­—
- ç”¨æˆ¶éœ€è¦æ‰“é–‹ App æ‰èƒ½çœ‹åˆ°å–è²¨ç¢¼
- ç¼ºå°‘å–è²¨æœŸé™æé†’

**å¯¦æ–½æ–¹æ¡ˆ**ï¼š

1. **è±å¯Œæ¨æ’­ payload**
   - ã€Œå·²åˆ°é”ã€æ¨æ’­åŒ…å«ï¼šå–è²¨ç¢¼ï¼ˆpickupCodeï¼‰ã€é–€å¸‚åç¨±ï¼ˆstoreNameï¼‰
   - ã€Œå¾…å–è²¨ã€æé†’åŒ…å«ï¼šå–è²¨æœŸé™å€’æ•¸å¤©æ•¸
   - ä½¿ç”¨ iOS `UNMutableNotificationContent` çš„ `subtitle` æ¬„ä½é¡¯ç¤ºå–è²¨ç¢¼

2. **Firestore åŒ…è£¹è³‡æ–™æ“´å……**
   - ç¢ºä¿ `pickupCode`ã€`storeName`ã€`pickupDeadline` å·²åŒæ­¥åˆ° Firestore
   - `triggers.ts` è®€å–é€™äº›æ¬„ä½çµ„åˆæ¨æ’­æ–‡å­—

3. **æ¨æ’­æ–‡å­—æ¨¡æ¿ç¯„ä¾‹**
   ```
   æ¨™é¡Œ: "ğŸ“¦ åŒ…è£¹å·²åˆ°é”ï¼"
   å‰¯æ¨™é¡Œ: "å–è²¨ç¢¼ï¼šA1234ï¼ˆå…¨å®¶ XXåº—ï¼‰"
   å…§æ–‡: "è«‹æ–¼ 3 å¤©å…§å‰å¾€å–è²¨"
   ```

**ä¿®æ”¹æª”æ¡ˆ**ï¼š
- `functions/src/triggers.ts` â€” è®€å–åŒ…è£¹è©³ç´°è³‡æ–™çµ„åˆæ¨æ’­
- `functions/src/services/pushNotification.ts` â€” æ”¯æ´ subtitleã€è±å¯Œ payload
- `functions/src/i18n/notifications.ts` â€” è±å¯Œæ–‡å­—æ¨¡æ¿ï¼ˆé…åˆå„ªåŒ– 1ï¼‰

---

#### å„ªåŒ– 3ï¼šæ¯æ—¥å–è²¨æé†’

**ç›®æ¨™**ï¼šæ¯å¤©æ—©ä¸Š 10:00ï¼ˆå°ç£æ™‚é–“ UTC+8ï¼‰æé†’ç”¨æˆ¶æœ‰å¾…å–åŒ…è£¹ã€‚

**å¯¦æ–½æ–¹æ¡ˆ**ï¼š

1. **æ–°å¢ Cloud Functions æ’ç¨‹**
   - æ–°å¢ `dailyPickupReminder` æ’ç¨‹å‡½å¼ï¼Œcron: `0 2 * * *`ï¼ˆUTC 02:00 = å°åŒ— 10:00ï¼‰
   - æŸ¥è©¢æ‰€æœ‰ç”¨æˆ¶ä¸­ç‹€æ…‹ç‚º `arrived` ä¸”æœªå–è²¨ï¼ˆé `collected`ã€é `isArchived`ï¼‰çš„åŒ…è£¹
   - å½™æ•´ç‚ºæ¯ç”¨æˆ¶ä¸€å‰‡æ¨æ’­

2. **æ¨æ’­åˆä½µé‚è¼¯**
   - ä¸€ä½ç”¨æˆ¶æœ‰å¤šå€‹å¾…å–åŒ…è£¹æ™‚ï¼Œåˆä½µæˆä¸€å‰‡ï¼š
     ```
     æ¨™é¡Œ: "ğŸ“¦ æ‚¨æœ‰ 3 å€‹åŒ…è£¹å¾…å–è²¨"
     å…§æ–‡: "å…¨å®¶ XXåº— (A1234)ã€7-11 YYåº— (B5678)..."
     ```
   - åªæœ‰ä¸€å€‹åŒ…è£¹æ™‚ï¼š
     ```
     æ¨™é¡Œ: "ğŸ“¦ åˆ¥å¿˜äº†å–è²¨ï¼"
     å…§æ–‡: "{customName} åœ¨ {storeName} ç­‰ä½ ï¼Œå–è²¨ç¢¼ï¼š{pickupCode}"
     ```

3. **ç”¨æˆ¶åå¥½è¨­å®š**
   - Firestore `notificationSettings.pickupReminder` æ§åˆ¶æ˜¯å¦é–‹å•Ÿ
   - å·²æœ‰æ­¤æ¬„ä½ï¼Œéœ€åœ¨ SettingsView ä¸­åŠ å…¥é–‹é—œ UI

**æ–°å¢æª”æ¡ˆ**ï¼š
- `functions/src/dailyReminder.ts` â€” æ¯æ—¥æé†’æ’ç¨‹å‡½å¼

**ä¿®æ”¹æª”æ¡ˆ**ï¼š
- `functions/src/index.ts` â€” åŒ¯å‡ºæ–°å‡½å¼
- `PackageTraker/Views/Settings/SettingsView.swift` â€” å–è²¨æé†’é–‹é—œ UI
- `PackageTraker/Services/Firebase/FirebaseSyncService.swift` â€” åŒæ­¥æé†’è¨­å®š

---

#### å„ªåŒ– 4ï¼šéš±ç§æ”¿ç­–é é¢

**ç›®æ¨™**ï¼šå°‡ `SignInView.openPrivacyPolicy()` çš„ placeholder URL æ›¿æ›ç‚ºæ­£å¼éš±ç§æ”¿ç­–é é¢ã€‚

**æ­£å¼éš±ç§æ”¿ç­– URL**ï¼š
```
https://ripe-cereal-4f9.notion.site/Privacy-Policy-302341fcbfde81d589a2e4ba6713b911
```

**ä¿®æ”¹æª”æ¡ˆ**ï¼š
- `PackageTraker/Views/Auth/SignInView.swift` â€” å°‡ `openPrivacyPolicy()` ä¸­çš„ URL æ›¿æ›ç‚ºä¸Šè¿°æ­£å¼é€£çµ

**å‚™è¨»**ï¼šæ­¤ç‚ºæœ€ç°¡å–®çš„å„ªåŒ–é …ç›®ï¼Œå¯éš¨æ™‚å¿«é€Ÿå®Œæˆã€‚

---

#### å„ªåŒ– 5ï¼šiOS Widgetï¼ˆè¼ƒä½å„ªå…ˆï¼‰

**ç›®æ¨™**ï¼šiOS æ¡Œé¢å°å·¥å…·é¡¯ç¤ºåŒ…è£¹è¿½è¹¤ç‹€æ…‹ã€‚

**å¯¦æ–½æ–¹æ¡ˆ**ï¼š

1. **Widget Extension**
   - æ–°å¢ Xcode Widget Extension target
   - ä½¿ç”¨ `WidgetKit` + `SwiftUI` å»ºæ§‹
   - æ”¯æ´ Small / Medium / Large ä¸‰ç¨®å°ºå¯¸

2. **è³‡æ–™å…±äº«**
   - é€é App Group å…±äº« SwiftData è³‡æ–™åº«
   - Widget è®€å–æœ€è¿‘çš„æ´»èºåŒ…è£¹ï¼ˆé archivedï¼‰
   - `TimelineProvider` å®šæœŸæ›´æ–°

3. **Widget é¡¯ç¤ºå…§å®¹**
   - **Small**ï¼šæœ€è¿‘ä¸€å€‹åŒ…è£¹çš„ç‹€æ…‹ icon + åç¨± + ç‹€æ…‹æ–‡å­—
   - **Medium**ï¼šæœ€è¿‘ 2-3 å€‹åŒ…è£¹åˆ—è¡¨ï¼ˆåç¨±ã€ç‰©æµå•†ã€ç‹€æ…‹ï¼‰
   - **Large**ï¼šæœ€è¿‘ 4-5 å€‹åŒ…è£¹ + æœ€æ–°è¿½è¹¤äº‹ä»¶

4. **äº’å‹•åŠŸèƒ½**ï¼ˆiOS 17+ï¼‰
   - é»æ“Š Widget é …ç›® â†’ Deep Link é€²å…¥å°æ‡‰åŒ…è£¹è©³æƒ…é 
   - Widget URL scheme: `packagetraker://package/{packageId}`

**æ–°å¢æª”æ¡ˆ**ï¼š
- `PackageTrakerWidget/` â€” Widget Extension ç›®éŒ„
- `PackageTrakerWidget/PackageTrakerWidget.swift` â€” Widget ä¸»å…¥å£
- `PackageTrakerWidget/PackageTimelineProvider.swift` â€” æ™‚é–“è»¸è³‡æ–™æä¾›è€…
- `PackageTrakerWidget/WidgetViews/` â€” Small/Medium/Large è¦–åœ–

**ä¿®æ”¹æª”æ¡ˆ**ï¼š
- `PackageTraker.xcodeproj` â€” æ–°å¢ Widget Extension target
- `PackageTrakerApp.swift` â€” è™•ç† Widget Deep Link URL scheme

---

### ä¸­æœŸå„ªåŒ–ï¼ˆ3-6 å€‹æœˆï¼‰
1. **å¤šè¨­å‚™åŒæ­¥**ï¼šiPad/Mac æ”¯æ´
2. **å®¶åº­å…±äº«**ï¼šèˆ‡å®¶äººå…±äº«åŒ…è£¹è³‡è¨Š
3. **Analytics**ï¼šè¿½è¹¤ç”¨æˆ¶è¡Œç‚ºå„ªåŒ–é«”é©—

### é•·æœŸå„ªåŒ–ï¼ˆ6-12 å€‹æœˆï¼‰
1. **Android ç‰ˆæœ¬**ï¼šReact Native æˆ– Flutter é‡å¯«
2. **Web ç‰ˆæœ¬**ï¼šç€è¦½å™¨å­˜å–
3. **AI é æ¸¬**ï¼šé æ¸¬åˆ°è²¨æ™‚é–“

---

## é™„éŒ„

### A. Firebase Console æ“ä½œæŒ‡å—

```bash
# 1. å»ºç«‹å°ˆæ¡ˆ
https://console.firebase.google.com/ â†’ æ–°å¢å°ˆæ¡ˆ

# 2. è¨­å®š iOS App
å°ˆæ¡ˆè¨­å®š â†’ æ–°å¢æ‡‰ç”¨ç¨‹å¼ â†’ iOS
Bundle ID: com.yourname.PackageTraker
ä¸‹è¼‰ GoogleService-Info.plist

# 3. å•Ÿç”¨æœå‹™
Authentication â†’ Sign-in method â†’ Apple (å•Ÿç”¨)
Firestore Database â†’ å»ºç«‹è³‡æ–™åº« â†’ æ¸¬è©¦æ¨¡å¼
Cloud Functions â†’ å‡ç´šåˆ° Blaze è¨ˆåŠƒï¼ˆåƒ…ä»˜è²»ä½¿ç”¨ï¼‰
Cloud Messaging â†’ ä¸Šå‚³ APNs Key

# 4. è¨­å®š Security Rules
Firestore â†’ Rules â†’ è²¼ä¸Šä¸Šè¿° rules
```

### B. Apple Developer Console æ“ä½œæŒ‡å—

```bash
# 1. å•Ÿç”¨ Sign in with Apple
https://developer.apple.com/account/
Identifiers â†’ App IDs â†’ ä½ çš„ App ID
Capabilities â†’ Sign in with Apple (å‹¾é¸)

# 2. å»ºç«‹ APNs Key
Keys â†’ + â†’ Apple Push Notifications service (APNs)
ä¸‹è¼‰ .p8 æª”æ¡ˆ
è¨˜éŒ„ Key ID å’Œ Team ID

# 3. ä¸Šå‚³åˆ° Firebase
Firebase Console â†’ å°ˆæ¡ˆè¨­å®š â†’ Cloud Messaging
APNs Authentication Key â†’ ä¸Šå‚³ .p8 æª”æ¡ˆ
è¼¸å…¥ Key ID å’Œ Team ID
```

### C. ç’°å¢ƒè®Šæ•¸ç®¡ç†

```bash
# Firebase Functions ç’°å¢ƒè®Šæ•¸
firebase functions:config:set trackw.token="YOUR_TOKEN"
firebase functions:config:get  # æŸ¥çœ‹æ‰€æœ‰è®Šæ•¸

# æœ¬åœ°æ¸¬è©¦ï¼ˆfunctions/.env.localï¼‰
TRACKW_TOKEN="YOUR_TOKEN"

# iOS Secrets.swiftï¼ˆå·²å­˜åœ¨ï¼‰
static let trackTwAPIToken = "YOUR_TOKEN"
```

---

## çµèª

æ­¤å¯¦æ–½è¨ˆåŠƒæ¶µè“‹äº†å¾ Firebase åŸºç¤è¨­å®šåˆ°å®Œæ•´æ¨æ’­ç³»çµ±çš„æ‰€æœ‰æ­¥é©Ÿã€‚æ¡ç”¨åˆ†éšæ®µå¯¦æ–½ç­–ç•¥ï¼Œæ¯å€‹éšæ®µéƒ½æœ‰æ˜ç¢ºçš„ç›®æ¨™å’Œé©—è­‰æ–¹æ³•ï¼Œé™ä½é–‹ç™¼é¢¨éšªã€‚

é è¨ˆ **9-13 å¤©**å®Œæˆæ‰€æœ‰é–‹ç™¼ï¼Œä¸¦åœ¨ Firebase Free Tier å…§æ”¯æ´ 100+ ç”¨æˆ¶ã€‚ç³»çµ±è¨­è¨ˆè€ƒæ…®äº†å¯æ“´å±•æ€§ã€æˆæœ¬æ•ˆç›Šå’Œç”¨æˆ¶é«”é©—ï¼Œç‚º PackageTraker æä¾›äº†ä¼æ¥­ç´šçš„å³æ™‚æ¨æ’­èƒ½åŠ›ã€‚
