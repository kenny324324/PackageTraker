# PackageTraker èƒŒæ™¯è¿½è¹¤èˆ‡æ¨æ’­ç³»çµ±è¨ˆåŠƒ

## æ¦‚è¿°

ç‚º PackageTraker å¯¦ç¾å®Œæ•´çš„å³æ™‚è¿½è¹¤é€šçŸ¥ç³»çµ±ï¼ŒåŒ…å«ï¼š
- âœ… **Phase 1**: é–‹ç™¼è€…é¸é …ï¼ˆæ¸¬è©¦æ©Ÿåˆ¶ï¼‰- å·²å®Œæˆ
- ğŸ”„ **Phase 2**: æœ¬åœ°èƒŒæ™¯åˆ·æ–°ï¼ˆBGAppRefreshTaskï¼‰
- ğŸ”„ **Phase 3**: Server-side æ¨æ’­ï¼ˆFirebase + APNsï¼‰
- ğŸ“‹ **Phase 4**: iOS Widget æ”¯æ´ï¼ˆåŸºæ–¼ Phase 3ï¼‰

---

# Phase é€²åº¦

| Phase | ç‹€æ…‹ | èªªæ˜ |
|-------|------|------|
| Phase 1 | âœ… å®Œæˆ | é–‹ç™¼è€…é¸é …ã€é€šçŸ¥æ¸¬è©¦ã€Mock è³‡æ–™ |
| Phase 2 | ğŸ“‹ è¦åŠƒä¸­ | æœ¬åœ°èƒŒæ™¯åˆ·æ–°ï¼ˆè£œå……æ–¹æ¡ˆï¼‰ |
| Phase 3 | ğŸ“‹ è¦åŠƒä¸­ | Firebase + APNsï¼ˆæ ¸å¿ƒæ–¹æ¡ˆï¼‰ |
| Phase 4 | ğŸ“‹ è¦åŠƒä¸­ | iOS Widget |

---

# Phase 1: é–‹ç™¼è€…é¸é …ï¼ˆæ¸¬è©¦æ©Ÿåˆ¶ï¼‰- âœ… å·²å®Œæˆ

### ç›®æ¨™
åœ¨ DEBUG æ¨¡å¼ä¸‹æä¾›é–‹ç™¼è€…é¸é …é é¢ï¼Œå¯ä»¥ï¼š
1. ç«‹å³ç™¼é€æ¸¬è©¦é€šçŸ¥ï¼ˆåˆ°è²¨é€šçŸ¥ã€å–è²¨æé†’ï¼‰
2. æ¨¡æ“¬ç‹€æ…‹è®ŠåŒ–è§¸ç™¼é€šçŸ¥æµç¨‹
3. æ–°å¢/æ¸…é™¤æ¸¬è©¦åŒ…è£¹ï¼ˆMOCK é–‹é ­ï¼‰
4. æ¸¬è©¦ API é€£ç·šç‹€æ…‹

### éœ€è¦å‰µå»ºçš„æ–‡ä»¶

#### 1. DebugNotificationService.swift
**è·¯å¾‘**: `PackageTraker/Services/Debug/DebugNotificationService.swift`

```swift
#if DEBUG
import Foundation
import UserNotifications

/// Debug é€šçŸ¥æœå‹™ï¼šç”¨æ–¼æ¸¬è©¦é€šçŸ¥åŠŸèƒ½
final class DebugNotificationService {
    static let shared = DebugNotificationService()

    private let notificationService = NotificationService.shared

    /// ç™¼é€æ¸¬è©¦åˆ°è²¨é€šçŸ¥
    func sendTestArrivalNotification(
        title: String = "æ¸¬è©¦åˆ°è²¨é€šçŸ¥",
        body: String = "é€™æ˜¯ä¸€å‰‡æ¸¬è©¦é€šçŸ¥ï¼Œæ‚¨çš„åŒ…è£¹å·²åˆ°é”å–è²¨åœ°é»"
    ) {
        let content = UNMutableNotificationContent()
        content.title = title
        content.body = body
        content.sound = .default

        let trigger = UNTimeIntervalNotificationTrigger(timeInterval: 1, repeats: false)
        let request = UNNotificationRequest(
            identifier: "debug-test-\(UUID().uuidString)",
            content: content,
            trigger: trigger
        )

        UNUserNotificationCenter.current().add(request)
    }

    /// ç™¼é€æ¸¬è©¦å–è²¨æé†’
    func sendTestPickupReminder(count: Int = 3) {
        let content = UNMutableNotificationContent()
        content.title = String(localized: "notification.pickup.title")
        content.body = String(format: String(localized: "notification.pickup.body"), count)
        content.sound = .default

        let trigger = UNTimeIntervalNotificationTrigger(timeInterval: 1, repeats: false)
        let request = UNNotificationRequest(
            identifier: "debug-pickup-\(UUID().uuidString)",
            content: content,
            trigger: trigger
        )

        UNUserNotificationCenter.current().add(request)
    }

    /// æ¨¡æ“¬ç‹€æ…‹è®ŠåŒ–ï¼ˆé‹é€ä¸­ â†’ å·²åˆ°è²¨ï¼‰
    func simulateStatusChange(
        packageName: String = "æ¸¬è©¦åŒ…è£¹",
        location: String = "7-11 æ™¯å®‰é–€å¸‚"
    ) {
        // å»ºç«‹è‡¨æ™‚ Package ç”¨æ–¼é€šçŸ¥
        let mockPackage = Package(
            trackingNumber: "TEST\(Int.random(in: 100000...999999))",
            carrier: .sevenEleven,
            customName: packageName,
            pickupLocation: location,
            status: .arrivedAtStore
        )

        notificationService.scheduleArrivalNotification(for: mockPackage)
    }
}
#endif
```

#### 2. DeveloperOptionsView.swift
**è·¯å¾‘**: `PackageTraker/Views/Settings/DeveloperOptionsView.swift`

```swift
#if DEBUG
import SwiftUI
import SwiftData

/// é–‹ç™¼è€…é¸é …ï¼ˆåƒ… DEBUG æ¨¡å¼ï¼‰
struct DeveloperOptionsView: View {
    @Environment(\.modelContext) private var modelContext
    @State private var apiStatus: String = ""

    private let debugService = DebugNotificationService.shared

    var body: some View {
        List {
            // MARK: - é€šçŸ¥æ¸¬è©¦
            Section {
                Button { debugService.sendTestArrivalNotification() } label: {
                    Label("ç™¼é€åˆ°è²¨é€šçŸ¥", systemImage: "bell.badge.fill")
                }

                Button { debugService.sendTestPickupReminder(count: 3) } label: {
                    Label("ç™¼é€å–è²¨æé†’", systemImage: "clock.badge.exclamationmark.fill")
                }

                Button { debugService.simulateStatusChange() } label: {
                    Label("æ¨¡æ“¬ç‹€æ…‹è®ŠåŒ–é€šçŸ¥", systemImage: "arrow.triangle.2.circlepath")
                }
            } header: {
                Text("é€šçŸ¥æ¸¬è©¦")
            } footer: {
                Text("ç«‹å³ç™¼é€æœ¬åœ°é€šçŸ¥ï¼Œç”¨æ–¼æ¸¬è©¦é€šçŸ¥åŠŸèƒ½æ˜¯å¦æ­£å¸¸")
            }

            // MARK: - Mock è³‡æ–™
            Section {
                Button { addMockPackage() } label: {
                    Label("æ–°å¢æ¸¬è©¦åŒ…è£¹", systemImage: "plus.rectangle.fill")
                }

                Button(role: .destructive) { clearMockData() } label: {
                    Label("æ¸…é™¤æ¸¬è©¦è³‡æ–™", systemImage: "trash.fill")
                }
            } header: {
                Text("Mock è³‡æ–™")
            } footer: {
                Text("æ¸¬è©¦åŒ…è£¹å–®è™Ÿä»¥ MOCK æˆ– TEST é–‹é ­")
            }

            // MARK: - API é™¤éŒ¯
            Section {
                HStack {
                    Text("Track.TW Token")
                    Spacer()
                    Text(TrackTwTokenStorage.shared.getToken() != nil ? "å·²è¨­å®š" : "æœªè¨­å®š")
                        .foregroundStyle(.secondary)
                }

                Button { Task { await testAPIConnection() } } label: {
                    Label("æ¸¬è©¦ API é€£ç·š", systemImage: "antenna.radiowaves.left.and.right")
                }

                if !apiStatus.isEmpty {
                    Text(apiStatus)
                        .font(.caption)
                        .foregroundStyle(.secondary)
                }
            } header: {
                Text("API é™¤éŒ¯")
            }
        }
        .navigationTitle("é–‹ç™¼è€…é¸é …")
        .navigationBarTitleDisplayMode(.inline)
    }

    private func addMockPackage() {
        let carriers: [(Carrier, String, TrackingStatus)] = [
            (.tcat, "momo æ¸¬è©¦è¨‚å–®", .inTransit),
            (.sevenEleven, "è¦çš®æ¸¬è©¦åŒ…è£¹", .arrivedAtStore),
            (.familyMart, "PChome æ¸¬è©¦", .pending)
        ]
        let mock = carriers.randomElement()!

        let package = Package(
            trackingNumber: "MOCK\(Int.random(in: 100000...999999))",
            carrier: mock.0,
            customName: mock.1,
            pickupCode: "\(Int.random(in: 1...9))-\(Int.random(in: 1...9))-\(Int.random(in: 10...99))-\(Int.random(in: 10...99))",
            pickupLocation: mock.0 == .sevenEleven ? "7-11 æ™¯å®‰é–€å¸‚" : "å…¨å®¶ ä¸­å’Œåº—",
            status: mock.2
        )
        modelContext.insert(package)
    }

    private func clearMockData() {
        let descriptor = FetchDescriptor<Package>(
            predicate: #Predicate { $0.trackingNumber.starts(with: "MOCK") || $0.trackingNumber.starts(with: "TEST") }
        )
        if let mockPackages = try? modelContext.fetch(descriptor) {
            for package in mockPackages { modelContext.delete(package) }
        }
    }

    private func testAPIConnection() async {
        do {
            let profile = try await TrackTwAPIClient.shared.getUserProfile()
            apiStatus = "âœ… é€£ç·šæˆåŠŸ: \(profile.username ?? "Unknown")"
        } catch {
            apiStatus = "âŒ é€£ç·šå¤±æ•—: \(error.localizedDescription)"
        }
    }
}
#endif
```

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

#### 3. SettingsView.swift - åŠ å…¥é–‹ç™¼è€…é¸é …å…¥å£
åœ¨ `aboutSection` å¾Œé¢åŠ å…¥ï¼ˆDEBUG onlyï¼‰ï¼š

```swift
#if DEBUG
// é–‹ç™¼è€…é¸é …å€å¡Š
developerSection
#endif

// æ–°å¢ computed property
#if DEBUG
private var developerSection: some View {
    VStack(alignment: .leading, spacing: 12) {
        Text("é–‹ç™¼è€…é¸é …")
            .font(.title2)
            .fontWeight(.bold)
            .foregroundStyle(.orange)

        NavigationLink(destination: DeveloperOptionsView()) {
            HStack(spacing: 12) {
                Image(systemName: "hammer.fill")
                    .font(.system(size: 18))
                    .foregroundStyle(.orange)
                    .frame(width: 28)

                Text("é–‹ç™¼è€…é¸é …")
                    .foregroundStyle(.white)

                Spacer()

                Image(systemName: "chevron.right")
                    .foregroundStyle(.secondary)
            }
            .padding(16)
        }
        .background(Color.secondaryCardBackground)
        .clipShape(RoundedRectangle(cornerRadius: 16))

        Text("åƒ…åœ¨ DEBUG æ¨¡å¼é¡¯ç¤º")
            .font(.caption)
            .foregroundStyle(.orange.opacity(0.7))
    }
}
#endif
```

---

# Phase 2: æœ¬åœ°èƒŒæ™¯åˆ·æ–°ï¼ˆè£œå……æ–¹æ¡ˆï¼‰

## ç›®æ¨™
ä½¿ç”¨ iOS BGAppRefreshTask åœ¨èƒŒæ™¯å®šæœŸæª¢æŸ¥åŒ…è£¹ç‹€æ…‹ï¼Œä½œç‚º Phase 3 çš„è£œå……ã€‚

## å®šä½
- **ä¸æ˜¯ä¸»è¦æ–¹æ¡ˆ**ï¼šiOS æ§åˆ¶åŸ·è¡Œæ™‚é–“ï¼Œå¯èƒ½å»¶é²æ•¸å°æ™‚
- **ä½œç‚ºè£œå……**ï¼šç•¶ App åœ¨èƒŒæ™¯ä½†å°šæœªè¢«æ»‘æ‰æ™‚ï¼Œæä¾›é¡å¤–çš„åˆ·æ–°æ©Ÿæœƒ
- **é…åˆ Phase 3**ï¼šä¸»è¦ä¾è³´ Server-side æ¨æ’­ï¼Œæœ¬åœ°èƒŒæ™¯åˆ·æ–°ä½œç‚ºå‚™ç”¨

## é™åˆ¶
| é™åˆ¶ | èªªæ˜ |
|------|------|
| åŸ·è¡Œæ™‚é–“ä¸ç¢ºå®š | iOS æ±ºå®šä½•æ™‚åŸ·è¡Œï¼Œå¯èƒ½å»¶é²æ•¸å°æ™‚ |
| App è¢«æ»‘æ‰å¾Œä¸åŸ·è¡Œ | ç”¨æˆ¶å¼·åˆ¶é—œé–‰ App å¾Œï¼ŒèƒŒæ™¯ä»»å‹™ä¸æœƒåŸ·è¡Œ |
| ä½é›»é‡æ¨¡å¼ | å¯èƒ½å®Œå…¨ä¸åŸ·è¡Œ |
| åŸ·è¡Œæ™‚é–“çŸ­ | æœ€å¤š 30 ç§’ï¼Œéœ€å¿«é€Ÿå®Œæˆ |

## å¯¦ä½œæ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    iOS App                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  PackageTrakerApp.swift                                 â”‚
â”‚    â””â”€ init(): è¨»å†ŠèƒŒæ™¯ä»»å‹™                               â”‚
â”‚    â””â”€ scenePhase.background: æ’ç¨‹ä¸‹æ¬¡åˆ·æ–°                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  BackgroundTrackingService.swift                        â”‚
â”‚    â”œâ”€ registerBackgroundTask()                          â”‚
â”‚    â”œâ”€ scheduleBackgroundRefresh()                       â”‚
â”‚    â””â”€ performBackgroundTracking()                       â”‚
â”‚         â”œâ”€ æŸ¥è©¢å¾…è¿½è¹¤åŒ…è£¹ï¼ˆSwiftDataï¼‰                   â”‚
â”‚         â”œâ”€ å‘¼å« TrackingManager.refreshAll()            â”‚
â”‚         â”œâ”€ æ¯”è¼ƒç‹€æ…‹è®ŠåŒ–                                  â”‚
â”‚         â””â”€ ç™¼é€æœ¬åœ°é€šçŸ¥                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## éœ€è¦å‰µå»ºçš„æ–‡ä»¶

### 1. BackgroundTrackingService.swift
**è·¯å¾‘**: `PackageTraker/Services/Background/BackgroundTrackingService.swift`

```swift
import Foundation
import BackgroundTasks
import SwiftData
import WidgetKit

final class BackgroundTrackingService {
    static let shared = BackgroundTrackingService()
    static let taskIdentifier = "com.packagetraker.tracking"

    private init() {}

    // MARK: - è¨»å†ŠèƒŒæ™¯ä»»å‹™

    func registerBackgroundTask() {
        BGTaskScheduler.shared.register(
            forTaskWithIdentifier: Self.taskIdentifier,
            using: nil
        ) { task in
            guard let refreshTask = task as? BGAppRefreshTask else { return }
            self.handleBackgroundRefresh(task: refreshTask)
        }
    }

    // MARK: - æ’ç¨‹èƒŒæ™¯åˆ·æ–°

    func scheduleBackgroundRefresh() {
        let request = BGAppRefreshTaskRequest(identifier: Self.taskIdentifier)
        // æœ€æ—© 15 åˆ†é˜å¾ŒåŸ·è¡Œï¼ˆiOS å¯èƒ½å»¶é²æ›´ä¹…ï¼‰
        request.earliestBeginDate = Date(timeIntervalSinceNow: 15 * 60)

        do {
            try BGTaskScheduler.shared.submit(request)
            print("[Background] å·²æ’ç¨‹èƒŒæ™¯åˆ·æ–°")
        } catch {
            print("[Background] æ’ç¨‹å¤±æ•—: \(error)")
        }
    }

    // MARK: - è™•ç†èƒŒæ™¯åˆ·æ–°

    private func handleBackgroundRefresh(task: BGAppRefreshTask) {
        // å…ˆæ’ç¨‹ä¸‹æ¬¡åˆ·æ–°
        scheduleBackgroundRefresh()

        let refreshOperation = Task {
            await performBackgroundTracking()
        }

        // è¨­ç½®éæœŸè™•ç†
        task.expirationHandler = {
            refreshOperation.cancel()
        }

        // ç­‰å¾…å®Œæˆ
        Task {
            _ = await refreshOperation.result
            task.setTaskCompleted(success: true)
        }
    }

    // MARK: - åŸ·è¡ŒèƒŒæ™¯è¿½è¹¤

    @MainActor
    private func performBackgroundTracking() async {
        print("[Background] é–‹å§‹èƒŒæ™¯è¿½è¹¤...")

        // 1. å»ºç«‹ SwiftData context
        guard let container = try? ModelContainer(for: Package.self, TrackingEvent.self) else {
            print("[Background] ç„¡æ³•å»ºç«‹ ModelContainer")
            return
        }

        let context = container.mainContext

        // 2. æŸ¥è©¢å¾…è¿½è¹¤çš„åŒ…è£¹ï¼ˆæœªæ­¸æª”ã€éå·²å–è²¨ï¼‰
        let descriptor = FetchDescriptor<Package>(
            predicate: #Predicate<Package> { package in
                !package.isArchived && package.statusRawValue != "delivered"
            }
        )

        guard let packages = try? context.fetch(descriptor), !packages.isEmpty else {
            print("[Background] æ²’æœ‰å¾…è¿½è¹¤çš„åŒ…è£¹")
            return
        }

        print("[Background] æ‰¾åˆ° \(packages.count) å€‹å¾…è¿½è¹¤åŒ…è£¹")

        // 3. è¿½è¹¤æ¯å€‹åŒ…è£¹
        for package in packages {
            let oldStatus = package.status

            do {
                let result = try await TrackingManager.shared.track(package: package)

                // 4. æ›´æ–°ç‹€æ…‹
                package.statusRawValue = result.currentStatus.rawValue
                if let storeName = result.storeName {
                    package.pickupLocation = storeName
                }

                // 5. ç‹€æ…‹è®ŠåŒ–æ™‚ç™¼é€é€šçŸ¥
                if oldStatus != result.currentStatus {
                    NotificationManager.shared.handleStatusChange(
                        package: package,
                        oldStatus: oldStatus,
                        newStatus: result.currentStatus
                    )
                }
            } catch {
                print("[Background] è¿½è¹¤å¤±æ•— \(package.trackingNumber): \(error)")
            }
        }

        // 6. å„²å­˜è®Šæ›´
        try? context.save()

        // 7. é€šçŸ¥ Widget æ›´æ–°
        WidgetCenter.shared.reloadAllTimelines()

        print("[Background] èƒŒæ™¯è¿½è¹¤å®Œæˆ")
    }
}
```

## éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

### 2. Info.plist
åŠ å…¥èƒŒæ™¯ä»»å‹™è­˜åˆ¥ç¢¼ï¼š

```xml
<key>BGTaskSchedulerPermittedIdentifiers</key>
<array>
    <string>com.packagetraker.emailsync</string>
    <string>com.packagetraker.tracking</string>
</array>
```

### 3. PackageTrakerApp.swift
ä¿®æ”¹ `init()` å’ŒåŠ å…¥ `scenePhase` ç›£è½ï¼š

```swift
@main
struct PackageTrakerApp: App {
    @Environment(\.scenePhase) private var scenePhase

    init() {
        // è¨­ç½®é€šçŸ¥ä¸­å¿ƒä»£ç†
        UNUserNotificationCenter.current().delegate = NotificationDelegate.shared

        // è¨»å†ŠèƒŒæ™¯ä»»å‹™
        if FeatureFlags.backgroundTrackingEnabled {
            BackgroundTrackingService.shared.registerBackgroundTask()
        }
    }

    var body: some Scene {
        WindowGroup {
            // ...
        }
        .onChange(of: scenePhase) { oldPhase, newPhase in
            if newPhase == .background && FeatureFlags.backgroundTrackingEnabled {
                BackgroundTrackingService.shared.scheduleBackgroundRefresh()
            }
        }
    }
}
```

### 4. FeatureFlags.swift
åŠ å…¥é–‹é—œï¼š

```swift
struct FeatureFlags {
    static let emailAutoImportEnabled = false
    static let backgroundTrackingEnabled = true  // æ–°å¢
}
```

## æ¸¬è©¦æ–¹æ³•

### Xcode æ¨¡æ“¬èƒŒæ™¯åˆ·æ–°
```bash
# æ–¹æ³• 1: Xcode Debug Menu
Debug > Simulate Background Fetch

# æ–¹æ³• 2: LLDB å‘½ä»¤
e -l objc -- (void)[[BGTaskScheduler sharedScheduler] _simulateLaunchForTaskWithIdentifier:@"com.packagetraker.tracking"]
```

---

# Phase 3: Server-side æ¨æ’­ï¼ˆæ ¸å¿ƒæ–¹æ¡ˆï¼‰â­

## ç‚ºä»€éº¼éœ€è¦ Server-sideï¼Ÿ

| æ–¹æ¡ˆ | å³æ™‚æ€§ | App é—œé–‰å¾Œ | Widget | é›»é‡æ¶ˆè€— |
|------|--------|-----------|--------|----------|
| ç´”æœ¬åœ° | âŒ å·® | âŒ ä¸å·¥ä½œ | âŒ ç„¡æ³•å³æ™‚æ›´æ–° | é«˜ï¼ˆé »ç¹å–šé†’ï¼‰ |
| Server-side | âœ… å¥½ | âœ… æ­£å¸¸æ¨æ’­ | âœ… å¯è§¸ç™¼åˆ·æ–° | ä½ï¼ˆæŒ‰éœ€æ¨æ’­ï¼‰ |

## æ•´é«”æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç³»çµ±æ¶æ§‹åœ–                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚   iOS App    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”‚         APNs (Apple)             â”‚     â”‚
â”‚   â”‚              â”‚ æ¨æ’­    â”‚                                   â”‚     â”‚
â”‚   â”‚  - é¡¯ç¤ºé€šçŸ¥   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚   â”‚  - æ›´æ–° UI   â”‚                       â–²                          â”‚
â”‚   â”‚  - åˆ·æ–° Widgetâ”‚                       â”‚ ç™¼é€æ¨æ’­                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚                          â”‚
â”‚          â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚          â”‚ 1. è¨»å†Š Token     â”‚                       â”‚              â”‚
â”‚          â”‚ 2. åŒæ­¥åŒ…è£¹       â”‚   Firebase Backend    â”‚              â”‚
â”‚          â–¼                    â”‚                       â”‚              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚
â”‚   â”‚   Firestore  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚ Cloud Functions â”‚  â”‚              â”‚
â”‚   â”‚   Database   â”‚           â”‚  â”‚                 â”‚  â”‚              â”‚
â”‚   â”‚              â”‚           â”‚  â”‚ - å®šæ™‚è¼ªè©¢       â”‚  â”‚              â”‚
â”‚   â”‚  - ç”¨æˆ¶è³‡æ–™   â”‚           â”‚  â”‚ - ç‹€æ…‹æ¯”è¼ƒ       â”‚  â”‚              â”‚
â”‚   â”‚  - åŒ…è£¹æ¸…å–®   â”‚           â”‚  â”‚ - æ¨æ’­è§¸ç™¼       â”‚  â”‚              â”‚
â”‚   â”‚  - ç‹€æ…‹å¿«å–   â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚           â”‚           â”‚              â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                          â”‚                          â”‚
â”‚                                          â–¼ å®šæ™‚å‘¼å«                  â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚                              â”‚     Track.TW API     â”‚              â”‚
â”‚                              â”‚                       â”‚              â”‚
â”‚                              â”‚  - æŸ¥è©¢ç‰©æµç‹€æ…‹        â”‚              â”‚
â”‚                              â”‚  - å›å‚³æœ€æ–°è³‡è¨Š        â”‚              â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Firebase æœå‹™é¸æ“‡

| æœå‹™ | ç”¨é€” | Free Tier |
|------|------|-----------|
| **Cloud Firestore** | å„²å­˜ç”¨æˆ¶/åŒ…è£¹è³‡æ–™ | 50K è®€/20K å¯«/æ—¥ |
| **Cloud Functions** | å®šæ™‚è¼ªè©¢ + æ¨æ’­é‚è¼¯ | 2M èª¿ç”¨/æœˆ |
| **Cloud Messaging** | ç™¼é€æ¨æ’­åˆ° APNs | ç„¡é™åˆ¶ |
| **Cloud Scheduler** | è§¸ç™¼å®šæ™‚ä»»å‹™ | 3 jobs/å…è²» |

**ä¼°ç®—ï¼ˆ100 ç”¨æˆ¶ã€æ¯äºº 5 åŒ…è£¹ï¼‰**ï¼š
- æ¯ 30 åˆ†é˜è¼ªè©¢ = 48 æ¬¡/æ—¥ Ã— 500 åŒ…è£¹ = 24,000 API èª¿ç”¨/æ—¥
- Firestore: ~24K è®€ + ~1K å¯«/æ—¥ âœ… åœ¨å…è²»é¡åº¦å…§
- Functions: ~1,440 èª¿ç”¨/æ—¥ â‰ˆ 43K/æœˆ âœ… åœ¨å…è²»é¡åº¦å…§

---

## Firebase å°ˆæ¡ˆè¨­ç½®

### Step 1: å»ºç«‹ Firebase å°ˆæ¡ˆ

1. å‰å¾€ [Firebase Console](https://console.firebase.google.com/)
2. å»ºç«‹æ–°å°ˆæ¡ˆï¼š`PackageTraker` æˆ– `pickup-tw`
3. å•Ÿç”¨ä»¥ä¸‹æœå‹™ï¼š
   - Cloud Firestore
   - Cloud Functions
   - Cloud Messaging

### Step 2: iOS App è¨­å®š

1. åœ¨ Firebase Console æ–°å¢ iOS App
2. Bundle ID: `com.yourname.PackageTraker`
3. ä¸‹è¼‰ `GoogleService-Info.plist`
4. åŠ å…¥ Xcode å°ˆæ¡ˆ

### Step 3: APNs è¨­å®š

1. Apple Developer > Certificates, Identifiers & Profiles
2. Keys > å»ºç«‹æ–°çš„ APNs Key
3. ä¸‹è¼‰ `.p8` æª”æ¡ˆ
4. Firebase Console > Project Settings > Cloud Messaging
5. ä¸Šå‚³ APNs Key (Team ID, Key ID)

---

## Firestore è³‡æ–™çµæ§‹

```
firestore/
â”œâ”€â”€ users/
â”‚   â””â”€â”€ {userId}/
â”‚       â”œâ”€â”€ fcmToken: "xxx"           // FCM æ¨æ’­ token
â”‚       â”œâ”€â”€ trackTwToken: "xxx"       // Track.TW API token (åŠ å¯†å„²å­˜)
â”‚       â”œâ”€â”€ createdAt: Timestamp
â”‚       â”œâ”€â”€ lastSyncAt: Timestamp
â”‚       â””â”€â”€ settings/
â”‚           â”œâ”€â”€ notificationsEnabled: true
â”‚           â”œâ”€â”€ arrivalNotification: true
â”‚           â””â”€â”€ pickupReminder: true
â”‚
â”œâ”€â”€ packages/
â”‚   â””â”€â”€ {packageId}/
â”‚       â”œâ”€â”€ userId: "xxx"
â”‚       â”œâ”€â”€ trackingNumber: "xxx"
â”‚       â”œâ”€â”€ carrierUUID: "xxx"        // Track.TW carrier UUID
â”‚       â”œâ”€â”€ relationId: "xxx"         // Track.TW relation ID
â”‚       â”œâ”€â”€ currentStatus: "inTransit"
â”‚       â”œâ”€â”€ lastCheckpoint: {
â”‚       â”‚   â”œâ”€â”€ status: "transit"
â”‚       â”‚   â”œâ”€â”€ description: "..."
â”‚       â”‚   â”œâ”€â”€ location: "..."
â”‚       â”‚   â””â”€â”€ timestamp: Timestamp
â”‚       â”‚ }
â”‚       â”œâ”€â”€ pickupLocation: "7-11 æ™¯å®‰é–€å¸‚"
â”‚       â”œâ”€â”€ customName: "è¦çš®è¨‚å–®"
â”‚       â”œâ”€â”€ createdAt: Timestamp
â”‚       â””â”€â”€ updatedAt: Timestamp
â”‚
â””â”€â”€ syncQueue/                        // å¾…åŒæ­¥ä½‡åˆ—ï¼ˆå¯é¸ï¼‰
    â””â”€â”€ {queueId}/
        â”œâ”€â”€ packageId: "xxx"
        â”œâ”€â”€ priority: 1
        â””â”€â”€ scheduledAt: Timestamp
```

---

## Cloud Functions å¯¦ä½œ

### å°ˆæ¡ˆçµæ§‹
```
functions/
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts              // å…¥å£é»
â”‚   â”œâ”€â”€ scheduled/
â”‚   â”‚   â””â”€â”€ trackingPoller.ts // å®šæ™‚è¼ªè©¢
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ trackTwApi.ts     // Track.TW API å°è£
â”‚   â”‚   â””â”€â”€ pushNotification.ts
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ statusMapper.ts   // ç‹€æ…‹æ˜ å°„
â””â”€â”€ .env                      // ç’°å¢ƒè®Šæ•¸
```

### æ ¸å¿ƒç¨‹å¼ç¢¼

#### `src/index.ts`
```typescript
import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';

admin.initializeApp();

// å®šæ™‚è¼ªè©¢ï¼ˆæ¯ 30 åˆ†é˜ï¼‰
export { scheduledTrackingPoll } from './scheduled/trackingPoller';

// HTTP ç«¯é»ï¼ˆiOS App å‘¼å«ï¼‰
export { registerDevice } from './api/registerDevice';
export { syncPackage } from './api/syncPackage';
export { removePackage } from './api/removePackage';
```

#### `src/scheduled/trackingPoller.ts`
```typescript
import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';
import { TrackTwApi } from '../services/trackTwApi';
import { sendPushNotification } from '../services/pushNotification';
import { mapCheckpointStatus } from '../utils/statusMapper';

const db = admin.firestore();

// æ¯ 30 åˆ†é˜åŸ·è¡Œä¸€æ¬¡
export const scheduledTrackingPoll = functions.pubsub
  .schedule('every 30 minutes')
  .onRun(async (context) => {
    console.log('é–‹å§‹å®šæ™‚è¿½è¹¤è¼ªè©¢...');

    // 1. å–å¾—æ‰€æœ‰å¾…è¿½è¹¤çš„åŒ…è£¹
    const packagesSnapshot = await db.collection('packages')
      .where('currentStatus', 'not-in', ['delivered', 'returned'])
      .get();

    if (packagesSnapshot.empty) {
      console.log('æ²’æœ‰å¾…è¿½è¹¤çš„åŒ…è£¹');
      return null;
    }

    console.log(`æ‰¾åˆ° ${packagesSnapshot.size} å€‹å¾…è¿½è¹¤åŒ…è£¹`);

    // 2. æŒ‰ç”¨æˆ¶åˆ†çµ„ï¼ˆå…±ç”¨ Track.TW tokenï¼‰
    const packagesByUser: Map<string, any[]> = new Map();
    packagesSnapshot.docs.forEach(doc => {
      const data = doc.data();
      const userId = data.userId;
      if (!packagesByUser.has(userId)) {
        packagesByUser.set(userId, []);
      }
      packagesByUser.get(userId)!.push({ id: doc.id, ...data });
    });

    // 3. è™•ç†æ¯å€‹ç”¨æˆ¶çš„åŒ…è£¹
    for (const [userId, packages] of packagesByUser) {
      await processUserPackages(userId, packages);
    }

    console.log('å®šæ™‚è¿½è¹¤è¼ªè©¢å®Œæˆ');
    return null;
  });

async function processUserPackages(userId: string, packages: any[]) {
  // å–å¾—ç”¨æˆ¶çš„ Track.TW token
  const userDoc = await db.collection('users').doc(userId).get();
  const userData = userDoc.data();

  if (!userData?.trackTwToken) {
    console.log(`ç”¨æˆ¶ ${userId} æ²’æœ‰è¨­å®š Track.TW token`);
    return;
  }

  const api = new TrackTwApi(userData.trackTwToken);

  for (const pkg of packages) {
    try {
      // å‘¼å« Track.TW API
      const tracking = await api.getTracking(pkg.relationId);

      if (!tracking.checkpoints?.length) continue;

      const latestCheckpoint = tracking.checkpoints[0];
      const newStatus = mapCheckpointStatus(latestCheckpoint.status);
      const oldStatus = pkg.currentStatus;

      // ç‹€æ…‹æœ‰è®ŠåŒ–
      if (newStatus !== oldStatus) {
        console.log(`åŒ…è£¹ ${pkg.trackingNumber} ç‹€æ…‹è®ŠåŒ–: ${oldStatus} -> ${newStatus}`);

        // æ›´æ–° Firestore
        await db.collection('packages').doc(pkg.id).update({
          currentStatus: newStatus,
          lastCheckpoint: {
            status: latestCheckpoint.status,
            description: latestCheckpoint.description,
            location: latestCheckpoint.location,
            timestamp: admin.firestore.Timestamp.fromDate(
              new Date(latestCheckpoint.timestamp)
            ),
          },
          pickupLocation: tracking.store_name || pkg.pickupLocation,
          updatedAt: admin.firestore.FieldValue.serverTimestamp(),
        });

        // ç™¼é€æ¨æ’­é€šçŸ¥
        if (userData.settings?.notificationsEnabled) {
          // åˆ°è²¨é€šçŸ¥
          if (newStatus === 'arrivedAtStore' && userData.settings?.arrivalNotification) {
            await sendPushNotification(userData.fcmToken, {
              title: 'åŒ…è£¹å·²åˆ°è²¨',
              body: `${pkg.customName || pkg.trackingNumber} å·²åˆ°é” ${tracking.store_name || 'å–è²¨åœ°é»'}`,
              data: {
                type: 'arrival',
                packageId: pkg.id,
              },
            });
          }
        }
      }
    } catch (error) {
      console.error(`è¿½è¹¤åŒ…è£¹ ${pkg.trackingNumber} å¤±æ•—:`, error);
    }
  }
}
```

#### `src/services/trackTwApi.ts`
```typescript
import axios from 'axios';

const BASE_URL = 'https://track.tw/api/v1';

export class TrackTwApi {
  private token: string;

  constructor(token: string) {
    this.token = token;
  }

  async getTracking(relationId: string) {
    const response = await axios.get(
      `${BASE_URL}/tracking/${relationId}`,
      {
        headers: {
          'Authorization': `Bearer ${this.token}`,
          'Content-Type': 'application/json',
        },
      }
    );
    return response.data;
  }

  async importPackage(carrierId: string, trackingNumbers: string[]) {
    const response = await axios.post(
      `${BASE_URL}/import`,
      {
        carrier: carrierId,
        tracking_numbers: trackingNumbers,
      },
      {
        headers: {
          'Authorization': `Bearer ${this.token}`,
          'Content-Type': 'application/json',
        },
      }
    );
    return response.data;
  }
}
```

#### `src/services/pushNotification.ts`
```typescript
import * as admin from 'firebase-admin';

interface PushPayload {
  title: string;
  body: string;
  data?: Record<string, string>;
}

export async function sendPushNotification(
  fcmToken: string,
  payload: PushPayload
): Promise<void> {
  const message: admin.messaging.Message = {
    token: fcmToken,
    notification: {
      title: payload.title,
      body: payload.body,
    },
    data: payload.data,
    apns: {
      headers: {
        'apns-priority': '10',
      },
      payload: {
        aps: {
          'content-available': 1,  // å…è¨±èƒŒæ™¯æ›´æ–°
          sound: 'default',
        },
      },
    },
  };

  try {
    await admin.messaging().send(message);
    console.log(`æ¨æ’­ç™¼é€æˆåŠŸ: ${payload.title}`);
  } catch (error) {
    console.error('æ¨æ’­ç™¼é€å¤±æ•—:', error);
    throw error;
  }
}
```

#### `src/utils/statusMapper.ts`
```typescript
// Track.TW checkpoint_status -> App TrackingStatus
export function mapCheckpointStatus(checkpointStatus: string): string {
  switch (checkpointStatus) {
    case 'pending':
      return 'pending';
    case 'transit':
      return 'inTransit';
    case 'delivered':
      return 'arrivedAtStore';  // Track.TW çš„ delivered = åˆ°åº—
    case 'picked_up':
      return 'delivered';       // çœŸæ­£å–è²¨
    case 'exception':
      return 'returned';
    default:
      return 'inTransit';
  }
}
```

---

## iOS App æ•´åˆ

### éœ€è¦åŠ å…¥çš„ Dependencies

**Package.swift / SPM:**
```swift
.package(url: "https://github.com/firebase/firebase-ios-sdk.git", from: "10.0.0")

// Products:
.product(name: "FirebaseCore", package: "firebase-ios-sdk"),
.product(name: "FirebaseFirestore", package: "firebase-ios-sdk"),
.product(name: "FirebaseMessaging", package: "firebase-ios-sdk"),
```

### éœ€è¦å‰µå»ºçš„æ–‡ä»¶

#### `FirebasePushService.swift`
**è·¯å¾‘**: `PackageTraker/Services/Firebase/FirebasePushService.swift`

```swift
import Foundation
import FirebaseCore
import FirebaseMessaging
import FirebaseFirestore
import UserNotifications

@MainActor
final class FirebasePushService: NSObject, ObservableObject {
    static let shared = FirebasePushService()

    @Published var fcmToken: String?

    private let db = Firestore.firestore()
    private var userId: String?

    private override init() {
        super.init()
    }

    // MARK: - åˆå§‹åŒ–

    func configure() {
        FirebaseApp.configure()
        Messaging.messaging().delegate = self

        // è«‹æ±‚é€šçŸ¥æ¬Šé™
        requestNotificationPermission()
    }

    private func requestNotificationPermission() {
        UNUserNotificationCenter.current().requestAuthorization(
            options: [.alert, .sound, .badge]
        ) { granted, error in
            if granted {
                DispatchQueue.main.async {
                    UIApplication.shared.registerForRemoteNotifications()
                }
            }
        }
    }

    // MARK: - ç”¨æˆ¶è¨»å†Š

    func registerUser(trackTwToken: String) async throws {
        guard let fcmToken = self.fcmToken else {
            throw FirebaseError.noFCMToken
        }

        // ä½¿ç”¨ FCM token çš„ hash ä½œç‚º userIdï¼ˆæˆ–ä½¿ç”¨ Sign in with Appleï¼‰
        let userId = fcmToken.hash.description
        self.userId = userId

        try await db.collection("users").document(userId).setData([
            "fcmToken": fcmToken,
            "trackTwToken": trackTwToken,  // å¯¦éš›æ‡‰åŠ å¯†å„²å­˜
            "createdAt": FieldValue.serverTimestamp(),
            "lastSyncAt": FieldValue.serverTimestamp(),
            "settings": [
                "notificationsEnabled": true,
                "arrivalNotification": true,
                "pickupReminder": true,
            ]
        ], merge: true)
    }

    // MARK: - åŒæ­¥åŒ…è£¹

    func syncPackage(_ package: Package, relationId: String) async throws {
        guard let userId = self.userId else {
            throw FirebaseError.notRegistered
        }

        let packageId = "\(userId)_\(package.trackingNumber)"

        try await db.collection("packages").document(packageId).setData([
            "userId": userId,
            "trackingNumber": package.trackingNumber,
            "carrierUUID": package.carrier.trackTwUUID ?? "",
            "relationId": relationId,
            "currentStatus": package.status.rawValue,
            "customName": package.customName ?? "",
            "pickupLocation": package.pickupLocation ?? "",
            "createdAt": FieldValue.serverTimestamp(),
            "updatedAt": FieldValue.serverTimestamp(),
        ], merge: true)
    }

    // MARK: - ç§»é™¤åŒ…è£¹

    func removePackage(_ package: Package) async throws {
        guard let userId = self.userId else { return }

        let packageId = "\(userId)_\(package.trackingNumber)"
        try await db.collection("packages").document(packageId).delete()
    }
}

// MARK: - MessagingDelegate

extension FirebasePushService: MessagingDelegate {
    nonisolated func messaging(
        _ messaging: Messaging,
        didReceiveRegistrationToken fcmToken: String?
    ) {
        Task { @MainActor in
            self.fcmToken = fcmToken
            print("[Firebase] FCM Token: \(fcmToken ?? "nil")")
        }
    }
}

// MARK: - Errors

enum FirebaseError: LocalizedError {
    case noFCMToken
    case notRegistered

    var errorDescription: String? {
        switch self {
        case .noFCMToken:
            return "å°šæœªå–å¾— FCM Token"
        case .notRegistered:
            return "ç”¨æˆ¶å°šæœªè¨»å†Š"
        }
    }
}
```

### ä¿®æ”¹ AppDelegate / PackageTrakerApp

```swift
import FirebaseCore
import FirebaseMessaging

@main
struct PackageTrakerApp: App {
    @UIApplicationDelegateAdaptor(AppDelegate.self) var delegate

    init() {
        // Firebase åˆå§‹åŒ–ç§»åˆ° AppDelegate
    }
}

class AppDelegate: NSObject, UIApplicationDelegate {
    func application(
        _ application: UIApplication,
        didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?
    ) -> Bool {
        // åˆå§‹åŒ– Firebase
        FirebasePushService.shared.configure()

        // è¨­ç½®é€šçŸ¥ä»£ç†
        UNUserNotificationCenter.current().delegate = self

        return true
    }

    // æ¥æ”¶ APNs token
    func application(
        _ application: UIApplication,
        didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data
    ) {
        Messaging.messaging().apnsToken = deviceToken
    }
}

extension AppDelegate: UNUserNotificationCenterDelegate {
    // å‰æ™¯é€šçŸ¥é¡¯ç¤º
    func userNotificationCenter(
        _ center: UNUserNotificationCenter,
        willPresent notification: UNNotification,
        withCompletionHandler completionHandler: @escaping (UNNotificationPresentationOptions) -> Void
    ) {
        completionHandler([.banner, .sound])
    }

    // é€šçŸ¥é»æ“Šè™•ç†
    func userNotificationCenter(
        _ center: UNUserNotificationCenter,
        didReceive response: UNNotificationResponse,
        withCompletionHandler completionHandler: @escaping () -> Void
    ) {
        let userInfo = response.notification.request.content.userInfo

        // è™•ç†æ¨æ’­é»æ“Šï¼ˆä¾‹å¦‚è·³è½‰åˆ°ç‰¹å®šåŒ…è£¹ï¼‰
        if let packageId = userInfo["packageId"] as? String {
            // å°èˆªåˆ°åŒ…è£¹è©³æƒ…
            NotificationCenter.default.post(
                name: .openPackageDetail,
                object: nil,
                userInfo: ["packageId": packageId]
            )
        }

        completionHandler()
    }
}
```

---

## éƒ¨ç½²æµç¨‹

### Firebase CLI éƒ¨ç½²

```bash
# 1. å®‰è£ Firebase CLI
npm install -g firebase-tools

# 2. ç™»å…¥ Firebase
firebase login

# 3. åˆå§‹åŒ–å°ˆæ¡ˆ
cd functions
firebase init functions

# 4. å®‰è£ä¾è³´
npm install

# 5. éƒ¨ç½² Cloud Functions
firebase deploy --only functions

# 6. è¨­å®š Cloud Schedulerï¼ˆåœ¨ Firebase Console æˆ– GCP Consoleï¼‰
# æˆ–è€… Functions æœƒè‡ªå‹•å»ºç«‹ pubsub schedule
```

---

# Phase 4: iOS Widget æ”¯æ´ï¼ˆæœªä¾†ï¼‰

## Widget åˆ·æ–°æ©Ÿåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Widget åˆ·æ–°æµç¨‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚   1. Server åµæ¸¬åˆ°ç‹€æ…‹è®ŠåŒ–                                     â”‚
â”‚            â”‚                                                  â”‚
â”‚            â–¼                                                  â”‚
â”‚   2. ç™¼é€èƒŒæ™¯æ¨æ’­ (content-available: 1)                       â”‚
â”‚            â”‚                                                  â”‚
â”‚            â–¼                                                  â”‚
â”‚   3. iOS å–šé†’ App (èƒŒæ™¯)                                       â”‚
â”‚            â”‚                                                  â”‚
â”‚            â–¼                                                  â”‚
â”‚   4. App å‘¼å« WidgetCenter.shared.reloadAllTimelines()        â”‚
â”‚            â”‚                                                  â”‚
â”‚            â–¼                                                  â”‚
â”‚   5. Widget é‡æ–°è¼‰å…¥ Timeline                                  â”‚
â”‚            â”‚                                                  â”‚
â”‚            â–¼                                                  â”‚
â”‚   6. Widget å¾ App Group è®€å–æœ€æ–°è³‡æ–™                          â”‚
â”‚            â”‚                                                  â”‚
â”‚            â–¼                                                  â”‚
â”‚   7. Widget é¡¯ç¤ºæ›´æ–°                                           â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Widget è³‡æ–™å…±äº«

éœ€è¦è¨­å®š App Group è®“ä¸» App å’Œ Widget å…±äº«è³‡æ–™ï¼š

1. Xcode > Signing & Capabilities > + App Groups
2. å»ºç«‹ `group.com.yourname.PackageTraker`
3. Widget å’Œä¸» App éƒ½åŠ å…¥æ­¤ Group
4. ä½¿ç”¨ `UserDefaults(suiteName:)` æˆ– å…±äº« Core Data/SwiftData

---

## å¯¦æ–½é †åºå»ºè­°

| é †åº | é …ç›® | é è¨ˆæ™‚é–“ | å‚™è¨» |
|------|------|----------|------|
| 1 | Firebase å°ˆæ¡ˆè¨­ç½® | 1 å°æ™‚ | Console æ“ä½œ |
| 2 | APNs è¨­å®š | 30 åˆ†é˜ | Apple Developer + Firebase |
| 3 | Cloud Functions é–‹ç™¼ | 4 å°æ™‚ | TypeScript å¾Œç«¯ |
| 4 | iOS Firebase æ•´åˆ | 2 å°æ™‚ | SPM + ç¨‹å¼ç¢¼ |
| 5 | æ¸¬è©¦èˆ‡é™¤éŒ¯ | 2 å°æ™‚ | ç«¯åˆ°ç«¯æ¸¬è©¦ |
| 6 | Phase 2 æœ¬åœ°èƒŒæ™¯åˆ·æ–° | 1 å°æ™‚ | ä½œç‚ºè£œå…… |
| 7 | Widget é–‹ç™¼ | 4 å°æ™‚ | æœªä¾† |

**ç¸½é è¨ˆæ™‚é–“**: ç´„ 10-15 å°æ™‚ï¼ˆä¸å« Widgetï¼‰

---

## é—œéµæ–‡ä»¶æ¸…å–®

### Firebase å¾Œç«¯ï¼ˆæ–°å»ºï¼‰
```
functions/
â”œâ”€â”€ src/index.ts
â”œâ”€â”€ src/scheduled/trackingPoller.ts
â”œâ”€â”€ src/services/trackTwApi.ts
â”œâ”€â”€ src/services/pushNotification.ts
â””â”€â”€ src/utils/statusMapper.ts
```

### iOS Appï¼ˆæ–°å»ºï¼‰
```
PackageTraker/Services/
â”œâ”€â”€ Firebase/
â”‚   â””â”€â”€ FirebasePushService.swift
â””â”€â”€ Background/
    â””â”€â”€ BackgroundTrackingService.swift
```

### iOS Appï¼ˆä¿®æ”¹ï¼‰
```
PackageTraker/
â”œâ”€â”€ PackageTrakerApp.swift          // Firebase åˆå§‹åŒ–
â”œâ”€â”€ Info.plist                      // èƒŒæ™¯ä»»å‹™ ID
â”œâ”€â”€ FeatureFlags.swift              // é–‹é—œ
â””â”€â”€ GoogleService-Info.plist        // Firebase é…ç½®ï¼ˆæ–°å¢ï¼‰
```

---

# ä¹‹å‰å·²å®Œæˆçš„è¨ˆåŠƒï¼ˆè¨­å®šç•«é¢å®Œå–„ï¼‰

## å¯¦ç¾ç¯„åœ

### 1. ä¿®å¾©åŸºç¤å•é¡Œ
- âœ… ä¿®å¾©ç¡¬ç·¨ç¢¼å­—ç¬¦ä¸²ï¼ˆæ‡‰ç”¨åç¨±ã€ç‰ˆæœ¬å‰ç¶´ã€é–‹ç™¼è€…ä¿¡æ¯ï¼‰
- âœ… å®Œå–„æœ¬åœ°åŒ–ï¼ˆæ·»åŠ ç¼ºå¤±çš„æœ¬åœ°åŒ–éµåˆ° 3 ç¨®èªè¨€ï¼‰
- âœ… é€šçŸ¥è¨­å®šæŒä¹…åŒ–ï¼ˆå¾ `@State` æ”¹ç‚º `@AppStorage`ï¼‰
- âœ… é…ç½®çœŸå¯¦çš„åé¥‹éƒµç®±ï¼ˆkenny4work324@gmail.comï¼‰
- âœ… éš±ç§æ”¿ç­–æš«æ™‚ä½¿ç”¨åé¥‹éƒµç®±é€£çµï¼ˆé é¢å°šæœªå»ºç½®ï¼‰

### 2. å®Œå–„ç¾æœ‰åŠŸèƒ½
- âœ… **é€šçŸ¥åŠŸèƒ½**ï¼šå¯¦ç¾å®Œæ•´çš„æœ¬åœ°é€šçŸ¥ç³»çµ±
  - è«‹æ±‚ç³»çµ±é€šçŸ¥æ¬Šé™
  - åŒ…è£¹ç‹€æ…‹è®Šæ›´ç‚ºã€Œå·²åˆ°è²¨ã€æ™‚è‡ªå‹•æ¨é€é€šçŸ¥
  - æ¯æ—¥å–è²¨æé†’ï¼ˆé‡å°å·²åˆ°è²¨ä½†æœªå–ä»¶çš„åŒ…è£¹ï¼‰
  - é€šçŸ¥é–‹é—œèˆ‡ç³»çµ±æ¬Šé™è¯å‹•

- âœ… **æ¸…é™¤æ•¸æ“šåŠŸèƒ½**ï¼šå®Œæ•´æ¸…é™¤æ‰€æœ‰åŒ…è£¹æ•¸æ“š
  - æ¸…é™¤æ‰€æœ‰ Package è¨˜éŒ„
  - æ¸…é™¤æ‰€æœ‰ TrackingEvent è¨˜éŒ„
  - æ¸…é™¤ LinkedEmailAccountï¼ˆå·²æœ‰ï¼‰
  - **ä¿ç•™**ç”¨æˆ¶åå¥½è¨­å®šï¼ˆä¸»é¡Œé¡è‰²ã€æ›´æ–°é »ç‡ã€é€šçŸ¥è¨­å®šï¼‰
  - å–æ¶ˆæ‰€æœ‰å·²æ’ç¨‹çš„é€šçŸ¥
  - Gmail ç™»å‡ºï¼ˆå·²æœ‰ï¼‰

### 3. æ”¹é€²ç”¨æˆ¶é«”é©—
- âœ… æ”¹é€²èªè¨€è¨­ç½®ï¼ˆæ·»åŠ èªªæ˜æ–‡å­—ï¼‰
- âœ… æ”¹é€²éƒµä»¶åé¥‹æµç¨‹ï¼ˆæª¢æŸ¥éƒµä»¶å¯ç”¨æ€§ã€é™„åŠ æ›´å¤šç³»çµ±ä¿¡æ¯ï¼‰
- âœ… å„ªåŒ–ç‰ˆæœ¬é¡¯ç¤ºï¼ˆé¡¯ç¤º version + build numberï¼‰
- âœ… é€šçŸ¥æ¬Šé™ç‹€æ…‹æª¢æŸ¥èˆ‡æç¤º

### æ’é™¤ç¯„åœ
- âŒ ä¸å¯¦ç¾ API Token ç®¡ç†
- âŒ ä¸é–‹æ”¾éƒµä»¶è‡ªå‹•åŒ¯å…¥åŠŸèƒ½ï¼ˆå·²ç¦ç”¨ï¼‰

---

## æ¶æ§‹è¨­è¨ˆ

### é…ç½®ç®¡ç†
å‰µå»º `AppConfiguration.swift` çµ±ä¸€ç®¡ç†æ‡‰ç”¨å…ƒæ•¸æ“šï¼Œé¿å…ç¡¬ç·¨ç¢¼ï¼š
- æ‡‰ç”¨åç¨±ï¼ˆæœ¬åœ°åŒ–ï¼‰
- é–‹ç™¼è€…åç¨±ï¼ˆæœ¬åœ°åŒ–ï¼‰
- åé¥‹éƒµç®±ï¼ˆkenny4work324@gmail.comï¼‰
- ç‰ˆæœ¬è™Ÿèˆ‡ç·¨è­¯ç‰ˆæœ¬è™Ÿ

### é€šçŸ¥æœå‹™æ¶æ§‹
```
NotificationService (æ–°å»º)
  â”œâ”€ è«‹æ±‚ç³»çµ±é€šçŸ¥æ¬Šé™
  â”œâ”€ æ’ç¨‹æœ¬åœ°é€šçŸ¥
  â””â”€ æŸ¥è©¢æˆæ¬Šç‹€æ…‹

NotificationManager (æ–°å»º)
  â”œâ”€ è®€å–é€šçŸ¥åå¥½è¨­å®š (@AppStorage)
  â”œâ”€ æ±ºå®šä½•æ™‚ç™¼é€é€šçŸ¥
  â””â”€ å”èª¿ NotificationService èˆ‡ TrackingManager

TrackingManager (ä¿®æ”¹)
  â”œâ”€ åœ¨ track() ä¸­åµæ¸¬ç‹€æ…‹è®ŠåŒ–
  â””â”€ è§¸ç™¼ NotificationManager è™•ç†é€šçŸ¥
```

### æ•¸æ“šæ¸…é™¤ç­–ç•¥
- ä½¿ç”¨ SwiftData çš„ `modelContext.delete()` åˆªé™¤æ‰€æœ‰ Packageï¼ˆcascade è‡ªå‹•åˆªé™¤ TrackingEventï¼‰
- ä½¿ç”¨ `UNUserNotificationCenter.removeAllPendingNotificationRequests()` å–æ¶ˆé€šçŸ¥
- **ä¿ç•™** `@AppStorage` çš„ç”¨æˆ¶åå¥½ï¼ˆrefreshInterval, selectedTheme, é€šçŸ¥è¨­å®šï¼‰
- æ¸…é™¤ Gmail ç™»å…¥ç‹€æ…‹ï¼ˆå·²æœ‰ï¼‰

---

## éœ€è¦å‰µå»ºçš„æ–‡ä»¶

### 1. AppConfiguration.swift
**è·¯å¾‘**: `PackageTraker/Configuration/AppConfiguration.swift`

**ç›®çš„**: çµ±ä¸€ç®¡ç†æ‡‰ç”¨å…ƒæ•¸æ“šï¼Œé¿å…ç¡¬ç·¨ç¢¼

**å…§å®¹**:
```swift
import Foundation

struct AppConfiguration {
    // æ‡‰ç”¨åç¨±ï¼ˆæœ¬åœ°åŒ–ï¼‰
    static var appName: String {
        String(localized: "app.name")
    }

    // é–‹ç™¼è€…åç¨±ï¼ˆæœ¬åœ°åŒ–ï¼‰
    static var developerName: String {
        String(localized: "app.developer")
    }

    // åé¥‹éƒµç®±
    static let feedbackEmail = "kenny4work324@gmail.com"

    // ç‰ˆæœ¬è™Ÿ
    static var appVersion: String {
        Bundle.main.infoDictionary?["CFBundleShortVersionString"] as? String ?? "1.0.0"
    }

    // ç·¨è­¯ç‰ˆæœ¬è™Ÿ
    static var buildNumber: String {
        Bundle.main.infoDictionary?["CFBundleVersion"] as? String ?? "1"
    }

    // å®Œæ•´ç‰ˆæœ¬å­—ç¬¦ä¸²ï¼ˆç‰ˆæœ¬ + ç·¨è­¯ï¼‰
    static var fullVersionString: String {
        "\(appVersion) (\(buildNumber))"
    }
}
```

**æ³¨æ„**: éœ€è¦åœ¨ Xcode å°ˆæ¡ˆä¸­å‰µå»º `Configuration` ç›®éŒ„ä¸¦åŠ å…¥æ­¤æª”æ¡ˆ

---

### 2. NotificationService.swift
**è·¯å¾‘**: `PackageTraker/Services/Notification/NotificationService.swift`

**ç›®çš„**: è™•ç†ç³»çµ±é€šçŸ¥æ¬Šé™å’Œæ’ç¨‹æœ¬åœ°é€šçŸ¥

**å…§å®¹**:
```swift
import Foundation
import UserNotifications

/// é€šçŸ¥æœå‹™ï¼šè™•ç†ç³»çµ±é€šçŸ¥æ¬Šé™å’Œæ’ç¨‹
final class NotificationService {
    static let shared = NotificationService()

    private init() {}

    // MARK: - æ¬Šé™ç®¡ç†

    /// è«‹æ±‚é€šçŸ¥æ¬Šé™
    @MainActor
    func requestAuthorization() async -> Bool {
        do {
            let granted = try await UNUserNotificationCenter.current()
                .requestAuthorization(options: [.alert, .sound, .badge])
            return granted
        } catch {
            print("Request notification permission failed: \(error)")
            return false
        }
    }

    /// æŸ¥è©¢ç•¶å‰æˆæ¬Šç‹€æ…‹
    func getAuthorizationStatus() async -> UNAuthorizationStatus {
        await UNUserNotificationCenter.current().notificationSettings().authorizationStatus
    }

    // MARK: - æ’ç¨‹é€šçŸ¥

    /// æ’ç¨‹åˆ°è²¨é€šçŸ¥
    func scheduleArrivalNotification(for package: Package) {
        let content = UNMutableNotificationContent()
        content.title = String(localized: "notification.arrival.title")

        // é€šçŸ¥å…§å®¹ï¼šã€Œ[å“å] å·²åˆ°é” [å–è²¨åœ°é»]ï¼Œè«‹å„˜å¿«å–è²¨ã€
        let locationText = package.pickupLocation ?? String(localized: "notification.defaultLocation")
        content.body = String(format: String(localized: "notification.arrival.body"),
                             package.itemName ?? package.trackingNumber,
                             locationText)
        content.sound = .default

        // ç«‹å³è§¸ç™¼
        let trigger = UNTimeIntervalNotificationTrigger(timeInterval: 1, repeats: false)
        let identifier = "arrival-\(package.id.uuidString)"
        let request = UNNotificationRequest(identifier: identifier, content: content, trigger: trigger)

        UNUserNotificationCenter.current().add(request) { error in
            if let error = error {
                print("Schedule arrival notification failed: \(error)")
            }
        }
    }

    /// æ’ç¨‹å–è²¨æé†’ï¼ˆæ¯æ—¥å®šæ™‚æé†’ï¼‰
    func schedulePickupReminder(for packages: [Package]) {
        guard !packages.isEmpty else { return }

        let content = UNMutableNotificationContent()
        content.title = String(localized: "notification.pickup.title")
        content.body = String(format: String(localized: "notification.pickup.body"), packages.count)
        content.sound = .default

        // æ¯æ—¥æ—©ä¸Š 10:00 æé†’
        var dateComponents = DateComponents()
        dateComponents.hour = 10
        dateComponents.minute = 0

        let trigger = UNCalendarNotificationTrigger(dateMatching: dateComponents, repeats: true)
        let identifier = "daily-pickup-reminder"
        let request = UNNotificationRequest(identifier: identifier, content: content, trigger: trigger)

        UNUserNotificationCenter.current().add(request) { error in
            if let error = error {
                print("Schedule pickup reminder failed: \(error)")
            }
        }
    }

    /// å–æ¶ˆç‰¹å®šåŒ…è£¹çš„æ‰€æœ‰é€šçŸ¥
    func cancelNotifications(for package: Package) {
        let identifier = "arrival-\(package.id.uuidString)"
        UNUserNotificationCenter.current().removePendingNotificationRequests(withIdentifiers: [identifier])
    }

    /// å–æ¶ˆæ‰€æœ‰é€šçŸ¥
    func cancelAllNotifications() {
        UNUserNotificationCenter.current().removeAllPendingNotificationRequests()
        UNUserNotificationCenter.current().removeAllDeliveredNotifications()
    }
}
```

**æ³¨æ„**: éœ€è¦åœ¨ Xcode å°ˆæ¡ˆä¸­å‰µå»º `Services/Notification` ç›®éŒ„ä¸¦åŠ å…¥æ­¤æª”æ¡ˆ

---

### 3. NotificationManager.swift
**è·¯å¾‘**: `PackageTraker/Services/Notification/NotificationManager.swift`

**ç›®çš„**: å”èª¿é€šçŸ¥é‚è¼¯ï¼Œæ±ºå®šä½•æ™‚ç™¼é€é€šçŸ¥

**å…§å®¹**:
```swift
import Foundation
import SwiftUI

/// é€šçŸ¥ç®¡ç†å™¨ï¼šå”èª¿é€šçŸ¥é‚è¼¯èˆ‡ç”¨æˆ¶åå¥½
@MainActor
final class NotificationManager: ObservableObject {
    static let shared = NotificationManager()

    // é€šçŸ¥åå¥½è¨­å®šï¼ˆæŒä¹…åŒ–ï¼‰
    @AppStorage("notificationsEnabled") var notificationsEnabled = false
    @AppStorage("arrivalNotificationEnabled") var arrivalNotificationEnabled = false
    @AppStorage("pickupReminderEnabled") var pickupReminderEnabled = false

    private let notificationService = NotificationService.shared

    private init() {}

    // MARK: - åŒ…è£¹ç‹€æ…‹è®ŠåŒ–è™•ç†

    /// è™•ç†åŒ…è£¹ç‹€æ…‹è®ŠåŒ–
    func handleStatusChange(package: Package, oldStatus: TrackingStatus, newStatus: TrackingStatus) {
        // æª¢æŸ¥æ˜¯å¦å•Ÿç”¨é€šçŸ¥
        guard notificationsEnabled, arrivalNotificationEnabled else { return }

        // åµæ¸¬åˆ°è²¨ï¼šå¾éåˆ°è²¨ç‹€æ…‹ -> å·²åˆ°è²¨ç‹€æ…‹
        if !oldStatus.isPendingPickup && newStatus.isPendingPickup {
            Task {
                let status = await notificationService.getAuthorizationStatus()
                guard status == .authorized else { return }

                notificationService.scheduleArrivalNotification(for: package)
            }
        }
    }

    // MARK: - æ¯æ—¥å–è²¨æé†’

    /// æ›´æ–°æ¯æ—¥å–è²¨æé†’
    func updateDailyPickupReminder(packages: [Package]) {
        // å…ˆå–æ¶ˆèˆŠçš„æé†’
        UNUserNotificationCenter.current().removePendingNotificationRequests(withIdentifiers: ["daily-pickup-reminder"])

        // æª¢æŸ¥æ˜¯å¦å•Ÿç”¨
        guard notificationsEnabled, pickupReminderEnabled else { return }

        Task {
            let status = await notificationService.getAuthorizationStatus()
            guard status == .authorized else { return }

            // ç¯©é¸å¾…å–ä»¶çš„åŒ…è£¹
            let pendingPackages = packages.filter { $0.status.isPendingPickup && !$0.isArchived }

            if !pendingPackages.isEmpty {
                notificationService.schedulePickupReminder(for: pendingPackages)
            }
        }
    }
}
```

**æ³¨æ„**: éœ€è¦åœ¨ Xcode å°ˆæ¡ˆä¸­å‰µå»º `Services/Notification` ç›®éŒ„ä¸¦åŠ å…¥æ­¤æª”æ¡ˆ

---

## éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

### 4. SettingsView.swift
**è·¯å¾‘**: `PackageTraker/Views/Settings/SettingsView.swift`

**ä¸»è¦ä¿®æ”¹**:

#### A. ç§»é™¤ç¡¬ç·¨ç¢¼å¸¸æ•¸ï¼ˆç¬¬ 54-57 è¡Œï¼‰
```swift
// åˆªé™¤é€™äº›ç¡¬ç·¨ç¢¼
private let appName = "å–è²¨å§"
private let appVersion = ...
private let developerName = "Kenny"
private let feedbackEmail = "kenny@example.com"

// æ”¹ç”¨ AppConfiguration
// ï¼ˆåœ¨éœ€è¦çš„åœ°æ–¹ç›´æ¥ä½¿ç”¨ AppConfiguration.appName ç­‰ï¼‰
```

#### B. é€šçŸ¥è¨­å®šæ”¹ç‚ºæŒä¹…åŒ–ï¼ˆç¬¬ 47-49 è¡Œï¼‰
```swift
// ä¿®æ”¹å‰
@State private var notificationsEnabled = true
@State private var arrivalNotificationEnabled = true
@State private var pickupReminderEnabled = true

// ä¿®æ”¹å¾Œ
@AppStorage("notificationsEnabled") private var notificationsEnabled = false
@AppStorage("arrivalNotificationEnabled") private var arrivalNotificationEnabled = false
@AppStorage("pickupReminderEnabled") private var pickupReminderEnabled = false
```

#### C. æ·»åŠ é€šçŸ¥æ¬Šé™æª¢æŸ¥
```swift
// åœ¨ body é–‹é ­æ·»åŠ 
.onAppear {
    checkNotificationPermission()
}

// æ·»åŠ æ–¹æ³•
private func checkNotificationPermission() {
    Task {
        let status = await NotificationService.shared.getAuthorizationStatus()
        if status == .denied && notificationsEnabled {
            // é¡¯ç¤ºè­¦å‘Šï¼šé€šçŸ¥æ¬Šé™å·²é—œé–‰
            notificationPermissionDenied = true
        }
    }
}
```

#### D. é€šçŸ¥é–‹é—œè™•ç†
```swift
// notificationsEnabled çš„ onChange
.onChange(of: notificationsEnabled) { oldValue, newValue in
    if newValue && !oldValue {
        // ç”¨æˆ¶æ‰“é–‹é€šçŸ¥ï¼Œè«‹æ±‚æ¬Šé™
        Task {
            let granted = await NotificationService.shared.requestAuthorization()
            if !granted {
                notificationsEnabled = false
                showNotificationDeniedAlert = true
            }
        }
    } else if !newValue && oldValue {
        // ç”¨æˆ¶é—œé–‰é€šçŸ¥ï¼Œå–æ¶ˆæ‰€æœ‰é€šçŸ¥
        NotificationService.shared.cancelAllNotifications()
    }
}
```

#### E. ç‰ˆæœ¬é¡¯ç¤ºæ”¹é€²ï¼ˆç¬¬ 120 è¡Œé™„è¿‘ï¼‰
```swift
// ä¿®æ”¹å‰
Text("Version \(appVersion)")

// ä¿®æ”¹å¾Œ
VStack(alignment: .leading, spacing: 2) {
    Text(AppConfiguration.appName)
        .font(.headline)
        .foregroundStyle(.white)
    Text("\(String(localized: "app.versionPrefix")) \(AppConfiguration.fullVersionString)")
        .font(.subheadline)
        .foregroundStyle(.secondary)
}
```

#### F. éš±ç§æ”¿ç­–é€£çµæ”¹ç‚ºéƒµä»¶ï¼ˆç¬¬ 172 è¡Œé™„è¿‘ï¼‰
```swift
// ä¿®æ”¹å‰
Link(destination: URL(string: "https://example.com/privacy")!) {
    settingsRow(...)
}

// ä¿®æ”¹å¾Œï¼ˆä½¿ç”¨éƒµä»¶ä»£æ›¿ï¼Œå› ç‚ºéš±ç§æ”¿ç­–é é¢å°šæœªå»ºç½®ï¼‰
Button {
    openPrivacyEmail()
} label: {
    settingsRow(
        icon: "lock.shield",
        title: String(localized: "settings.privacyPolicy"),
        color: .purple
    )
}

// æ·»åŠ æ–¹æ³•
private func openPrivacyEmail() {
    let subject = String(format: String(localized: "email.privacyInquiry"), AppConfiguration.appName)
    guard let url = URL(string: "mailto:\(AppConfiguration.feedbackEmail)?subject=\(subject.addingPercentEncoding(withAllowedCharacters: .urlQueryAllowed) ?? "")") else { return }
    UIApplication.shared.open(url)
}
```

#### G. åé¥‹éƒµä»¶æ”¹é€²ï¼ˆç¬¬ 438-445 è¡Œé™„è¿‘ï¼‰
```swift
private func openFeedbackEmail() {
    // ç³»çµ±ä¿¡æ¯
    let systemInfo = """


    ---
    \(String(localized: "email.systemInfo")):
    App: \(AppConfiguration.appName)
    Version: \(AppConfiguration.fullVersionString)
    iOS: \(UIDevice.current.systemVersion)
    Device: \(UIDevice.current.model) (\(UIDevice.current.name))
    Language: \(Locale.preferredLanguages.first ?? "Unknown")
    """

    let subject = String(format: String(localized: "email.feedbackSubject"), AppConfiguration.appName)
    let body = systemInfo.addingPercentEncoding(withAllowedCharacters: .urlQueryAllowed) ?? ""
    let subjectEncoded = subject.addingPercentEncoding(withAllowedCharacters: .urlQueryAllowed) ?? ""

    guard let url = URL(string: "mailto:\(AppConfiguration.feedbackEmail)?subject=\(subjectEncoded)&body=\(body)") else {
        showFeedbackError = true
        return
    }

    UIApplication.shared.open(url) { success in
        if !success {
            showFeedbackError = true
        }
    }
}

// æ·»åŠ éŒ¯èª¤æç¤º
@State private var showFeedbackError = false

.alert(String(localized: "email.cannotOpenTitle"), isPresented: $showFeedbackError) {
    Button(String(localized: "common.ok"), role: .cancel) {}
} message: {
    Text(String(localized: "email.cannotOpenMessage") + " \(AppConfiguration.feedbackEmail)")
}
```

#### H. æ¸…é™¤æ•¸æ“šåŠŸèƒ½å®Œå–„ï¼ˆç¬¬ 447-457 è¡Œé™„è¿‘ï¼‰
```swift
private func clearAllData() {
    do {
        // 1. åˆªé™¤æ‰€æœ‰åŒ…è£¹ï¼ˆcascade æœƒè‡ªå‹•åˆªé™¤ TrackingEventï¼‰
        let packageDescriptor = FetchDescriptor<Package>()
        let allPackages = try modelContext.fetch(packageDescriptor)
        for package in allPackages {
            modelContext.delete(package)
        }

        // 2. åˆªé™¤æ‰€æœ‰ LinkedEmailAccount
        for account in linkedAccounts {
            modelContext.delete(account)
        }

        try modelContext.save()

        // 3. Gmail ç™»å‡º
        gmailAuthManager.signOut()

        // 4. å–æ¶ˆæ‰€æœ‰é€šçŸ¥
        NotificationService.shared.cancelAllNotifications()

        // 5. ä¸æ¸…é™¤ç”¨æˆ¶åå¥½ï¼ˆä¿ç•™ refreshInterval, selectedTheme, é€šçŸ¥è¨­å®šï¼‰

        // 6. é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        showClearDataSuccess = true

    } catch {
        print("Clear all data failed: \(error)")
        lastError = String(localized: "settings.clearDataFailed")
    }
}

// æ·»åŠ æˆåŠŸæç¤º
@State private var showClearDataSuccess = false

.alert(String(localized: "settings.clearDataSuccess"), isPresented: $showClearDataSuccess) {
    Button(String(localized: "common.ok"), role: .cancel) {}
}
```

#### I. èªè¨€è¨­ç½®æ·»åŠ æç¤ºï¼ˆåœ¨èªè¨€è¨­ç½®è¡Œä¸‹æ–¹ï¼‰
```swift
// åœ¨èªè¨€è¨­ç½®çš„ settingsRow å¾Œé¢æ·»åŠ 
Text(String(localized: "settings.languageHint"))
    .font(.caption)
    .foregroundStyle(.secondary)
    .padding(.horizontal)
    .padding(.top, -8)
```

---

### 5. TrackingManager.swift
**è·¯å¾‘**: `PackageTraker/Services/TrackingManager.swift`

**ä¿®æ”¹ä½ç½®**: åœ¨ `track(package:)` æ–¹æ³•ä¸­æ·»åŠ ç‹€æ…‹è®ŠåŒ–åµæ¸¬

**ä¿®æ”¹å…§å®¹**:
```swift
/// è¿½è¹¤å–®ä¸€åŒ…è£¹ï¼ˆå‚³å…¥ Package ç‰©ä»¶ï¼Œè‡ªå‹•è¼‰å…¥ relation ID å¿«å–ï¼‰
func track(package: Package) async throws -> TrackingResult {
    // è¨˜éŒ„èˆŠç‹€æ…‹
    let oldStatus = package.status

    // è¼‰å…¥å·²å„²å­˜çš„ relation IDï¼Œé¿å…é‡è¤‡ import
    if let relationId = package.trackTwRelationId {
        apiService.setRelationId(relationId, for: package.trackingNumber)
    }

    let result = try await track(number: package.trackingNumber, carrier: package.carrier)

    // åµæ¸¬ç‹€æ…‹è®ŠåŒ–ï¼Œè§¸ç™¼é€šçŸ¥
    if oldStatus != result.status {
        NotificationManager.shared.handleStatusChange(
            package: package,
            oldStatus: oldStatus,
            newStatus: result.status
        )
    }

    return result
}
```

**æ³¨æ„**: éœ€è¦åœ¨æ–‡ä»¶é–‹é ­ import NotificationManagerï¼ˆæˆ–ç›´æ¥ä½¿ç”¨ï¼Œå› ç‚ºåœ¨åŒä¸€æ¨¡çµ„ï¼‰

---

### 6. PackageTrakerApp.swift
**è·¯å¾‘**: `PackageTraker/PackageTrakerApp.swift`

**ä¿®æ”¹å…§å®¹**: åœ¨ `init()` ä¸­è¨­ç½®é€šçŸ¥ä»£ç†å’Œæ¯æ—¥æé†’

```swift
import UserNotifications

@main
struct PackageTrakerApp: App {

    init() {
        // è¨­ç½®é€šçŸ¥ä¸­å¿ƒä»£ç†
        UNUserNotificationCenter.current().delegate = NotificationDelegate.shared

        // æ’ç¨‹æ¯æ—¥å–è²¨æé†’ï¼ˆéœ€è¦åœ¨èƒŒæ™¯ä»»å‹™ä¸­è™•ç†ï¼‰
        scheduleBackgroundTasks()
    }

    var body: some Scene {
        WindowGroup {
            ContentView()
                .preferredColorScheme(.dark)
                .modelContainer(for: [Package.self, TrackingEvent.self, LinkedEmailAccount.self])
        }
    }

    private func scheduleBackgroundTasks() {
        // æ¯æ—¥æ›´æ–°å–è²¨æé†’ï¼ˆä½¿ç”¨ BGAppRefreshTaskï¼‰
        // ç”±æ–¼ NotificationManager éœ€è¦ @MainActorï¼Œåœ¨æ­¤åªè¨»å†Šä»»å‹™
        // å¯¦éš›è™•ç†åœ¨ AppDelegate æˆ– SceneDelegate ä¸­
    }
}

// é€šçŸ¥ä»£ç†ï¼ˆè™•ç†å‰æ™¯é€šçŸ¥é¡¯ç¤ºï¼‰
class NotificationDelegate: NSObject, UNUserNotificationCenterDelegate {
    static let shared = NotificationDelegate()

    func userNotificationCenter(
        _ center: UNUserNotificationCenter,
        willPresent notification: UNNotification,
        withCompletionHandler completionHandler: @escaping (UNNotificationPresentationOptions) -> Void
    ) {
        // åœ¨å‰æ™¯ä¹Ÿé¡¯ç¤ºé€šçŸ¥
        completionHandler([.banner, .sound])
    }
}
```

**æ³¨æ„**: å–è²¨æé†’çš„èƒŒæ™¯ä»»å‹™å·²åœ¨ç¾æœ‰çš„ BGAppRefreshTask ä¸­è¨»å†Šï¼Œå¯ä»¥åœ¨è©²ä»»å‹™ä¸­èª¿ç”¨ `NotificationManager.shared.updateDailyPickupReminder(packages:)`

---

### 7. æœ¬åœ°åŒ–æ–‡ä»¶
**è·¯å¾‘**:
- `PackageTraker/en.lproj/Localizable.strings`
- `PackageTraker/zh-Hant.lproj/Localizable.strings`
- `PackageTraker/zh-Hans.lproj/Localizable.strings`

**éœ€è¦æ·»åŠ çš„éµ**ï¼ˆä»¥ç¹é«”ä¸­æ–‡ç‚ºä¾‹ï¼‰:

```strings
// App Configuration
"app.name" = "å–è²¨å§";
"app.developer" = "Kenny";
"app.versionPrefix" = "ç‰ˆæœ¬";

// Settings Enhancements
"settings.languageHint" = "èªè¨€è¨­å®šéœ€è‡³ç³»çµ±è¨­å®šä¿®æ”¹";
"settings.notificationPermissionDenied" = "é€šçŸ¥æ¬Šé™å·²é—œé–‰";
"settings.notificationPermissionDeniedMessage" = "è«‹å‰å¾€ã€Œè¨­å®š > å–è²¨å§ > é€šçŸ¥ã€é–‹å•Ÿé€šçŸ¥æ¬Šé™";
"settings.clearDataSuccess" = "å·²æ¸…é™¤æ‰€æœ‰è³‡æ–™";
"settings.clearDataFailed" = "æ¸…é™¤è³‡æ–™å¤±æ•—";

// Notifications
"notification.arrival.title" = "åŒ…è£¹å·²åˆ°è²¨";
"notification.arrival.body" = "%@ å·²åˆ°é” %@ï¼Œè«‹å„˜å¿«å–è²¨";
"notification.pickup.title" = "å–è²¨æé†’";
"notification.pickup.body" = "æ‚¨æœ‰ %d å€‹åŒ…è£¹å¾…å–ï¼Œåˆ¥å¿˜äº†å»é ˜å–å–”ï¼";
"notification.defaultLocation" = "å–è²¨åœ°é»";

// Email
"email.feedbackSubject" = "[%@] å•é¡Œå›å ±";
"email.privacyInquiry" = "[%@] éš±ç§æ”¿ç­–è©¢å•";
"email.systemInfo" = "ç³»çµ±è³‡è¨Š";
"email.cannotOpenTitle" = "ç„¡æ³•é–‹å•Ÿéƒµä»¶";
"email.cannotOpenMessage" = "è«‹ç¢ºèªå·²å®‰è£éƒµä»¶ Appï¼Œæˆ–ç›´æ¥ç™¼é€éƒµä»¶è‡³";
```

**å°æ‡‰çš„è‹±æ–‡ç‰ˆæœ¬** (`en.lproj/Localizable.strings`):
```strings
"app.name" = "Pickup";
"app.developer" = "Kenny";
"app.versionPrefix" = "Version";
"settings.languageHint" = "Language settings require system preferences";
"settings.notificationPermissionDenied" = "Notification permission denied";
"settings.notificationPermissionDeniedMessage" = "Please go to Settings > Pickup > Notifications to enable notifications";
"settings.clearDataSuccess" = "All data cleared";
"settings.clearDataFailed" = "Failed to clear data";
"notification.arrival.title" = "Package Arrived";
"notification.arrival.body" = "%@ has arrived at %@, please pick up soon";
"notification.pickup.title" = "Pickup Reminder";
"notification.pickup.body" = "You have %d packages waiting for pickup!";
"notification.defaultLocation" = "pickup location";
"email.feedbackSubject" = "[%@] Feedback";
"email.privacyInquiry" = "[%@] Privacy Inquiry";
"email.systemInfo" = "System Information";
"email.cannotOpenTitle" = "Cannot Open Mail";
"email.cannotOpenMessage" = "Please make sure Mail app is installed, or send email to";
```

**å°æ‡‰çš„ç°¡é«”ä¸­æ–‡ç‰ˆæœ¬** (`zh-Hans.lproj/Localizable.strings`):
```strings
"app.name" = "å–è´§å§";
"app.developer" = "Kenny";
"app.versionPrefix" = "ç‰ˆæœ¬";
"settings.languageHint" = "è¯­è¨€è®¾ç½®éœ€è‡³ç³»ç»Ÿè®¾ç½®ä¿®æ”¹";
"settings.notificationPermissionDenied" = "é€šçŸ¥æƒé™å·²å…³é—­";
"settings.notificationPermissionDeniedMessage" = "è¯·å‰å¾€ã€Œè®¾ç½® > å–è´§å§ > é€šçŸ¥ã€å¼€å¯é€šçŸ¥æƒé™";
"settings.clearDataSuccess" = "å·²æ¸…é™¤æ‰€æœ‰èµ„æ–™";
"settings.clearDataFailed" = "æ¸…é™¤èµ„æ–™å¤±è´¥";
"notification.arrival.title" = "åŒ…è£¹å·²åˆ°è´§";
"notification.arrival.body" = "%@ å·²åˆ°è¾¾ %@ï¼Œè¯·å°½å¿«å–è´§";
"notification.pickup.title" = "å–è´§æé†’";
"notification.pickup.body" = "æ‚¨æœ‰ %d ä¸ªåŒ…è£¹å¾…å–ï¼Œåˆ«å¿˜äº†å»é¢†å–å“¦ï¼";
"notification.defaultLocation" = "å–è´§åœ°ç‚¹";
"email.feedbackSubject" = "[%@] é—®é¢˜å›æŠ¥";
"email.privacyInquiry" = "[%@] éšç§æ”¿ç­–è¯¢é—®";
"email.systemInfo" = "ç³»ç»Ÿèµ„è®¯";
"email.cannotOpenTitle" = "æ— æ³•å¼€å¯é‚®ä»¶";
"email.cannotOpenMessage" = "è¯·ç¡®è®¤å·²å®‰è£…é‚®ä»¶ Appï¼Œæˆ–ç›´æ¥å‘é€é‚®ä»¶è‡³";
```

---

### 8. Info.plist
**è·¯å¾‘**: `PackageTraker/Info.plist`

**æ·»åŠ å…§å®¹**: é€šçŸ¥æ¬Šé™ä½¿ç”¨èªªæ˜

```xml
<key>NSUserNotificationsUsageDescription</key>
<string>æˆ‘å€‘éœ€è¦é€šçŸ¥æ¬Šé™ä¾†æé†’æ‚¨åŒ…è£¹åˆ°è²¨å’Œå–è²¨</string>
```

**æ³¨æ„**: é€™å€‹å­—ç¬¦ä¸²æœƒé¡¯ç¤ºåœ¨ç³»çµ±æ¬Šé™è«‹æ±‚å°è©±æ¡†ä¸­

---

## å¯¦ç¾æ­¥é©Ÿ

### Phase 1: åŸºç¤é…ç½®ï¼ˆ30 åˆ†é˜ï¼‰
1. å‰µå»º `Configuration/` ç›®éŒ„ï¼Œæ·»åŠ  `AppConfiguration.swift`
2. å‰µå»º `Services/Notification/` ç›®éŒ„
3. æ·»åŠ æ‰€æœ‰æœ¬åœ°åŒ–éµåˆ° 3 å€‹ `.strings` æ–‡ä»¶
4. æ›´æ–° `Info.plist` æ·»åŠ é€šçŸ¥æ¬Šé™èªªæ˜

### Phase 2: é€šçŸ¥æœå‹™å¯¦ç¾ï¼ˆ45 åˆ†é˜ï¼‰
1. å‰µå»º `NotificationService.swift`ï¼ˆæ¬Šé™ + æ’ç¨‹ï¼‰
2. å‰µå»º `NotificationManager.swift`ï¼ˆæ¥­å‹™é‚è¼¯ï¼‰
3. æ¸¬è©¦é€šçŸ¥æ’ç¨‹åŠŸèƒ½ï¼ˆå¯åœ¨æ¨¡æ“¬å™¨æ¸¬è©¦ï¼‰

### Phase 3: SettingsView æ•´åˆï¼ˆ60 åˆ†é˜ï¼‰
1. ç§»é™¤ç¡¬ç·¨ç¢¼ï¼Œä½¿ç”¨ `AppConfiguration`
2. é€šçŸ¥è¨­å®šæ”¹ç‚º `@AppStorage`
3. æ·»åŠ é€šçŸ¥æ¬Šé™æª¢æŸ¥å’Œè«‹æ±‚é‚è¼¯
4. å¯¦ç¾é€šçŸ¥é–‹é—œçš„ `onChange` è™•ç†
5. æ”¹é€²ç‰ˆæœ¬é¡¯ç¤º
6. éš±ç§æ”¿ç­–æ”¹ç‚ºéƒµä»¶é€£çµ
7. æ”¹é€²åé¥‹éƒµä»¶æµç¨‹ï¼ˆç³»çµ±ä¿¡æ¯ + éŒ¯èª¤è™•ç†ï¼‰
8. å®Œå–„æ¸…é™¤æ•¸æ“šåŠŸèƒ½
9. æ·»åŠ èªè¨€è¨­ç½®æç¤º

### Phase 4: TrackingManager æ•´åˆï¼ˆ15 åˆ†é˜ï¼‰
1. ä¿®æ”¹ `track(package:)` æ–¹æ³•
2. æ·»åŠ ç‹€æ…‹è®ŠåŒ–åµæ¸¬
3. è§¸ç™¼ `NotificationManager.handleStatusChange()`

### Phase 5: App ç´šåˆ¥é…ç½®ï¼ˆ15 åˆ†é˜ï¼‰
1. ä¿®æ”¹ `PackageTrakerApp.swift`
2. è¨­ç½®é€šçŸ¥ä»£ç†
3. é…ç½®èƒŒæ™¯ä»»å‹™ï¼ˆå–è²¨æé†’ï¼‰

### Phase 6: æ¸¬è©¦èˆ‡é©—è­‰ï¼ˆ30 åˆ†é˜ï¼‰
1. æ¸¬è©¦é€šçŸ¥æ¬Šé™è«‹æ±‚æµç¨‹
2. æ¸¬è©¦åŒ…è£¹åˆ°è²¨é€šçŸ¥ï¼ˆæ¨¡æ“¬ç‹€æ…‹è®ŠåŒ–ï¼‰
3. æ¸¬è©¦æ¸…é™¤æ•¸æ“šåŠŸèƒ½
4. æ¸¬è©¦åé¥‹éƒµä»¶å’Œéš±ç§æ”¿ç­–éƒµä»¶
5. æ¸¬è©¦ 3 ç¨®èªè¨€çš„æœ¬åœ°åŒ–
6. æ¸¬è©¦ç‰ˆæœ¬è™Ÿé¡¯ç¤º

**ç¸½é è¨ˆæ™‚é–“**: ç´„ 3 å°æ™‚

---

## é©—è­‰æ–¹æ³•

### 1. é€šçŸ¥åŠŸèƒ½é©—è­‰
- [ ] æ‰“é–‹è¨­å®šç•«é¢çš„é€šçŸ¥ç¸½é–‹é—œï¼Œç¢ºèªç³»çµ±å½ˆå‡ºæ¬Šé™è«‹æ±‚
- [ ] æˆäºˆæ¬Šé™å¾Œï¼Œé–‹é—œä¿æŒé–‹å•Ÿç‹€æ…‹
- [ ] æ‹’çµ•æ¬Šé™å¾Œï¼Œé–‹é—œè‡ªå‹•é—œé–‰ä¸¦é¡¯ç¤ºè­¦å‘Š
- [ ] åœ¨ PackageListView æ‰‹å‹•æ›´æ–°åŒ…è£¹ï¼Œå°‡ç‹€æ…‹æ”¹ç‚ºã€Œå·²åˆ°è²¨ã€
- [ ] ç¢ºèªæ”¶åˆ°åˆ°è²¨é€šçŸ¥ï¼ˆæ¨¡æ“¬å™¨ï¼šSimulator > Debug > Trigger Local Notificationï¼‰
- [ ] æª¢æŸ¥é€šçŸ¥å…§å®¹åŒ…å«å“åå’Œå–è²¨åœ°é»
- [ ] é‡æ–°å•Ÿå‹• Appï¼Œç¢ºèªé€šçŸ¥è¨­å®šå·²æŒä¹…åŒ–

### 2. æ¸…é™¤æ•¸æ“šåŠŸèƒ½é©—è­‰
- [ ] æ·»åŠ å¹¾å€‹æ¸¬è©¦åŒ…è£¹å’Œè¿½è¹¤è¨˜éŒ„
- [ ] è¨­å®šä¸»é¡Œé¡è‰²ç‚ºéé»˜èªå€¼ï¼ˆä¾‹å¦‚ï¼šOcean Blueï¼‰
- [ ] è¨­å®šæ›´æ–°é »ç‡ç‚ºéé»˜èªå€¼ï¼ˆä¾‹å¦‚ï¼š1 hourï¼‰
- [ ] åŸ·è¡Œã€Œæ¸…é™¤æ‰€æœ‰è³‡æ–™ã€
- [ ] ç¢ºèªæ‰€æœ‰åŒ…è£¹å’Œè¿½è¹¤è¨˜éŒ„å·²åˆªé™¤
- [ ] ç¢ºèªä¸»é¡Œé¡è‰²å’Œæ›´æ–°é »ç‡è¨­å®šä»ä¿ç•™
- [ ] ç¢ºèªé€šçŸ¥è¨­å®šä»ä¿ç•™

### 3. æœ¬åœ°åŒ–é©—è­‰
- [ ] åˆ‡æ›ç³»çµ±èªè¨€ç‚ºç¹é«”ä¸­æ–‡ï¼Œç¢ºèªæ‰€æœ‰æ–‡å­—æ­£ç¢ºé¡¯ç¤º
- [ ] åˆ‡æ›ç‚ºç°¡é«”ä¸­æ–‡ï¼Œç¢ºèªæ‰€æœ‰æ–‡å­—æ­£ç¢ºé¡¯ç¤º
- [ ] åˆ‡æ›ç‚ºè‹±æ–‡ï¼Œç¢ºèªæ‰€æœ‰æ–‡å­—æ­£ç¢ºé¡¯ç¤º
- [ ] ç‰¹åˆ¥æª¢æŸ¥æ‡‰ç”¨åç¨±ã€ç‰ˆæœ¬å‰ç¶´ã€é€šçŸ¥å…§å®¹ã€éƒµä»¶ä¸»é¡Œ

### 4. UI/UX é©—è­‰
- [ ] ç‰ˆæœ¬è™Ÿé¡¯ç¤ºæ ¼å¼ç‚ºã€Œç‰ˆæœ¬ 1.0.0 (1)ã€
- [ ] é»æ“Šåé¥‹æŒ‰éˆ•ï¼Œç¢ºèªé–‹å•Ÿéƒµä»¶ App ä¸¦åŒ…å«ç³»çµ±ä¿¡æ¯
- [ ] é»æ“Šéš±ç§æ”¿ç­–ï¼Œç¢ºèªé–‹å•Ÿéƒµä»¶ Appï¼ˆæš«æ™‚æ–¹æ¡ˆï¼‰
- [ ] èªè¨€è¨­ç½®ä¸‹æ–¹é¡¯ç¤ºæç¤ºæ–‡å­—
- [ ] é€šçŸ¥æ¬Šé™è¢«æ‹’çµ•æ™‚é¡¯ç¤ºè­¦å‘Šè¨Šæ¯

### 5. æ•´åˆæ¸¬è©¦
- [ ] æ¨¡æ“¬å®Œæ•´æµç¨‹ï¼šæ–°å¢åŒ…è£¹ â†’ è¿½è¹¤ â†’ ç‹€æ…‹è®Šç‚ºå·²åˆ°è²¨ â†’ æ”¶åˆ°é€šçŸ¥
- [ ] æ¸¬è©¦å¤šå€‹åŒ…è£¹åŒæ™‚åˆ°è²¨çš„æƒ…æ³
- [ ] æ¸¬è©¦é—œé–‰é€šçŸ¥å¾Œä¸å†æ”¶åˆ°é€šçŸ¥
- [ ] æ¸¬è©¦æ¸…é™¤æ•¸æ“šå¾Œé€šçŸ¥è¢«å–æ¶ˆ

---

## é—œéµæ–‡ä»¶æ¸…å–®

### éœ€è¦å‰µå»ºçš„æ–‡ä»¶
1. `PackageTraker/Configuration/AppConfiguration.swift` - æ‡‰ç”¨é…ç½®
2. `PackageTraker/Services/Notification/NotificationService.swift` - é€šçŸ¥æœå‹™
3. `PackageTraker/Services/Notification/NotificationManager.swift` - é€šçŸ¥ç®¡ç†

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶
1. `PackageTraker/Views/Settings/SettingsView.swift` - ä¸»è¦ä¿®æ”¹ï¼ˆç´„ 200+ è¡Œè®Šæ›´ï¼‰
2. `PackageTraker/Services/TrackingManager.swift` - æ·»åŠ ç‹€æ…‹è®ŠåŒ–åµæ¸¬ï¼ˆç´„ 10 è¡Œï¼‰
3. `PackageTraker/PackageTrakerApp.swift` - è¨­ç½®é€šçŸ¥ä»£ç†ï¼ˆç´„ 20 è¡Œï¼‰
4. `PackageTraker/en.lproj/Localizable.strings` - æ·»åŠ  20+ å€‹éµ
5. `PackageTraker/zh-Hant.lproj/Localizable.strings` - æ·»åŠ  20+ å€‹éµ
6. `PackageTraker/zh-Hans.lproj/Localizable.strings` - æ·»åŠ  20+ å€‹éµ
7. `PackageTraker/Info.plist` - æ·»åŠ é€šçŸ¥æ¬Šé™èªªæ˜

---

## æ½›åœ¨å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ

### å•é¡Œ 1: æ¨¡æ“¬å™¨ç„¡æ³•æ¸¬è©¦é€šçŸ¥
**è§£æ±ºæ–¹æ¡ˆ**: å¯ä»¥ä½¿ç”¨ `xcrun simctl` å‘½ä»¤æˆ– Xcode çš„ Debug > Trigger Local Notification åŠŸèƒ½æ¸¬è©¦

### å•é¡Œ 2: ç‹€æ…‹è®ŠåŒ–åµæ¸¬å¯èƒ½ä¸æº–ç¢º
**è§£æ±ºæ–¹æ¡ˆ**: åœ¨ `TrackingManager.track(package:)` ä¸­ä»”ç´°æ¯”è¼ƒ `oldStatus` å’Œ `newStatus`ï¼Œç¢ºä¿åªåœ¨çœŸæ­£è®ŠåŒ–æ™‚è§¸ç™¼

### å•é¡Œ 3: èƒŒæ™¯å–è²¨æé†’å¯èƒ½ä¸å¯é 
**è§£æ±ºæ–¹æ¡ˆ**: iOS çš„èƒŒæ™¯ä»»å‹™ä¸¦éä¿è­‰åŸ·è¡Œï¼Œå¯ä»¥åœ¨ App é€²å…¥å‰æ™¯æ™‚ä¹Ÿæª¢æŸ¥ä¸¦æ›´æ–°æé†’

### å•é¡Œ 4: æ¸…é™¤æ•¸æ“šæ™‚ cascade åˆªé™¤å¯èƒ½å¤±æ•—
**è§£æ±ºæ–¹æ¡ˆ**: SwiftData çš„ `@Relationship(deleteRule: .cascade)` å·²é…ç½®ï¼Œæ‡‰è©²èƒ½è‡ªå‹•åˆªé™¤ç›¸é—œçš„ TrackingEvent

### å•é¡Œ 5: éš±ç§æ”¿ç­–æš«æ™‚ç”¨éƒµä»¶ä»£æ›¿
**è§£æ±ºæ–¹æ¡ˆ**: æœªä¾†å»ºç½®å¥½çœŸå¯¦çš„éš±ç§æ”¿ç­–é é¢å¾Œï¼Œåªéœ€ä¿®æ”¹ `AppConfiguration` æˆ–ç›´æ¥åœ¨ SettingsView ä¸­æ”¹å› Link

---

## å¾ŒçºŒæ”¹é€²å»ºè­°

1. **é€šçŸ¥è‡ªå®šç¾©**: å…è¨±ç”¨æˆ¶é¸æ“‡å–è²¨æé†’çš„æ™‚é–“ï¼ˆæ—©ä¸Š 10:00 / ä¸‹åˆ 3:00 ç­‰ï¼‰
2. **é€šçŸ¥å…§å®¹è±å¯ŒåŒ–**: åŒ…å«åŒ…è£¹åœ–ç‰‡ã€ä¸€éµå°èˆªåˆ°å–è²¨åœ°é»
3. **éš±ç§æ”¿ç­–é é¢**: å»ºç½®çœŸå¯¦çš„éš±ç§æ”¿ç­–ç¶²é ä¸¦æ›´æ–°é€£çµ
4. **æ¸…é™¤æ•¸æ“šé¸é …**: æä¾›éƒ¨åˆ†æ¸…é™¤é¸é …ï¼ˆåƒ…æ¸…é™¤å·²å–è²¨çš„åŒ…è£¹ç­‰ï¼‰
5. **è¨­å®šå‚™ä»½/æ¢å¾©**: å…è¨±ç”¨æˆ¶å°å‡ºå’Œå°å…¥è¨­å®š

---

## ç¸½çµ

æ­¤è¨ˆåŠƒå°‡å®Œæ•´è§£æ±ºè¨­å®šç•«é¢çš„ç¡¬ç·¨ç¢¼å•é¡Œã€å¯¦ç¾åŠŸèƒ½å®Œæ•´çš„æœ¬åœ°é€šçŸ¥ç³»çµ±ã€å®Œå–„æ¸…é™¤æ•¸æ“šåŠŸèƒ½ï¼Œä¸¦æ”¹é€²æ•´é«”ç”¨æˆ¶é«”é©—ã€‚æ‰€æœ‰ä¿®æ”¹å‡ç¬¦åˆ SwiftUI + SwiftData çš„æ¶æ§‹æ¨¡å¼ï¼Œä¸¦éµå¾ªæœ¬åœ°åŒ–æœ€ä½³å¯¦è¸ã€‚é è¨ˆé–‹ç™¼æ™‚é–“ç´„ 3 å°æ™‚ï¼Œæ¸¬è©¦æ™‚é–“ç´„ 30 åˆ†é˜ã€‚
