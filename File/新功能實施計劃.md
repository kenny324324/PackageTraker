# PackageTraker æ–°åŠŸèƒ½å¯¦æ–½è¨ˆåŠƒ

## ğŸ“Š é€²åº¦è¿½è¹¤

| Phase | ç‹€æ…‹ | å®Œæˆæ—¥æœŸ | å‚™è¨» |
|-------|------|---------|------|
| **Phase A** | ğŸš§ é€²è¡Œä¸­ | - | è¨­å®šé é¢ UI å·²å®Œæˆ |
| Phase B | â¸ï¸ å¾…é–‹å§‹ | - | OCR å„ªåŒ– |
| Phase C | â¸ï¸ å¾…é–‹å§‹ | - | AI æˆªåœ–è¾¨è­˜ |
| Phase D | â¸ï¸ å¾…é–‹å§‹ | - | iOS Widget |

### Phase A å®Œæˆé …ç›® (2026-02-10)

#### âœ… å·²å®Œæˆ
- **A.3 è¨­å®šé é¢ UI é‡æ§‹**
  - âœ… å¸³è™Ÿå€å¡Šï¼ˆAvatar + åç¨± + è¨‚é–±è³‡è¨Šï¼‰
  - âœ… å€‹äººè³‡è¨Šè©³æƒ…é ï¼ˆAccountDetailViewï¼‰
    - æš±ç¨±ã€è¨»å†Šæ™‚é–“é¡¯ç¤º
    - ç·¨è¼¯åŠŸèƒ½ï¼ˆEditProfileSheetï¼‰
    - æš±ç¨± Firestore åŒæ­¥å„²å­˜
    - ç™»å‡ºç¢ºèªå„ªåŒ–ï¼ˆç°¡åŒ–æ–‡å­—ã€ç™½è‰²æŒ‰éˆ•ï¼‰
  - âœ… åŒ…è£¹è¿½è¹¤é¡åº¦å¡ç‰‡
    - é¡¯ç¤º X/5 é€²åº¦æ¢
    - å‹•æ…‹é¡è‰²ï¼ˆç¶ è‰²/ç´…è‰²ï¼‰
    - é»æ“Šé–‹å•Ÿ PaywallView
  - âœ… æ¨æ’­é€šçŸ¥ç´°é …è¨­å®šï¼ˆNotificationSettingsViewï¼‰
    - åˆ°è²¨é€šçŸ¥ã€å‡ºè²¨é€šçŸ¥ã€å–è²¨æé†’
    - Firestore åŒæ­¥
  - âœ… æ‰€æœ‰æŒ‰éˆ•é¡è‰²çµ±ä¸€ç‚ºç™½è‰²ï¼ˆä¸ä½¿ç”¨ä¸»é¡Œè‰²ï¼‰
  - âœ… æ‰€æœ‰å¡ç‰‡åœ“è§’çµ±ä¸€ç‚º 20px

#### ğŸš§ é€²è¡Œä¸­
- A.1 SubscriptionManager æœå‹™ï¼ˆå·²å­˜åœ¨ï¼Œå¾…é©—è­‰ï¼‰
- A.2 PaywallView UIï¼ˆå·²å­˜åœ¨ï¼Œå¾…é©—è­‰ï¼‰
- A.4 ä¸»é¡Œé¡è‰²ä»˜è²»ç‰†ï¼ˆå¾…å¯¦æ–½ï¼‰
- A.5 åŒ…è£¹æ•¸é‡é™åˆ¶ï¼ˆå·²å­˜åœ¨ï¼Œå¾…é©—è­‰ï¼‰
- A.6 FeatureFlags æ›´æ–°ï¼ˆå¾…ç¢ºèªï¼‰
- A.7 App Store Connect è¨­å®šï¼ˆå¾…æ‰‹å‹•æ“ä½œï¼‰

---

## èƒŒæ™¯èˆ‡ç›®æ¨™

PackageTraker å¾Œç«¯æ¨æ’­ç³»çµ±å·²å…¨éƒ¨å®Œæˆï¼ˆPhase 1-4 + å„ªåŒ– 1-4ï¼‰ï¼Œç¾åœ¨éœ€è¦å¯¦æ–½ 5 é …æ–°åŠŸèƒ½ä¾†å®Œå–„ç”¢å“ä¸¦å»ºç«‹å•†æ¥­æ¨¡å¼ã€‚

### ç›®æ¨™
1. å»ºç«‹ App Store è¨‚é–±åˆ¶åº¦ï¼ˆæœˆè²» NT$60 / å¹´è²» NT$600ï¼‰
2. å„ªåŒ–æˆªåœ–è¾¨è­˜æº–ç¢ºç‡
3. æ–°å¢ AI æ™ºèƒ½æˆªåœ–è¾¨è­˜ï¼ˆGoogle Gemini 2.0 Flashï¼‰
4. æ–°å¢ iOS æ¡Œé¢ Widget
5. èª¿æ•´è¨­å®šé é¢ï¼ˆè¨‚é–±ç®¡ç†å…¥å£ + ä¸»é¡Œä»˜è²»ç‰†ï¼‰

---

## éœ€æ±‚ç¸½çµ

| å„ªå…ˆé †åº | åŠŸèƒ½ | é—œéµéœ€æ±‚ |
|---------|------|---------|
| 1 | è¨­å®šé é¢èª¿æ•´ | åŠ å…¥è¨‚é–±ç®¡ç†å…¥å£ |
| 2 | æˆªåœ–è¾¨è­˜å„ªåŒ– | æº–ç¢ºç‡ä½ã€æ‰‹å‹•æ ¡æ­£å¤šã€ç‰¹å®šç‰©æµå•†ç„¡æ³•è¾¨è­˜ |
| 3 | iOS Widget | æ¡Œé¢å°å·¥å…·é¡¯ç¤ºåŒ…è£¹ç‹€æ…‹ |
| 4 | AI è¾¨è­˜æˆªåœ– | Google Gemini 2.0 Flash API |
| 5 | App Store è¨‚é–± | æœˆè²» NT$60 / å¹´è²» NT$600 |

### ä»˜è²»åŠŸèƒ½å€åˆ†

| åŠŸèƒ½ | å…è²»ç‰ˆ | Pro ç‰ˆ |
|------|--------|--------|
| åŒ…è£¹è¿½è¹¤æ•¸é‡ | æœ€å¤š 5 å€‹ | ç„¡é™åˆ¶ |
| ä¸»é¡Œé¡è‰² | åƒ…å’–å•¡è‰²ï¼ˆcoffeeBrownï¼‰ | å…¨éƒ¨ 8 ç¨®é¡è‰² |
| æˆªåœ–è¾¨è­˜ | åŸºç¤ OCRï¼ˆVisionï¼‰ | åŸºç¤ OCR + AI æ™ºèƒ½è¾¨è­˜ |
| iOS Widget | ä¸å¯ç”¨ | å¯ç”¨ |
| æ¨æ’­é€šçŸ¥ | å®Œæ•´åŠŸèƒ½ | å®Œæ•´åŠŸèƒ½ |

---

## å¯¦æ–½é †åºï¼ˆä¾è³´é—œä¿‚ï¼‰

```
Phase A: è¨‚é–±æœå‹™ + è¨­å®šé é¢ï¼ˆåŸºç¤ï¼Œå…¶ä»–åŠŸèƒ½çš„ä»˜è²»ç‰†ä¾è³´æ­¤éšæ®µï¼‰
    â”‚
    â”œâ”€â”€ Phase B: OCR å„ªåŒ–ï¼ˆç¨ç«‹ï¼Œå¯èˆ‡ Phase A å¹³è¡Œé–‹ç™¼ï¼‰
    â”‚
    â”œâ”€â”€ Phase C: AI æˆªåœ–è¾¨è­˜ï¼ˆä¾è³´ Phase A çš„è¨‚é–±ä»˜è²»ç‰†ï¼‰
    â”‚
    â””â”€â”€ Phase D: iOS Widgetï¼ˆä¾è³´ Phase A çš„è¨‚é–± + App Groupï¼‰
```

---

## Phase A: è¨‚é–±æœå‹™ + è¨­å®šé é¢

### A.1 æ–°å»º SubscriptionManager æœå‹™

**æ–°æª”æ¡ˆï¼š** `PackageTraker/Services/Subscription/SubscriptionManager.swift`

- StoreKit 2 `async/await` API
- Singleton patternï¼ˆåŒ `FirebaseAuthService.shared`ï¼‰
- Product IDs: `com.kenny.PackageTraker.pro.monthly` / `.yearly`
- æ ¸å¿ƒæ–¹æ³•ï¼š
  - `loadProducts()` â†’ `Product.products(for:)` è¼‰å…¥å•†å“
  - `purchase(_ product)` â†’ è³¼è²· + `Transaction.finish()`
  - `checkEntitlements()` â†’ å•Ÿå‹•æ™‚å¾ `Transaction.currentEntitlements` é©—è­‰
  - `listenForTransactions()` â†’ ç›£è½çºŒè¨‚/éæœŸ/æ’¤éŠ·
  - `restorePurchases()` â†’ `AppStore.sync()`
  - `syncToFirestore()` â†’ åŒæ­¥åˆ° `/users/{uid}` çš„ `subscriptionTier` æ¬„ä½
- Published å±¬æ€§ï¼š`currentTier`, `isPro`, `maxPackageCount(5/âˆ)`, `hasAIAccess`, `hasAllThemes`
- `@AppStorage("subscriptionTier")` æœ¬åœ°å¿«å– + Firestore é›²ç«¯åŒæ­¥

**æ–°æª”æ¡ˆï¼š** `PackageTraker/Models/SubscriptionTier.swift`

```swift
enum SubscriptionTier: String, Codable {
    case free = "free"
    case pro = "pro"
}

enum SubscriptionProductID: String, CaseIterable {
    case monthly = "com.kenny.PackageTraker.pro.monthly"  // NT$60/æœˆ
    case yearly  = "com.kenny.PackageTraker.pro.yearly"   // NT$600/å¹´
}
```

### A.2 Paywall ä»˜è²»ç‰† UI

**æ–°æª”æ¡ˆï¼š** `PackageTraker/Views/Subscription/PaywallView.swift`

- å…¨è¢å¹• sheetï¼Œæ·±è‰²æ¨¡å¼
- åŠŸèƒ½å°æ¯”è¡¨ï¼ˆFree vs Proï¼‰
- æœˆè²»/å¹´è²»ç”¢å“å¡ç‰‡ï¼ˆå¹´è²»æ¨™ç¤ºçœå¤šå°‘ï¼‰
- è³¼è²·æŒ‰éˆ• + æ¢å¾©è³¼è²· + æ¢æ¬¾é€£çµ
- ä½¿ç”¨ç¾æœ‰ `Color.appAccent` å’Œ `Color.secondaryCardBackground` è¨­è¨ˆèªè¨€

### A.3 è¨­å®šé é¢èª¿æ•´

**ä¿®æ”¹ï¼š** `PackageTraker/Views/Settings/SettingsView.swift`

æ–°å¢ `subscriptionSection`ï¼ˆæ’å…¥åœ¨ Account å’Œ General ä¹‹é–“ï¼‰ï¼š
- é¡¯ç¤ºç•¶å‰æ–¹æ¡ˆï¼ˆFree / Pro + çš‡å† åœ–ç¤ºï¼‰
- å‡ç´š/ç®¡ç†æŒ‰éˆ• â†’ æ‰“é–‹ PaywallView
- æ¢å¾©è³¼è²·æŒ‰éˆ•

**æ–°çš„ section é †åºï¼š**
1. Accountï¼ˆåŸæœ‰ï¼‰
2. **Subscriptionï¼ˆæ–°å¢ï¼‰**
3. Generalï¼ˆåŸæœ‰ï¼Œä¸»é¡ŒåŠ ä»˜è²»ç‰†ï¼‰
4. Notificationsï¼ˆåŸæœ‰ï¼‰
5. Data Managementï¼ˆåŸæœ‰ï¼‰
6. Aboutï¼ˆåŸæœ‰ï¼‰

### A.4 ä¸»é¡Œé¡è‰²ä»˜è²»ç‰†

**ä¿®æ”¹ï¼š** `PackageTraker/Views/Settings/ThemeSettingsView.swift`
- å…è²»ç”¨æˆ¶ï¼šåªæœ‰ coffeeBrown å¯é¸ï¼Œå…¶ä»–é¡è‰²é¡¯ç¤º ğŸ”’ + çš‡å† åœ–ç¤º
- é»æ“Šé–å®šé¡è‰² â†’ æ‰“é–‹ PaywallView

**ä¿®æ”¹ï¼š** `PackageTraker/Services/ThemeManager.swift`
- `selectedTheme` setter åŠ å…¥è¨‚é–±æª¢æŸ¥
- è¨‚é–±éæœŸæ™‚è‡ªå‹•é‡ç½®ç‚º coffeeBrown

### A.5 åŒ…è£¹æ•¸é‡é™åˆ¶

**ä¿®æ”¹ï¼š** `PackageTraker/Views/AddPackage/AddPackageView.swift`
- ã€Œç¹¼çºŒã€æŒ‰éˆ•åŠ å…¥ `activePackages.count >= 5` æª¢æŸ¥ï¼ˆé archived çš„åŒ…è£¹ï¼‰
- è¶…éé™åˆ¶ â†’ æ‰“é–‹ PaywallView

### A.6 FeatureFlags æ›´æ–°

**ä¿®æ”¹ï¼š** `PackageTraker/FeatureFlags.swift`

```swift
struct FeatureFlags {
    static let emailAutoImportEnabled = false
    static let subscriptionEnabled = true
    static let aiVisionEnabled = true
    static let widgetEnabled = true
}
```

### A.7 App Store Connect è¨­å®šï¼ˆæ‰‹å‹•æ“ä½œï¼‰

1. å»ºç«‹ Subscription Group "PackageTraker Pro"
2. æ–°å¢å…©å€‹è‡ªå‹•çºŒè¨‚ç”¢å“ï¼š
   - `com.kenny.PackageTraker.pro.monthly` â€” NT$60/æœˆ
   - `com.kenny.PackageTraker.pro.yearly` â€” NT$600/å¹´
3. ä¸‰èªæè¿°ï¼ˆzh-Hant, zh-Hans, enï¼‰
4. å»ºç«‹ Xcode StoreKit Configuration ç”¨æ–¼æœ¬åœ°æ¸¬è©¦

### A é©—è­‰æ–¹å¼

- âœ… Build æˆåŠŸç„¡éŒ¯èª¤
- âœ… å…è²»ç”¨æˆ¶åªèƒ½é¸å’–å•¡è‰²ä¸»é¡Œï¼Œå…¶ä»–é¡¯ç¤ºé–é ­
- âœ… å…è²»ç”¨æˆ¶æœ€å¤šæ–°å¢ 5 å€‹æ´»èºåŒ…è£¹ï¼Œç¬¬ 6 å€‹å½ˆå‡º PaywallView
- âœ… Sandbox ç’°å¢ƒè³¼è²·æµç¨‹æ­£å¸¸
- âœ… æ¢å¾©è³¼è²·æ­£å¸¸
- âœ… è¨‚é–±ç‹€æ…‹åŒæ­¥åˆ° Firestore
- âœ… è¨‚é–±éæœŸå¾Œä¸»é¡Œè‡ªå‹•é‡ç½®ç‚ºå’–å•¡è‰²
- âœ… è¨­å®šé é¢è¨‚é–± section æ­£ç¢ºé¡¯ç¤º

---

## Phase B: æˆªåœ– OCR å„ªåŒ–

### B.1 çµ±ä¸€ç‰©æµå–®è™Ÿ Pattern

**ä¿®æ”¹ï¼š** `PackageTraker/Services/OCR/TrackingNumberOCRService.swift`

ç›®å‰ OCR åªæœ‰ 7 å€‹ patternï¼ˆ~6 ç‰©æµå•†ï¼‰ï¼Œè€Œ `CarrierDetector` æœ‰ 20 å€‹ patternï¼ˆ~10 ç‰©æµå•†ï¼‰ã€‚éœ€è¦çµ±ä¸€ã€‚

**æ–°å¢ patternï¼š**

| ç‰©æµå•† | Pattern | ä¿¡å¿ƒåº¦ |
|--------|---------|--------|
| èŠçˆ¾å¯Œ | `^HL\d{10,15}$` | 0.95 |
| ä¸­è¯éƒµæ”¿åœ‹éš› | `^[A-Z]{2}\d{9}TW$` | 0.95 |
| ä¸­è¯éƒµæ”¿åœ‹å…§ | `^\d{13}$` | 0.5 |
| é †è± | `^SF\d{12,15}$` | 0.95 |
| å®…é…é€š | `^E\d{11,12}$` | 0.9 |
| èœé³¥ | `^LP\d{15,18}$` | 0.9 |
| æ–°ç«¹ç‰©æµ | `^\d{10,11}$` | 0.6 |
| å…¨å®¶ï¼ˆ2å­—æ¯ï¼‰ | `^[A-Z]{2}\d{10,13}$` | 0.7 |

è€ƒæ…®æŠ½å–å…±ç”¨ `TrackingPatterns` struct è®“ OCR å’Œ CarrierDetector å…±ç”¨åŒä¸€ä»½ pattern è³‡æ–™ã€‚

### B.2 å¢å¼· OCR éŒ¯èª¤ä¿®æ­£

**ä¿®æ”¹ï¼š** `TrackingNumberOCRService.fixCommonOCRErrors()`

æ–°å¢å¸¸è¦‹ OCR èª¤åˆ¤ä¿®æ­£è¡¨ï¼š

| OCR èª¤åˆ¤ | ä¿®æ­£ç‚º | é©ç”¨å ´æ™¯ |
|----------|--------|---------|
| O | 0 | æ•¸å­—éƒ¨åˆ† |
| I / l | 1 | æ•¸å­—éƒ¨åˆ† |
| S | 5 | ç´”æ•¸å­—å­—ä¸² |
| B | 8 | ç´”æ•¸å­—å­—ä¸² |
| G | 6 | ç´”æ•¸å­—å­—ä¸² |
| Z | 2 | ç´”æ•¸å­—å­—ä¸² |

é‡å°å·²çŸ¥å‰ç¶´æ ¼å¼ï¼ˆSFã€HLã€TWï¼‰è‡ªå‹•ä¿®æ­£æ•¸å­—éƒ¨åˆ†ã€‚

### B.3 å¤šè¡Œæ–‡å­—åˆä½µ

**ä¿®æ”¹ï¼š** `findTrackingNumberCandidates()`

- æŒ‰ Y åº§æ¨™æ’åºè¾¨è­˜æ–‡å­—
- å˜—è©¦åˆä½µç›¸é„°è¡Œï¼ˆè·é›¢ < 0.1ï¼‰å†åš pattern æ¯”å°
- è™•ç†è¿½è¹¤è™Ÿç¢¼è¢«æ›è¡Œæˆªæ–·çš„æƒ…æ³
- åˆä½µçµæœçš„ä¿¡å¿ƒåº¦æ‰“ 0.9 æŠ˜

### B.4 ä¸Šä¸‹æ–‡æ„ŸçŸ¥åµæ¸¬

æ–°å¢é—œéµå­—åµæ¸¬ï¼Œæå‡ä¿¡å¿ƒåº¦ï¼š

```
è¿½è¹¤ç·¨è™Ÿã€å–è²¨ç·¨è™Ÿã€å–®è™Ÿã€ç‰©æµç·¨è™Ÿã€é…é€ç·¨è™Ÿã€å–ä»¶ç¢¼ã€å–è²¨ç¢¼
trackingã€numberã€shipmentã€delivery
```

é™„è¿‘æœ‰é—œéµå­—çš„å€™é¸ +15% ä¿¡å¿ƒåº¦åŠ æˆã€‚

### B.5 æ”¹å–„ç„¡çµæœæ™‚çš„ UI

**ä¿®æ”¹ï¼š** `PackageTraker/Views/AddPackage/OCRResultSheet.swift`

- èªªæ˜æ–‡å­—ï¼šã€Œæœªæ‰¾åˆ°ç‰©æµå–®è™Ÿï¼Œè«‹å¾ä¸‹æ–¹æ–‡å­—ä¸­é¸æ“‡ã€
- éæ¿¾æ‰ < 5 å­—å…ƒçš„çŸ­æ–‡å­—
- é«˜äº®å«æ•¸å­—åºåˆ—çš„æ–‡å­—
- æ–°å¢ã€Œæ›ä¸€å¼µåœ–ç‰‡ã€æŒ‰éˆ•

### B é©—è­‰æ–¹å¼

- âœ… èŠçˆ¾å¯Œã€éƒµå±€ã€é †è±ç­‰æ–° pattern å¯è¾¨è­˜
- âœ… Oâ†’0ã€Iâ†’1 ç­‰ OCR éŒ¯èª¤ä¿®æ­£ç”Ÿæ•ˆ
- âœ… å¤šè¡Œè¿½è¹¤è™Ÿç¢¼å¯åˆä½µè¾¨è­˜
- âœ… ä¸Šä¸‹æ–‡é—œéµå­—åŠ æˆæœ‰æ•ˆ
- âœ… ç„¡çµæœ UI æ”¹å–„ï¼Œæç¤ºæ›´æ¸…æ¥š

---

## Phase C: AI æˆªåœ–è¾¨è­˜

> è©³ç´°æŠ€è¡“æ–¹æ¡ˆå¦è¦‹ `File/AI-æˆªåœ–è¾¨è­˜å‡ç´šè¨ˆç•«.md`

### C.1 SPM ä¾è³´

æ–°å¢ Google Generative AI SDKï¼š`https://github.com/google/generative-ai-swift`

### C.2 API Key

**ä¿®æ”¹ï¼š** `PackageTraker/Secrets.swift` â†’ æ–°å¢ `geminiAPIKey`

### C.3 AI æœå‹™

**æ–°æª”æ¡ˆï¼š** `PackageTraker/Services/AI/AIVisionService.swift`

- Singleton pattern
- ä½¿ç”¨ `GenerativeModel(name: "gemini-2.0-flash")`
- `analyzePackageImage(_ image)` â†’ å£“ç¸®åœ–ç‰‡ â†’ å‘¼å« Gemini API â†’ è§£æ JSON
- System prompt è¦æ±‚å›å‚³ 6 æ¬„ä½ï¼š
  - `trackingNumber` - ç‰©æµå–®è™Ÿ
  - `carrier` - ç‰©æµå•†åç¨±
  - `pickupLocation` - å–è²¨åœ°é»
  - `pickupCode` - å–ä»¶ç¢¼
  - `packageName` - åŒ…è£¹/å•†å“åç¨±
  - `estimatedDelivery` - é ä¼°é€é”æ—¥æœŸ
  - `confidence` - å„æ¬„ä½ä¿¡å¿ƒåº¦
- è¨‚é–±æª¢æŸ¥ï¼šé Pro ç”¨æˆ¶æ‹‹å‡º `.subscriptionRequired`

**æ–°æª”æ¡ˆï¼š** `PackageTraker/Services/AI/AIVisionModels.swift`

- `AIVisionResult` structï¼ˆCodableï¼‰
- `detectedCarrier` computed propertyï¼ˆæ¨¡ç³Šæ¯”å°ç‰©æµå•†åç¨± â†’ Carrier enumï¼‰
- `AIVisionError` enumï¼ˆå«æœ¬åœ°åŒ–éŒ¯èª¤è¨Šæ¯ï¼‰

### C.4 AI çµæœé¡¯ç¤º

**æ–°æª”æ¡ˆï¼š** `PackageTraker/Views/AddPackage/AIVisionResultSheet.swift`

- é¡¯ç¤º 6 å€‹å¯ç·¨è¼¯æ¬„ä½
- æ¯å€‹æ¬„ä½å¸¶ä¿¡å¿ƒåº¦æŒ‡æ¨™ï¼š
  - ğŸŸ¢ â‰¥ 0.90ï¼šé«˜ä¿¡å¿ƒ
  - ğŸŸ¡ 0.70-0.89ï¼šä¸­ç­‰ä¿¡å¿ƒ
  - âšª < 0.70ï¼šä½ä¿¡å¿ƒï¼ˆä¸è‡ªå‹•å¡«å…¥ï¼‰
- ã€Œç¢ºèªä¸¦å¡«å…¥ã€æŒ‰éˆ• â†’ å›å¡« AddPackage è¡¨å–®

### C.5 AI æ¨å»£å¡ç‰‡

**æ–°æª”æ¡ˆï¼š** `PackageTraker/Views/AddPackage/AIPromotionCard.swift`

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ  âœ¨ è©¦è©¦ AI æ™ºèƒ½è¾¨è­˜                    â”ƒ
â”ƒ  âœ“ è‡ªå‹•è­˜åˆ¥ 6+ å€‹æ¬„ä½                  â”ƒ
â”ƒ  âœ“ 3 ç§’æ¥µé€Ÿåˆ†æ                        â”ƒ
â”ƒ  âœ“ æº–ç¢ºåº¦ 90%+                         â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”ƒ
â”ƒ  â”‚    ç«‹å³é«”é©— AI è¾¨è­˜ ğŸ‘‘          â”‚    â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”ƒ
â”ƒ  è¨‚é–±æœƒå“¡å°ˆäº« â€¢ NT$60/æœˆ                â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
```

- æ’å…¥ AddPackageView è¿½è¹¤è™Ÿç¢¼è¼¸å…¥å’Œç‰©æµå•†é¸æ“‡ä¹‹é–“
- Pro ç”¨æˆ¶ï¼šé–‹å•Ÿåœ–ç‰‡é¸æ“‡å™¨ â†’ AI è¾¨è­˜
- å…è²»ç”¨æˆ¶ï¼šæ‰“é–‹ PaywallView

### C.6 æ•´åˆåˆ° AddPackageView

**ä¿®æ”¹ï¼š** `PackageTraker/Views/AddPackage/AddPackageView.swift`

- æ–°å¢ AI photo picker + AIVisionResultSheet + PaywallView sheet
- AI çµæœç¢ºèªå¾Œå¡«å…¥ trackingNumber, selectedCarrier, selectedCategory
- pickupLocation, pickupCode, packageName å‚³éåˆ° PackageInfoView

### C é©—è­‰æ–¹å¼

- âœ… Pro ç”¨æˆ¶å¯é¸åœ–ç‰‡ä¸¦åœ¨ 3 ç§’å…§å–å¾— AI çµæœ
- âœ… å…è²»ç”¨æˆ¶é»æ“Š AI å¡ç‰‡é¡¯ç¤º PaywallView
- âœ… AI æ­£ç¢ºæå–è¦çš®/7-11/å…¨å®¶æˆªåœ–è³‡è¨Š
- âœ… ä¿¡å¿ƒåº¦æŒ‡æ¨™æ­£ç¢ºé¡¯ç¤ºï¼ˆç¶ /é»ƒ/ç°ï¼‰
- âœ… AI å¤±æ•—æ™‚é¡¯ç¤ºéŒ¯èª¤ä¸¦å»ºè­°ä½¿ç”¨åŸºç¤ OCR

---

## Phase D: iOS Widget

### D.1 Xcode è¨­å®šï¼ˆæ‰‹å‹•æ“ä½œï¼‰

1. æ–°å¢ Widget Extension target: `PackageTrakerWidget`
2. æ–°å¢ App Group: `group.com.kenny.PackageTraker`ï¼ˆä¸» App + Widget éƒ½åŠ ï¼‰
3. å°‡å…±ç”¨ Model æª”æ¡ˆåŠ å…¥ Widget target membership

### D.2 å…±äº« SwiftData Container

**ä¿®æ”¹ï¼š** `PackageTraker/PackageTrakerApp.swift`
- æ”¹ç”¨ App Group URL å»ºç«‹ ModelContainer

**ä¿®æ”¹ï¼š** `PackageTraker/PackageTraker.entitlements` â†’ æ–°å¢ App Group

**ä¿®æ”¹ï¼š** `SubscriptionManager` â†’ å¯«å…¥å…±äº« `UserDefaults(suiteName:)` è®“ Widget è®€å–

### D.3 Widget TimelineProvider

**æ–°æª”æ¡ˆï¼š** `PackageTrakerWidget/PackageTimelineProvider.swift`

- å¾ App Group çš„ SwiftData è®€å– active packagesï¼ˆæœ€å¤š 5 å€‹ï¼‰
- æ¯ 15 åˆ†é˜æ›´æ–° Timeline
- è®€å–å…±äº« UserDefaults çš„ subscriptionTier

### D.4 Widget Views

| Widget å°ºå¯¸ | é¡¯ç¤ºå…§å®¹ | æ–°æª”æ¡ˆ |
|-------------|---------|--------|
| Small | 1 å€‹åŒ…è£¹ï¼šç‰©æµå•† + åç¨± + ç‹€æ…‹ badge | `SmallWidgetView.swift` |
| Medium | 2-3 å€‹åŒ…è£¹åˆ—è¡¨ | `MediumWidgetView.swift` |
| Large | 4-5 å€‹åŒ…è£¹ + æœ€æ–°äº‹ä»¶æè¿° | `LargeWidgetView.swift` |

å…è²»ç”¨æˆ¶ï¼šé¡¯ç¤ºã€Œå‡ç´š Proã€CTA

### D.5 Widget Entry Point

**æ–°æª”æ¡ˆï¼š** `PackageTrakerWidget/PackageTrakerWidget.swift`
- `WidgetBundle` + `StaticConfiguration`
- æ”¯æ´ `.systemSmall`, `.systemMedium`, `.systemLarge`

### D.6 Deep Link

**ä¿®æ”¹ï¼š** `Info.plist` â†’ æ–°å¢ `packagetraker://` URL scheme
**ä¿®æ”¹ï¼š** `PackageTrakerApp.handleIncomingURL()` â†’ è™•ç† `packagetraker://package/{uuid}`

Widget ä½¿ç”¨ `.widgetURL()` / `Link(destination:)` è·³è½‰åˆ°åŒ…è£¹è©³æƒ…é ã€‚

### D.7 Timeline åˆ·æ–°

**ä¿®æ”¹ï¼š** `PackageRefreshService.swift`, `PackageInfoView.swift`, `PackageDetailView.swift`
- åŒ…è£¹æ›´æ–°å¾Œå‘¼å« `WidgetCenter.shared.reloadAllTimelines()`

### D é©—è­‰æ–¹å¼

- âœ… Widget Extension æˆåŠŸ build
- âœ… App Group å…±äº«è³‡æ–™æ­£å¸¸ï¼ˆä¸» App å¯«å…¥ã€Widget è®€å–ï¼‰
- âœ… Small/Medium/Large Widget æ­£ç¢ºé¡¯ç¤ºåŒ…è£¹è³‡è¨Š
- âœ… é»æ“Š Widget è·³è½‰åˆ°æ­£ç¢ºåŒ…è£¹è©³æƒ…é 
- âœ… å…è²»ç”¨æˆ¶ Widget é¡¯ç¤ºå‡ç´šæç¤º
- âœ… åŒ…è£¹æ›´æ–°å¾Œ Widget è‡ªå‹•åˆ·æ–°

---

## æª”æ¡ˆæ¸…å–®ç¸½è¦½

### æ–°æª”æ¡ˆï¼ˆ12 å€‹ï¼‰

| æª”æ¡ˆ | Phase | ç”¨é€” |
|------|-------|------|
| `Models/SubscriptionTier.swift` | A | è¨‚é–±å±¤ç´šå’Œç”¢å“ ID |
| `Services/Subscription/SubscriptionManager.swift` | A | StoreKit 2 è¨‚é–±ç®¡ç† |
| `Views/Subscription/PaywallView.swift` | A | ä»˜è²»ç‰† UI |
| `Services/AI/AIVisionService.swift` | C | Gemini API æ•´åˆ |
| `Services/AI/AIVisionModels.swift` | C | AI çµæœæ¨¡å‹ |
| `Views/AddPackage/AIVisionResultSheet.swift` | C | AI çµæœé¡¯ç¤º |
| `Views/AddPackage/AIPromotionCard.swift` | C | AI æ¨å»£å¡ç‰‡ |
| `PackageTrakerWidget/PackageTrakerWidget.swift` | D | Widget å…¥å£ |
| `PackageTrakerWidget/PackageTimelineProvider.swift` | D | Timeline è³‡æ–™æä¾›è€… |
| `PackageTrakerWidget/WidgetViews/SmallWidgetView.swift` | D | å° Widget |
| `PackageTrakerWidget/WidgetViews/MediumWidgetView.swift` | D | ä¸­ Widget |
| `PackageTrakerWidget/WidgetViews/LargeWidgetView.swift` | D | å¤§ Widget |

### ä¿®æ”¹æª”æ¡ˆï¼ˆ13+ å€‹ï¼‰

| æª”æ¡ˆ | Phase | ä¿®æ”¹å…§å®¹ |
|------|-------|---------|
| `FeatureFlags.swift` | A | æ–°å¢è¨‚é–±/AI/Widget flags |
| `PackageTrakerApp.swift` | A, D | åˆå§‹åŒ– SubscriptionManagerã€App Group containerã€Widget URL |
| `SettingsView.swift` | A | æ–°å¢è¨‚é–± section |
| `ThemeSettingsView.swift` | A | ä¸»é¡Œé¡è‰²ä»˜è²»ç‰† |
| `ThemeManager.swift` | A | è¨‚é–±æª¢æŸ¥ guard |
| `AddPackageView.swift` | A, B, C | åŒ…è£¹é™åˆ¶ã€OCR æ”¹å–„ã€AI æ¨å»£å¡ |
| `TrackingNumberOCRService.swift` | B | 16+ patternsã€éŒ¯èª¤ä¿®æ­£ã€å¤šè¡Œåˆä½µ |
| `OCRResultSheet.swift` | B | æ”¹å–„ fallback UI |
| `Secrets.swift` | C | Gemini API key |
| `PackageTraker.entitlements` | D | App Group |
| `Info.plist` | D | Widget URL scheme |
| `PackageRefreshService.swift` | D | Widget reload |
| `en.lproj/Localizable.strings` | All | ~50 å€‹æ–° key |
| `zh-Hant.lproj/Localizable.strings` | All | ~50 å€‹æ–° key |
| `zh-Hans.lproj/Localizable.strings` | All | ~50 å€‹æ–° key |

---

## æˆæœ¬ä¼°ç®—

### AI API æˆæœ¬ï¼ˆGoogle Gemini 2.0 Flashï¼‰

| é …ç›® | æ•¸å€¼ |
|------|------|
| å–®æ¬¡è¾¨è­˜æˆæœ¬ | ~NT$0.005 |
| ç”¨æˆ¶æœˆå‡ä½¿ç”¨ | ~50 æ¬¡ |
| æœˆå‡ API æˆæœ¬ | ~NT$0.25/ç”¨æˆ¶ |
| æœˆè²»æ”¶å…¥ | NT$60/ç”¨æˆ¶ |
| **æ¯›åˆ©ç‡** | **99.5%** |

### è¨‚é–±æ”¶å…¥é ä¼°ï¼ˆ100 ä»˜è²»ç”¨æˆ¶ï¼‰

| æ–¹æ¡ˆ | æœˆæ”¶å…¥ |
|------|--------|
| å…¨æœˆè²» | NT$6,000 |
| å…¨å¹´è²» | NT$5,000ï¼ˆNT$600/12 Ã— 100ï¼‰ |
| æ··åˆï¼ˆ70%æœˆ/30%å¹´ï¼‰ | NT$5,700 |

---

## é¢¨éšªèˆ‡é™ç´šæ–¹æ¡ˆ

### é¢¨éšª 1: Gemini API ä¸ç©©å®š
**é™ç´šæ–¹æ¡ˆ**: å‚™ç”¨ GPT-4o-mini APIï¼Œæˆ–é™ç´šç‚ºåŸºç¤ OCR

### é¢¨éšª 2: StoreKit å¯©æ ¸è¢«æ‹’
**é™ç´šæ–¹æ¡ˆ**: ç¢ºä¿ä»˜è²»åŠŸèƒ½æœ‰æ˜ç¢ºåƒ¹å€¼ï¼Œæä¾›å…è²»è©¦ç”¨æœŸ

### é¢¨éšª 3: Widget è³‡æ–™åŒæ­¥å»¶é²
**é™ç´šæ–¹æ¡ˆ**: å¢åŠ  Timeline æ›´æ–°é »ç‡ï¼Œé¡¯ç¤ºã€Œä¸Šæ¬¡æ›´æ–°ã€æ™‚é–“

### é¢¨éšª 4: è¨‚é–±è½‰æ›ç‡éä½
**é™ç´šæ–¹æ¡ˆ**: èª¿æ•´å…è²»ç‰ˆé™åˆ¶ï¼ˆ3 åŒ…è£¹â†’5 åŒ…è£¹ï¼‰ã€æä¾›é¦–æœˆåŠåƒ¹ã€å»¶é•·è©¦ç”¨æœŸ
