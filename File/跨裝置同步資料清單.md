# 跨裝置同步資料清單

> 最後更新：2026-02-13

本文件記錄 PackageTraker 所有跨裝置同步的資料項目、儲存位置、同步方向與觸發時機。

---

## 同步架構概覽

- **本地資料庫**：SwiftData（包裹、追蹤事件）+ UserDefaults / @AppStorage（偏好設定）
- **雲端資料庫**：Firebase Firestore（`/users/{uid}/...`）
- **同步策略**：SwiftData 為本地 source of truth，Firestore 為雲端鏡像
- **即時同步**：包裹資料透過 Firestore snapshot listener 即時監聽
- **偏好設定**：冷啟動/登入時下載，變更時即時上傳（fire-and-forget）

---

## 1. 包裹資料（雙向同步）

**Firestore 路徑**：`/users/{uid}/packages/{packageId}`

| 資料欄位 | 本地儲存 | Firestore 欄位 | 上傳時機 | 下載時機 |
|----------|----------|----------------|----------|----------|
| 追蹤號碼 | `Package.trackingNumber` | `trackingNumber` | 新增/編輯 | 冷啟動 + 即時監聽 |
| 物流商 | `Package.carrierRawValue` | `carrier` | 新增/編輯 | 冷啟動 + 即時監聽 |
| 狀態 | `Package.statusRawValue` | `status` | API 刷新後 | 冷啟動 + 即時監聽 |
| 自訂名稱 | `Package.customName` | `customName` | 編輯時 | 冷啟動 + 即時監聽 |
| 取貨代碼 | `Package.pickupCode` | `pickupCode` | 編輯時 | 冷啟動 + 即時監聽 |
| 取貨地點 | `Package.pickupLocation` | `pickupLocation` | API 刷新後 | 冷啟動 + 即時監聽 |
| 使用者取貨地點 | `Package.userPickupLocation` | `userPickupLocation` | 使用者覆寫時 | 冷啟動 + 即時監聽 |
| 門市名稱 | `Package.storeName` | `storeName` | API 刷新後 | 冷啟動 + 即時監聽 |
| 最新描述 | `Package.latestDescription` | `latestDescription` | API 刷新後 | 冷啟動 + 即時監聽 |
| 服務類型 | `Package.serviceType` | `serviceType` | API 刷新後 | 冷啟動 + 即時監聽 |
| 取貨期限 | `Package.pickupDeadline` | `pickupDeadline` | API 刷新後 | 冷啟動 + 即時監聽 |
| 付款方式 | `Package.paymentMethodRawValue` | `paymentMethod` | 使用者輸入 | 冷啟動 + 即時監聽 |
| 金額 | `Package.amount` | `amount` | 使用者輸入 | 冷啟動 + 即時監聽 |
| 購買平台 | `Package.purchasePlatform` | `purchasePlatform` | 使用者選擇 | 冷啟動 + 即時監聯 |
| 備註 | `Package.notes` | `notes` | 使用者輸入 | 冷啟動 + 即時監聽 |
| 封存狀態 | `Package.isArchived` | `isArchived` | 編輯時 | 冷啟動 + 即時監聽 |
| Track.TW 關聯 ID | `Package.trackTwRelationId` | `trackTwRelationId` | API import 後 | 冷啟動 + 即時監聽 |
| 建立時間 | `Package.createdAt` | `createdAt` | 建立時 | 冷啟動 |
| 最後更新 | `Package.lastUpdated` | `lastUpdated` (server timestamp) | 每次同步 | 冷啟動 + 即時監聽 |
| 軟刪除 | 本地直接移除 | `isDeleted` + `deletedAt` | 刪除時標記 | 下載時跳過 |

### 追蹤事件（子集合）

**Firestore 路徑**：`/users/{uid}/packages/{packageId}/events/{eventId}`

| 資料欄位 | 本地儲存 | Firestore 欄位 | 同步方向 |
|----------|----------|----------------|----------|
| 時間戳 | `TrackingEvent.timestamp` | `timestamp` | 雙向 |
| 狀態 | `TrackingEvent.statusRawValue` | `status` | 雙向 |
| 描述 | `TrackingEvent.eventDescription` | `description` | 雙向 |
| 地點 | `TrackingEvent.location` | `location` | 雙向 |

### 補傳機制

- **`uploadMissingPackages()`**：每次冷啟動時比對本地 vs Firestore，補傳遺漏的包裹（解決歷史包裹未上傳問題）
- **即時監聽器**：`startListening()` 啟動後持續監聽，有 5 秒迴圈防護機制避免重複處理自身寫入
- **衝突解決**：比較 `lastUpdated` 時間戳，雲端較新則覆蓋本地；或狀態有進展時雲端優先

---

## 2. 訂閱狀態（雙向同步）

**Firestore 路徑**：`/users/{uid}`

| 資料欄位 | 本地儲存 | Firestore 欄位 | 上傳時機 | 下載時機 |
|----------|----------|----------------|----------|----------|
| 訂閱層級 (free/pro) | `UserDefaults:subscriptionTier` | `subscriptionTier` | StoreKit 購買/恢復/過期時 | `downloadUserPreferences()` |
| 產品 ID (monthly/yearly/lifetime) | `UserDefaults:subscriptionProductID` | `subscriptionProductID` | 同上 | 同上 |

**備註**：StoreKit 為訂閱的最終 source of truth。Firestore 的值作為 StoreKit 驗證前的初始值，確保新裝置能立即顯示正確的訂閱狀態（如 "Pro Yearly"），之後 StoreKit `checkEntitlements()` 會再次驗證並覆蓋。

---

## 3. 通知設定（雙向同步）

**Firestore 路徑**：`/users/{uid}/notificationSettings`

| 資料欄位 | 本地儲存 | Firestore 欄位 | 上傳時機 | 下載時機 |
|----------|----------|----------------|----------|----------|
| 總開關 | `@AppStorage("notificationsEnabled")` | `notificationSettings.enabled` | SettingsView `.onChange` | `downloadUserPreferences()` |
| 到店通知 | `@AppStorage("arrivalNotificationEnabled")` | `notificationSettings.arrivalNotification` | NotificationSettingsView `.onChange` | 同上 |
| 出貨通知 | `@AppStorage("shippedNotificationEnabled")` | `notificationSettings.shippedNotification` | 同上 | 同上 |
| 取貨提醒 | `@AppStorage("pickupReminderEnabled")` | `notificationSettings.pickupReminder` | 同上 | 同上 |

**用途**：Cloud Functions（triggers.ts、dailyReminder.ts）讀取這些設定來決定是否發送推播。

---

## 4. 使用者偏好（雙向同步）

**Firestore 路徑**：`/users/{uid}/preferences`

| 資料欄位 | 本地儲存 | Firestore 欄位 | 上傳時機 | 下載時機 |
|----------|----------|----------------|----------|----------|
| 主題色 | `@AppStorage("selectedTheme")` | `preferences.selectedTheme` | ThemeManager setter | `downloadUserPreferences()` |
| 刷新間隔 | `@AppStorage("refreshInterval")` | `preferences.refreshInterval` | SettingsView `.onChange` | 同上 |
| 隱藏已送達 | `@AppStorage("hideDeliveredPackages")` | `preferences.hideDeliveredPackages` | SettingsView `.onChange` | 同上 |

---

## 5. FCM 推播 Token（僅上傳，裝置專屬）

**Firestore 路徑**：`/users/{uid}/fcmTokens/{deviceId}`

| 資料欄位 | Firestore 欄位 | 上傳時機 | 備註 |
|----------|----------------|----------|------|
| FCM Token | `fcmTokens.{deviceId}.token` | 登入/冷啟動時 | deviceId = `UIDevice.identifierForVendor` |
| 最後活躍 | `fcmTokens.{deviceId}.lastActive` | 同上（server timestamp） | |
| 清除 Token | 刪除 `fcmTokens.{deviceId}` | 登出時 | 只刪當前裝置 |

**多裝置支援**：
- 每台裝置以 `deviceId` 為 key 寫入自己的 token
- Cloud Functions 使用 `sendEachForMulticast` 發送到所有裝置
- 失效的 token 會自動清理
- 向下相容舊格式單一 `fcmToken` 欄位

---

## 6. 帳號資料（僅寫入 / 建立一次）

**Firestore 路徑**：`/users/{uid}`

| 資料欄位 | Firestore 欄位 | 寫入時機 | 備註 |
|----------|----------------|----------|------|
| Apple ID | `appleId` | 首次登入 | 不會下載回來 |
| Email | `email` | 首次登入 | 不會下載回來 |
| 建立時間 | `createdAt` | 首次登入 | server timestamp |
| 最後活躍 | `lastActive` | 每次登入/token 上傳 | server timestamp |
| 語系 | `language` | 登入時偵測 | Cloud Functions 用於多語系推播 |
| 暱稱 | `nickname` | 使用者在設定中修改 | 從 Firestore 讀取顯示 |

---

## 同步流程時序

### 冷啟動（SplashView）

```
1. 註冊 FCM 推播（背景）
2. downloadUserPreferences()    ← 訂閱層級、通知設定、主題、偏好
3. downloadAllPackages()        ← 從 Firestore 下載包裹
4. API 刷新活躍包裹             ← Track.TW API
5. startListening()             ← 啟動即時監聽器
6. uploadMissingPackages()      ← 補傳遺漏包裹（背景）
7. 進入主畫面
```

### 首次登入（SignInView）

```
1. Apple Sign In → Firebase Auth
2. createUserProfileIfNeeded()  ← 建立/更新 Firestore 用戶資料
3. downloadUserPreferences()    ← 同上
4. downloadAllPackages()        ← 同上
5. API 刷新
6. startListening()
7. uploadMissingPackages()（背景）
8. registerForPushNotifications() ← FCM token 上傳
9. 進入主畫面
```

### 登出

```
1. clearToken()                 ← 清除當前裝置的 FCM token
2. stopListening()              ← 停止即時監聽器
3. Auth.signOut()               ← Firebase 登出
4. 返回登入畫面
```

---

## Firestore 完整文件結構

```
/users/{uid}
  ├── appleId: string
  ├── email: string
  ├── createdAt: Timestamp
  ├── lastActive: Timestamp
  ├── language: string                    ("zh-Hant" | "zh-Hans" | "en")
  ├── nickname: string
  ├── subscriptionTier: string            ("free" | "pro")
  ├── subscriptionProductID: string       ("monthly" | "yearly" | "lifetime" 的產品 ID)
  ├── notificationSettings: map
  │     ├── enabled: boolean
  │     ├── arrivalNotification: boolean
  │     ├── shippedNotification: boolean
  │     └── pickupReminder: boolean
  ├── preferences: map
  │     ├── selectedTheme: string
  │     ├── refreshInterval: string
  │     └── hideDeliveredPackages: boolean
  ├── fcmTokens: map                      ← 多裝置 FCM token
  │     └── {deviceId}: map
  │           ├── token: string
  │           └── lastActive: Timestamp
  └── /packages/{packageId}
        ├── trackingNumber: string
        ├── carrier: string
        ├── status: string
        ├── customName: string?
        ├── pickupCode: string?
        ├── pickupLocation: string?
        ├── userPickupLocation: string?
        ├── storeName: string?
        ├── latestDescription: string?
        ├── serviceType: string?
        ├── pickupDeadline: Timestamp?
        ├── paymentMethod: string?
        ├── amount: double?
        ├── purchasePlatform: string?
        ├── notes: string?
        ├── isArchived: boolean
        ├── trackTwRelationId: string?
        ├── createdAt: Timestamp
        ├── lastUpdated: Timestamp
        ├── isDeleted: boolean?           ← 軟刪除
        ├── deletedAt: Timestamp?
        ├── lastNotifiedStatus: string?   ← 防止重複推播
        └── /events/{eventId}
              ├── timestamp: Timestamp
              ├── status: string
              ├── description: string
              └── location: string?
```
